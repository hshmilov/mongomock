<template>
  <div
    class="x-pie"
    :class="{disabled: readOnly}"
  >
    <svg
      viewBox="-1 -1 2 2"
      @mouseout="inHover = -1"
    >
      <defs>
        <linearGradient id="intersection-2-4">
          <stop
            class="pie-stop-2"
            offset="0%"
          />
          <template v-for="n in 9">
            <stop
              :class="`pie-stop-${!(n % 2) ? 4 : 2}`"
              :offset="`${n}0%`"
            />
            <stop
              :class="`pie-stop-${!(n % 2) ? 2 : 4}`"
              :offset="`${n}0%`"
            />
          </template>
          <stop
            class="pie-stop-4"
            offset="100%"
          />
        </linearGradient>
      </defs>
      <g
        v-for="(slice, index) in slices"
        :key="index"
        :class="`slice-${index}`"
        @click="onClick(index)"
        @mouseover="onHover($event, index)"
      >
        <path
          :d="slice.path"
          :class="`filling ${slice.class} ${inHover === index? 'in-hover' : ''}`"
        />
        <text
          v-if="showPercentageText(slice.value)"
          class="scaling"
          text-anchor="middle"
          :x="slice.middle.x"
          :y="slice.middle.y"
        >
          {{ Math.round(slice.value * 100) }}%
        </text>
      </g>
    </svg>
    <XTooltip
      v-show="hoverDetails.title"
      ref="tooltip"
    >
      <template slot="body">
        <div class="tooltip-content">
          <div class="tooltip-legend">
            <div
              class="legend"
              :class="hoverDetails.class"
            />{{ hoverDetails.title }}</div>
          <div>{{ hoverDetails.percentage }}%</div>
        </div>
        <div
          v-for="component in hoverDetails.components"
          :key="component.name"
          class="tooltip-content"
        >
          <div class="tooltip-legend">
            <div
              class="legend round"
              :class="component.class"
            />{{ component.name }}</div>
        </div>
      </template>
    </XTooltip>
  </div>
</template>

<script>
import XTooltip from '../popover/Tooltip.vue';

export default {
  name: 'XPie',
  components: {
    XTooltip,
  },
  props: {
    data: {
      type: Array,
      required: true,
    },
    forceText: {
      type: Boolean,
      default: false,
    },
    readOnly: {
      type: Boolean,
      default: false,
    },
  },
  data() {
    return {
      inHover: -1,
    };
  },
  computed: {
    processedData() {
      return this.data.map((item, index) => {
        if (this.data.length === 2 && index === 1) {
          return { class: `indicator-fill-${Math.ceil(item.value * 4)}`, ...item };
        }
        const modIndex = (index % 10) + 1;
        if (item.intersection) {
          return { class: `fill-intersection-${modIndex - 1}-${modIndex + 1}`, ...item };
        }
        return { class: `pie-fill-${modIndex}`, ...item };
      });
    },
    slices() {
      let cumulativePortion = 0;
      return this.processedData.map((slice) => {
        // Starting slice at the end of previous one, and ending after percentage defined for item
        const [startX, startY] = this.getCoordinatesForPercent(cumulativePortion);
        cumulativePortion += slice.value / 2;
        const [middleX, middleY] = this.getCoordinatesForPercent(cumulativePortion);
        cumulativePortion += slice.value / 2;
        const [endX, endY] = this.getCoordinatesForPercent(cumulativePortion);
        return {
          ...slice,
          path: [
            `M ${startX} ${startY}`, // Move
            `A 1 1 0 ${slice.value > 0.5 ? 1 : 0} 1 ${endX} ${endY}`, // Arc
            'L 0 0', // Line
          ].join(' '),
          middle: { x: middleX * 0.7, y: middleY * (middleY > 0 ? 0.8 : 0.5) },
        };
      });
    },
    hoverDetails() {
      if (!this.data || this.data.length === 0 || this.inHover === -1) {
        return {};
      }
      const {
        value, name, remainder, intersection, class: dataClass,
      } = this.processedData[this.inHover];
      let percentage = Math.round(value * 100);
      if (percentage < 0) {
        percentage = 100 + percentage;
      }
      let title = name;
      let components = [];
      if (intersection) {
        title = 'Intersection';
        components.push({ ...this.processedData[this.inHover - 1] });
        components.push({ ...this.processedData[this.inHover + 1] });
      }
      if (this.inHover === 0 && remainder) {
        title = 'Excluding';
        components = this.processedData.filter((data) => !data.intersection && !data.remainder);
      }
      return {
        parentTitle: this.data[0].name,
        title,
        percentage,
        class: dataClass,
        components,
      };
    },
  },
  methods: {
    getCoordinatesForPercent(portion) {
      return [Math.cos(2 * Math.PI * portion), Math.sin(2 * Math.PI * portion)];
    },
    onHover(event, index) {
      this.inHover = index;
      if (!this.$refs.tooltip || !this.$refs.tooltip.$el) return;
      this.$refs.tooltip.$el.style.top = `${event.clientY + 10}px`;
      this.$refs.tooltip.$el.style.left = `${event.clientX + 10}px`;
    },
    showPercentageText(val) {
      return (this.forceText && val > 0) || val > 0.04;
    },
    onClick(index) {
      if (this.readOnly) return;
      this.$emit('click-one', index);
    },
  },
};
</script>

<style lang="scss">
    .x-pie {
        margin: auto;
        width: 240px;
        position: relative;
        .fill-intersection-2-4 {
            fill: url(#intersection-2-4);
            background: repeating-linear-gradient(45deg, nth($pie-colours, 2),
                    nth($pie-colours, 2) 4px, nth($pie-colours, 4) 4px, nth($pie-colours, 4) 8px);
        }

        g {
            cursor: pointer;

            path {
                opacity: 0.8;
                transition: opacity ease-in 0.4s;

                &.in-hover {
                    opacity: 1;
                }
            }

            text {
                font-size: 1%;
                fill: $theme-black;
            }
        }

        &.disabled g {
            cursor: default;
        }

      .x-tooltip {
        position: fixed;
        .tooltip-content {
          display: flex;
          .tooltip-legend {
            margin-right: 12px;
            flex: 1 0 auto;
            max-width: 200px;

            .legend {
              display: inline-block;
              height: 16px;
              width: 16px;
              border-radius: 4px;
              margin-right: 4px;
              vertical-align: middle;

              &.round {
                border-radius: 100%;
                width: 8px;
                height: 8px;
              }
            }
          }
        }

      }
    }


</style>
