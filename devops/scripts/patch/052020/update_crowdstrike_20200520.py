#!/home/ubuntu/cortex/venv/bin/python

import sys
import subprocess
import base64
import os
import time

from testing.services.plugins import core_service

CORTEX = '/home/ubuntu/cortex'
FILES_TO_UPDATE = {
    f'{CORTEX}/adapters/crowd_strike_adapter/connection.py': b'aW1wb3J0IGxvZ2dpbmcKaW1wb3J0IHRpbWUKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUsIHRpbWVkZWx0YQpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgTGlzdCwgT3B0aW9uYWwKZnJvbSBmdW5jeSBpbXBvcnQgY2h1bmtzCgpmcm9tIGF4b25pdXMuY2xpZW50cy5yZXN0LmNvbm5lY3Rpb24gaW1wb3J0IFJFU1RDb25uZWN0aW9uCmZyb20gYXhvbml1cy5jbGllbnRzLnJlc3QuZXhjZXB0aW9uIGltcG9ydCBSRVNURXhjZXB0aW9uLCBSRVNUUmVxdWVzdEV4Y2VwdGlvbgpmcm9tIGNyb3dkX3N0cmlrZV9hZGFwdGVyIGltcG9ydCBjb25zdHMKCmxvZ2dlciA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKGYnYXhvbml1cy57X19uYW1lX199JykKCiMgWFhYOiBGb3Igc29tZSByZWFzb24gdGhpcyBmaWxlIGRvZXNuJ3QgaWdub3JlIGxvZ2dpbmctZnN0cmluZy1pbnRlcnBvbGF0aW9uCiMgYWx0aG91Z2ggd2UgZ290IGl0IGluIHB5bGludHJjIGlnbm9yZS4gYWRkIGRpc2FibGUgZm9yIGl0LCBhbmQgZGlzYWJsZSB0aGUgZGlzYWJsZSB3YXJuaW5nCiMgcHlsaW50OiBkaXNhYmxlPUkwMDIxCiMgcHlsaW50OiBkaXNhYmxlPVcxMjAzCiMgYXBpIGRvYzogaHR0cHM6Ly9hc3NldHMuZmFsY29uLmNyb3dkc3RyaWtlLmNvbS9zdXBwb3J0L2FwaS9zd2FnZ2VyLmh0bWwKClBvbGljaWVzVHlwZSA9IERpY3Rbc3RyLCBMaXN0XQpNQVhfUEFHRVNfUFJPVEVDVElPTiA9IDEwMDAwMDAKCgpjbGFzcyBDcm93ZFN0cmlrZUNvbm5lY3Rpb24oUkVTVENvbm5lY3Rpb24pOgogICAgZGVmIF9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygqYXJncywgKiprd2FyZ3MsIGhlYWRlcnM9eydBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbid9KQogICAgICAgIHNlbGYubGFzdF90b2tlbl9mZXRjaCA9IE5vbmUKICAgICAgICBzZWxmLnJlcXVlc3RzX2NvdW50ID0gMAoKICAgIGRlZiByZWZyZXNoX2FjY2Vzc190b2tlbihzZWxmLCBmb3JjZT1GYWxzZSk6CiAgICAgICAgaWYgbm90IHNlbGYubGFzdF90b2tlbl9mZXRjaCBvciAoc2VsZi5sYXN0X3Rva2VuX2ZldGNoICsgdGltZWRlbHRhKG1pbnV0ZXM9MjApIDwgZGF0ZXRpbWUubm93KCkpIG9yIGZvcmNlOgogICAgICAgICAgICBsb2dnZXIuZGVidWcoZidSZWZyZXNoaW5nIGFjY2VzcyB0b2tlbiBhZnRlciB7c2VsZi5yZXF1ZXN0c19jb3VudH0gcmVxdWVzdHMnKQogICAgICAgICAgICByZXNwb25zZSA9IHNlbGYuX3Bvc3QoJ29hdXRoMi90b2tlbicsIHVzZV9qc29uX2luX2JvZHk9RmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2R5X3BhcmFtcz17J2NsaWVudF9pZCc6IHNlbGYuX3VzZXJuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjbGllbnRfc2VjcmV0Jzogc2VsZi5fcGFzc3dvcmR9KQogICAgICAgICAgICB0b2tlbiA9IHJlc3BvbnNlWydhY2Nlc3NfdG9rZW4nXQogICAgICAgICAgICBzZWxmLl9zZXNzaW9uX2hlYWRlcnNbJ0F1dGhvcml6YXRpb24nXSA9IGYnQmVhcmVyIHt0b2tlbn0nCiAgICAgICAgICAgIHNlbGYubGFzdF90b2tlbl9mZXRjaCA9IGRhdGV0aW1lLm5vdygpCiAgICAgICAgICAgIHNlbGYucmVxdWVzdHNfY291bnQgPSAwCgogICAgZGVmIF9jb25uZWN0KHNlbGYpOgogICAgICAgIGlmIG5vdCBzZWxmLl91c2VybmFtZSBvciBub3Qgc2VsZi5fcGFzc3dvcmQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJhaXNlIFJFU1RFeGNlcHRpb24oJ05vIHVzZXIgbmFtZSBvciBBUEkga2V5JykKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYucmVmcmVzaF9hY2Nlc3NfdG9rZW4oZm9yY2U9VHJ1ZSkgICMganVzdCB0cnkKICAgICAgICAgICAgc2VsZi5fZ290X3Rva2VuID0gVHJ1ZQogICAgICAgICAgICBsb2dnZXIuaW5mbygnb2F1dGggc3VjY2VzcycpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbignT2F1dGggZmFpbGVkJykKICAgICAgICAgICAgc2VsZi5fZ290X3Rva2VuID0gRmFsc2UKICAgICAgICBzZWxmLl9nZXQoJ2RldmljZXMvcXVlcmllcy9kZXZpY2VzL3YxJywKICAgICAgICAgICAgICAgICAgZG9fYmFzaWNfYXV0aD1ub3Qgc2VsZi5fZ290X3Rva2VuLAogICAgICAgICAgICAgICAgICB1cmxfcGFyYW1zPXsnbGltaXQnOiBjb25zdHMuREVWSUNFU19QRVJfUEFHRSwgJ29mZnNldCc6IDB9KQoKICAgIGRlZiBfX2dldChzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgICAgICIiIgogICAgICAgIENhbGxzIF9nZXQgYnV0IHRyaWVzIGEgY291cGxlIG9mIHRpbWVzLgogICAgICAgIDpwYXJhbSBhcmdzOiBhcmdzCiAgICAgICAgOnBhcmFtIGt3YXJnczoga3dhcmdzCiAgICAgICAgOnJldHVybjoKICAgICAgICAiIiIKICAgICAgICByZXRyaWVzID0gMAogICAgICAgIHdoaWxlIHJldHJpZXMgPCBjb25zdHMuUkVRVUVTVF9SRVRSSUVTOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5fZ2V0KCphcmdzLCAqKmt3YXJncykKICAgICAgICAgICAgZXhjZXB0IFJFU1RSZXF1ZXN0RXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKGNvbnN0cy5SRVRSSUVTX1NMRUVQX1RJTUUpCiAgICAgICAgICAgICAgICBzZWxmLnJlZnJlc2hfYWNjZXNzX3Rva2VuKCkKICAgICAgICAgICAgICAgIHJldHJpZXMgKz0gMQogICAgICAgICAgICAgICAgaWYgcmV0cmllcyA+PSBjb25zdHMuUkVRVUVTVF9SRVRSSUVTOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmJ0Vycm9yIGdldHRpbmcgVVJMIGFmdGVyIHtjb25zdHMuUkVRVUVTVF9SRVRSSUVTfSByZXRyaWVzIHdpdGggYXJncyB7c3RyKGFyZ3MpfScpCiAgICAgICAgICAgICAgICAgICAgcmFpc2UgZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfYWRkX3BvbGljeShwb2xpY2llczogUG9saWNpZXNUeXBlLCBkZXZpY2U6IGRpY3QsIHBvbGljeTogZGljdCk6CiAgICAgICAgIiIiCiAgICAgICAgQWRkIGRldmljZSB0byBhIGxpc3QgaW4gdGhlIHBvbGljaWVzIGRpY3Rpb25hcnkKICAgICAgICA6cGFyYW0gcG9saWNpZXM6IHBvbGljaWVzIGRpY3Rpb25hcnkKICAgICAgICA6cGFyYW0gZGV2aWNlOiBkZXZpY2UgZGF0YQogICAgICAgIDpwYXJhbSBwb2xpY3k6IHBvbGljeSBkYXRhCiAgICAgICAgOnJldHVybjogTm9uZQogICAgICAgICIiIgogICAgICAgIGlmIG5vdCBwb2xpY3k6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHBvbGljeV9pZCA9IHBvbGljeS5nZXQoJ3BvbGljeV9pZCcpCiAgICAgICAgaWYgcG9saWN5X2lkOgogICAgICAgICAgICBwb2xpY2llcy5zZXRkZWZhdWx0KHBvbGljeV9pZCwgW10pLmFwcGVuZChkZXZpY2UpCgogICAgZGVmIGdldF9wb2xpY2llcyhzZWxmLCBwb2xpY2llczogUG9saWNpZXNUeXBlLCBwX3R5cGU6IGNvbnN0cy5Qb2xpY3lUeXBlcyk6CiAgICAgICAgIiIiCiAgICAgICAgR2V0IFBvbGljaWVzIGRhdGEgZnJvbSBjcm93ZHN0cmlrZSBhcGkgYW5kIGZpbGwgcG9saWN5IGRhdGEgZm9yIGVhY2ggZGV2aWNlCiAgICAgICAgOnBhcmFtIHBvbGljaWVzOiBwb2xpY2llcyBkaWN0aW9uYXJ5OiB7cG9saWN5X2lkOltsaXN0X29mX2RldmljZXNfdGhhdF9vd25fdGhpc19wb2xpY3kuLl19CiAgICAgICAgOnBhcmFtIHBfdHlwZTogcG9saWN5IHR5cGUgLSB1c3VhbGx5IHByZXZlbnRpb24gb3Igc2Vuc29yX3VwZGF0ZQogICAgICAgIDpyZXR1cm46IE5vbmUKICAgICAgICAiIiIKICAgICAgICBpZiBub3QgcG9saWNpZXM6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHBvbGljaWVzX2lkcyA9IHBvbGljaWVzLmtleXMoKQogICAgICAgIHJlcV90eXBlID0gcF90eXBlLnJlcGxhY2VfdG9fZGFzaCgpCiAgICAgICAgcG9saWNpZXNfZGF0YSA9IHNlbGYuX19nZXQoZidwb2xpY3kvZW50aXRpZXMve3JlcV90eXBlfS92MScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsX3BhcmFtcz17J2lkcyc6IHBvbGljaWVzX2lkc30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9fYmFzaWNfYXV0aD1ub3Qgc2VsZi5fZ290X3Rva2VuKQogICAgICAgIGxvZ2dlci5kZWJ1ZyhmJ0dvdCB7bGVuKHBvbGljaWVzX2RhdGEpfSBwb2xpY2llcycpCiAgICAgICAgcmVzb3VyY2VzID0gcG9saWNpZXNfZGF0YS5nZXQoJ3Jlc291cmNlcycpCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UocmVzb3VyY2VzLCBsaXN0KToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYnRXJyb3IgZ2V0dGluZyBwb2xpY2llcyBkYXRhIGZvciB7cG9saWNpZXNfaWRzfScpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZvciByZXNvdXJjZSBpbiByZXNvdXJjZXM6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHBvbGljeV9pZCA9IHJlc291cmNlLmdldCgnaWQnLCBOb25lKQogICAgICAgICAgICAgICAgZGV2aWNlcyA9IHBvbGljaWVzLnBvcChwb2xpY3lfaWQpCiAgICAgICAgICAgICAgICBmb3IgZGV2aWNlIGluIGRldmljZXM6CiAgICAgICAgICAgICAgICAgICAgZGV2aWNlWydkZXZpY2VfcG9saWNpZXMnXVtwX3R5cGUudmFsdWVdWydkYXRhJ10gPSByZXNvdXJjZQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbignRXJyb3IgZ2V0dGluZyBwb2xpY3kgcmVzb3VyY2UnKQogICAgICAgIGlmIGxlbihwb2xpY2llcykgPiAwOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZidFcnJvciBnZXR0aW5nIHBvbGljaWVzOiB7cG9saWNpZXMua2V5cygpfScpCiAgICAgICAgcG9saWNpZXMuY2xlYXIoKQoKICAgIGRlZiBnZXRfZGV2aWNlc19wb2xpY2llcyhzZWxmLCBkZXZpY2VzX2RhdGE6IGRpY3QpOgogICAgICAgICIiIgogICAgICAgIEdldCBhbGwgdGhlIHBvbGljaWVzIGRhdGEgZm9yIHRoZSBnaXZlbiBkZXZpY2VzLgogICAgICAgIFVzdWFsbHkgYSBsb3Qgb2YgZGV2aWNlcyBzaGFyZSB0aGUgc2FtZSBwb2xpY2llcyBhbmQgd2UgZG9udCB3YW50IHRvIHNwYW0gdGhlIHNlcnZlciB3aXRoIHVubmVjZXNzYXJ5IHJlcXVlc3RzLAogICAgICAgIFNvIHdlIHdpbGwgc2F2ZSBhbGwgdGhlIHBvbGljaWVzIGlkcyBpbiBhIFBvbGljaWVzVHlwZSBkaWN0IGFuZCBmZXRjaCBwb2xpY2llcyBkYXRhIGFmdGVyIGVhY2ggY2h1bmsgb2YgZGV2aWNlcy4KICAgICAgICA6cGFyYW0gZGV2aWNlc19kYXRhOgogICAgICAgIDpyZXR1cm46IE5vbmUKICAgICAgICAiIiIKICAgICAgICAjIHRoZXNlIGRpY3RzIHdpbGwgaG9sZCBhbGwgdGhlIHBvbGljaWVzIGFuZCB0aGVpciBkZXZpY2VzCiAgICAgICAgcHJldmVudGlvbl9wb2xpY2llcyA9IHt9CiAgICAgICAgc2Vuc29yX3VwZGF0ZV9wb2xpY2llcyA9IHt9CiAgICAgICAgZm9yIGRldmljZSBpbiBkZXZpY2VzX2RhdGE6CiAgICAgICAgICAgIHBvbGljaWVzID0gZGV2aWNlLmdldCgnZGV2aWNlX3BvbGljaWVzJykKICAgICAgICAgICAgaWYgcG9saWNpZXMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBwcmV2ZW50aW9uID0gcG9saWNpZXMuZ2V0KGNvbnN0cy5Qb2xpY3lUeXBlcy5QcmV2ZW50aW9uLnZhbHVlKQogICAgICAgICAgICAgICAgc2Vuc29yX3VwZGF0ZSA9IHBvbGljaWVzLmdldChjb25zdHMuUG9saWN5VHlwZXMuU2Vuc29yVXBkYXRlLnZhbHVlKQogICAgICAgICAgICAgICAgIyBhZGQgZGV2aWNlIHBvbGljaWVzIGlkcyB0byB0aGUgcG9saWNpZXMgZGljdGlvbmFyeQogICAgICAgICAgICAgICAgc2VsZi5fYWRkX3BvbGljeShwcmV2ZW50aW9uX3BvbGljaWVzLCBkZXZpY2UsIHByZXZlbnRpb24pCiAgICAgICAgICAgICAgICBzZWxmLl9hZGRfcG9saWN5KHNlbnNvcl91cGRhdGVfcG9saWNpZXMsIGRldmljZSwgc2Vuc29yX3VwZGF0ZSkKICAgICAgICAgICAgIyBpZiB3ZSBoYXZlIHJlYWNoZWQgdGhlIG1heCBwb2xpY2llcyBsZW5ndGggbGV0cyBnZXQgdGhlaXIgZGF0YQogICAgICAgICAgICBpZiBsZW4ocHJldmVudGlvbl9wb2xpY2llcykgPT0gY29uc3RzLk1BWF9QT0xJQ0lFU19MRU5HVEg6CiAgICAgICAgICAgICAgICBzZWxmLmdldF9wb2xpY2llcyhwcmV2ZW50aW9uX3BvbGljaWVzLCBjb25zdHMuUG9saWN5VHlwZXMuUHJldmVudGlvbikKICAgICAgICAgICAgaWYgbGVuKHByZXZlbnRpb25fcG9saWNpZXMpID09IGNvbnN0cy5NQVhfUE9MSUNJRVNfTEVOR1RIOgogICAgICAgICAgICAgICAgc2VsZi5nZXRfcG9saWNpZXMocHJldmVudGlvbl9wb2xpY2llcywgY29uc3RzLlBvbGljeVR5cGVzLlNlbnNvclVwZGF0ZSkKCiAgICAgICAgc2VsZi5nZXRfcG9saWNpZXMocHJldmVudGlvbl9wb2xpY2llcywgY29uc3RzLlBvbGljeVR5cGVzLlByZXZlbnRpb24pCiAgICAgICAgc2VsZi5nZXRfcG9saWNpZXMoc2Vuc29yX3VwZGF0ZV9wb2xpY2llcywgY29uc3RzLlBvbGljeVR5cGVzLlNlbnNvclVwZGF0ZSkKCiAgICBkZWYgZ2V0X2RldmljZXNfZ3JvdXBzKHNlbGYsIGRldmljZXNfZGF0YTogZGljdCk6CiAgICAgICAgIiIiCiAgICAgICAgR2V0IGRldmljZXMgZ3JvdXBzIGRhdGEgZnJvbSB0aGUgYXBpCiAgICAgICAgOnBhcmFtIGRldmljZXNfZGF0YTogZGV2aWNlIGRhdGEKICAgICAgICA6cmV0dXJuOiBOb25lCiAgICAgICAgIiIiCiAgICAgICAgZ3JvdXBzID0ge30KICAgICAgICBmb3IgZGV2aWNlIGluIGRldmljZXNfZGF0YToKICAgICAgICAgICAgZGV2aWNlX2dyb3VwcyA9IGRldmljZS5nZXQoJ2dyb3VwcycsIFtdKQogICAgICAgICAgICBmb3IgZ3JvdXBfaWQgaW4gZGV2aWNlX2dyb3VwczoKICAgICAgICAgICAgICAgIGdyb3Vwcy5zZXRkZWZhdWx0KGdyb3VwX2lkLCBbXSkuYXBwZW5kKGRldmljZSkKICAgICAgICBpZiBub3QgZ3JvdXBzOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBncm91cF9pZHMgPSBncm91cHMua2V5cygpCiAgICAgICAgZm9yIGNodW5rIGluIGNodW5rcyhjb25zdHMuTUFYX0dST1VQU19QRVJfUkVRVUVTVCwgZ3JvdXBfaWRzKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZ3JvdXBzX3JlcyA9IHNlbGYuX19nZXQoZidkZXZpY2VzL2VudGl0aWVzL2hvc3QtZ3JvdXBzL3YxJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybF9wYXJhbXM9eydpZHMnOiBjaHVua30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb19iYXNpY19hdXRoPW5vdCBzZWxmLl9nb3RfdG9rZW4pCiAgICAgICAgICAgICAgICBncm91cHNfZGF0YSA9IGdyb3Vwc19yZXMuZ2V0KCdyZXNvdXJjZXMnLCBbXSkKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmJ0dvdCB7bGVuKGdyb3Vwc19kYXRhKX0gZ3JvdXBzJykKICAgICAgICAgICAgICAgIGZvciBncm91cF9kYXRhIGluIGdyb3Vwc19kYXRhOgogICAgICAgICAgICAgICAgICAgIGdyb3VwX2lkID0gZ3JvdXBfZGF0YS5nZXQoJ2lkJykKICAgICAgICAgICAgICAgICAgICBpZiBncm91cF9pZDoKICAgICAgICAgICAgICAgICAgICAgICAgZGV2aWNlcyA9IGdyb3Vwcy5nZXQoZ3JvdXBfaWQpCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBkZXZpY2UgaW4gZGV2aWNlczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRldmljZS5zZXRkZWZhdWx0KCdncm91cHNfZGF0YScsIFtdKS5hcHBlbmQoZ3JvdXBfZGF0YSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgZ2V0dGluZyBkZXZpY2UgZ3JvdXBzJykKCiAgICBkZWYgZ2V0X3Z1bG5lcmFiaWxpdGllc19kYXRhKHNlbGYsIGRldmljZV9kYXRhOiBkaWN0LCB2dWxuZXJhYmlsaXRpZXNfaWRzOiBMaXN0W3N0cl0pIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgR2V0IHZ1bG5lcmFiaWxpdGllcyBkYXRhIGJ5IHZ1bG5lcmFiaWxpdGllcyBpZHMKICAgICAgICA6cGFyYW0gZGV2aWNlX2RhdGE6CiAgICAgICAgOnBhcmFtIHZ1bG5lcmFiaWxpdGllc19pZHM6CiAgICAgICAgOnJldHVybjoKICAgICAgICAiIiIKICAgICAgICBkZXZpY2VfaWQgPSBkZXZpY2VfZGF0YS5nZXQoJ2RldmljZV9pZCcpCiAgICAgICAgZm9yIGNodW5rIGluIGNodW5rcyhjb25zdHMuTUFYX1ZVTFNfUEVSX1JFUVVFU1QsIHZ1bG5lcmFiaWxpdGllc19pZHMpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB2dWxfcmVzID0gc2VsZi5fX2dldChmJ3Nwb3RsaWdodC9lbnRpdGllcy92dWxuZXJhYmlsaXRpZXMvdjInLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsX3BhcmFtcz17J2lkcyc6IGNodW5rfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvX2Jhc2ljX2F1dGg9bm90IHNlbGYuX2dvdF90b2tlbikKICAgICAgICAgICAgICAgIHZ1bF9kYXRhID0gdnVsX3Jlcy5nZXQoJ3Jlc291cmNlcycsIFtdKQogICAgICAgICAgICAgICAgZGV2aWNlX2RhdGEuc2V0ZGVmYXVsdCgndnVsbmVyYWJpbGl0aWVzJywgW10pLmV4dGVuZCh2dWxfZGF0YSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmJ0Vycm9yIGdldHRpbmcgZGV2aWNlIHZ1bG5lcmFiaWxpdGllcyBmb3Ige2RldmljZV9pZH0nKQoKICAgIGRlZiBnZXRfZGV2aWNlX3Z1bG5lcmFiaWxpdGllcyhzZWxmLCBkZXZpY2VfZGF0YTogZGljdCkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICBHZXQgZGV2aWNlIHZ1bG5lcmFiaWxpdGllcyBkYXRhIGZyb20gZmFsY29uIHNwb3RsaWdodCBhcGkKICAgICAgICA6cGFyYW0gZGV2aWNlX2RhdGE6IGRldmljZSBkYXRhCiAgICAgICAgOnJldHVybjogTm9uZQogICAgICAgICIiIgogICAgICAgIGRldmljZV9pZCA9IGRldmljZV9kYXRhLmdldCgnZGV2aWNlX2lkJykKICAgICAgICAjIGZpcnN0IHJlcXVlc3QgZm9yIGdldHRpbmcgbWV0YSBkYXRhIHdpdGggdnVsbmVyYWJpbGl0aWVzIGRhdGEKICAgICAgICBkZXZpY2VfdnVsbmVyYWJpbGl0aWVzID0gc2VsZi5fX2dldChmJ3Nwb3RsaWdodC9xdWVyaWVzL3Z1bG5lcmFiaWxpdGllcy92MScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsX3BhcmFtcz17J2ZpbHRlcic6IGYnYWlkOlwne2RldmljZV9pZH1cJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xpbWl0JzogY29uc3RzLlZVTFNfUEVSX1JFUVVFU1R9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvX2Jhc2ljX2F1dGg9bm90IHNlbGYuX2dvdF90b2tlbikKICAgICAgICB2dWxuZXJhYmlsaXRpZXNfaWRzID0gZGV2aWNlX3Z1bG5lcmFiaWxpdGllcy5nZXQoJ3Jlc291cmNlcycsIFtdKQogICAgICAgIHBhZ2luYXRpb24gPSBkZXZpY2VfdnVsbmVyYWJpbGl0aWVzLmdldCgnbWV0YScsIHt9KS5nZXQoJ3BhZ2luYXRpb24nLCB7fSkKICAgICAgICB0b3RhbF92dWxucyA9IHBhZ2luYXRpb24uZ2V0KCd0b3RhbCcpCiAgICAgICAgbmV4dF9wYWdlID0gcGFnaW5hdGlvbi5nZXQoJ2FmdGVyJykKICAgICAgICB2dWxuc19nb3QgPSBsZW4odnVsbmVyYWJpbGl0aWVzX2lkcykKICAgICAgICBzZWxmLmdldF92dWxuZXJhYmlsaXRpZXNfZGF0YShkZXZpY2VfZGF0YSwgdnVsbmVyYWJpbGl0aWVzX2lkcykKICAgICAgICBsb2dnZXIuZGVidWcoZidHb3Qge3Z1bG5zX2dvdH0ve3RvdGFsX3Z1bG5zfSB2dWxuZXJhYmlsaXRpZXMgZm9yIHtkZXZpY2VfaWR9JykKCiAgICAgICAgd2hpbGUgbmV4dF9wYWdlOgogICAgICAgICAgICBkZXZpY2VfdnVsbmVyYWJpbGl0aWVzID0gc2VsZi5fX2dldChmJ3Nwb3RsaWdodC9xdWVyaWVzL3Z1bG5lcmFiaWxpdGllcy92MScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybF9wYXJhbXM9eydmaWx0ZXInOiBmJ2FpZDpcJ3tkZXZpY2VfaWR9XCcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYWZ0ZXInOiBuZXh0X3BhZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsaW1pdCc6IGNvbnN0cy5WVUxTX1BFUl9SRVFVRVNUfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9fYmFzaWNfYXV0aD1ub3Qgc2VsZi5fZ290X3Rva2VuKQogICAgICAgICAgICB2dWxuZXJhYmlsaXRpZXNfaWRzID0gZGV2aWNlX3Z1bG5lcmFiaWxpdGllcy5nZXQoJ3Jlc291cmNlcycsIFtdKQogICAgICAgICAgICBwYWdpbmF0aW9uID0gZGV2aWNlX3Z1bG5lcmFiaWxpdGllcy5nZXQoJ21ldGEnLCB7fSkuZ2V0KCdwYWdpbmF0aW9uJywge30pCiAgICAgICAgICAgIG5leHRfcGFnZSA9IHBhZ2luYXRpb24uZ2V0KCdhZnRlcicpCiAgICAgICAgICAgIHZ1bG5zX2dvdCArPSBsZW4odnVsbmVyYWJpbGl0aWVzX2lkcykKICAgICAgICAgICAgc2VsZi5nZXRfdnVsbmVyYWJpbGl0aWVzX2RhdGEoZGV2aWNlX2RhdGEsIHZ1bG5lcmFiaWxpdGllc19pZHMpCiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmJ0dvdCB7dnVsbnNfZ290fS97dG90YWxfdnVsbnN9IHZ1bG5lcmFiaWxpdGllcyBmb3Ige2RldmljZV9pZH0nKQoKICAgIGRlZiBnZXRfZGV2aWNlc19kYXRhKHNlbGYsIGRldmljZXNfaWRzOiBMaXN0W3N0cl0sIHNob3VsZF9nZXRfcG9saWNpZXM6IGJvb2wsIHNob3VsZF9nZXRfdnVsbmVyYWJpbGl0aWVzOiBib29sKSAtPiBcCiAgICAgICAgICAgIExpc3RbRGljdF06CiAgICAgICAgIiIiCiAgICAgICAgR2V0IGRldmljZXMgZGF0YSBmcm9tIGNyb3dkc3RyaWtlIGFwaSBlbmRwb2ludDogZGV2aWNlcy9lbnRpdGllcy9kZXZpY2VzL3YxCiAgICAgICAgOnBhcmFtIHNob3VsZF9nZXRfcG9saWNpZXM6IGdldCBwb2xpY2llcyBkYXRhIGZvciBkZXZpY2VzCiAgICAgICAgOnBhcmFtIHNob3VsZF9nZXRfdnVsbmVyYWJpbGl0aWVzOiBnZXQgdnVsbmVyYWJpbGl0aWVzIGZyb20gc3BvdGxpZ2h0IGFwaQogICAgICAgIDpwYXJhbSBkZXZpY2VzX2lkczogZGV2aWNlcyBpZHMKICAgICAgICA6cmV0dXJuOiBsaXN0IG9mIGRldmljZXMKICAgICAgICAiIiIKICAgICAgICBpZiBsZW4oZGV2aWNlc19pZHMpID4gY29uc3RzLk1BWF9ERVZJQ0VTX1BFUl9QQUdFOgogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmJ1JlcXVlc3QgdG9vIG1hbnkgZGV2aWNlc19pZHM6IHtkZXZpY2VzX2lkc30sIG1heDoge2NvbnN0cy5NQVhfREVWSUNFU19QRVJfUEFHRX0nKQogICAgICAgIGRldmljZXMgPSBzZWxmLl9fZ2V0KCdkZXZpY2VzL2VudGl0aWVzL2RldmljZXMvdjEnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybF9wYXJhbXM9eydpZHMnOiBkZXZpY2VzX2lkc30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9fYmFzaWNfYXV0aD1ub3Qgc2VsZi5fZ290X3Rva2VuKQogICAgICAgIGRldmljZXNfZGF0YSA9IGRldmljZXMuZ2V0KCdyZXNvdXJjZXMnKQogICAgICAgIGlmIHNob3VsZF9nZXRfcG9saWNpZXM6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuZ2V0X2RldmljZXNfcG9saWNpZXMoZGV2aWNlc19kYXRhKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ0Vycm9yIGdldHRpbmcgZGV2aWNlcyBwb2xpY2llcycpCiAgICAgICAgaWYgc2hvdWxkX2dldF92dWxuZXJhYmlsaXRpZXM6CiAgICAgICAgICAgIGZvciBkZXZpY2VfZGF0YSBpbiBkZXZpY2VzX2RhdGE6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5nZXRfZGV2aWNlX3Z1bG5lcmFiaWxpdGllcyhkZXZpY2VfZGF0YSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgZGV2aWNlX2lkID0gZGV2aWNlX2RhdGEuZ2V0KCdkZXZpY2VfaWQnKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZidFcnJvciBnZXR0aW5nIGRldmljZSB2dWxuZXJhYmlsaXRpZXMuIGRldmljZV9pZDoge2RldmljZV9pZH0nKQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5nZXRfZGV2aWNlc19ncm91cHMoZGV2aWNlc19kYXRhKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZidFcnJvciBnZXR0aW5nIGRldmljZXMgZ3JvdXBzJykKICAgICAgICByZXR1cm4gZGV2aWNlcwoKICAgIGRlZiBnZXRfZGV2aWNlc19pZHMoc2VsZiwgb2Zmc2V0OiBpbnQsIGRldmljZXNfcGVyX3BhZ2U6IGludCwgcXVlcnk6IHN0ciA9IE5vbmUpIC0+IGRpY3Q6CiAgICAgICAgIiIiCiAgICAgICAgR2V0IGRldmljZXMgaWRzIGZyb20gY3Jvd2RzdHJpa2UgYXBpCiAgICAgICAgOnBhcmFtIG9mZnNldDogcGFnaW5nIG9mZnNldAogICAgICAgIDpwYXJhbSBkZXZpY2VzX3Blcl9wYWdlOiBkZXZpY2VzIHBlciBwYWdlCiAgICAgICAgOnJldHVybjoKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuZGVidWcoZidHZXR0aW5nIGRldmljZXMgb2Zmc2V0IHtvZmZzZXR9LCBkZXZpY2VzIHBlciBwYWdlOiB7ZGV2aWNlc19wZXJfcGFnZX0sIHF1ZXJ5OiB7c3RyKHF1ZXJ5KX0nKQogICAgICAgIHVybF9wYXJhbXMgPSB7J2xpbWl0JzogZGV2aWNlc19wZXJfcGFnZSwgJ29mZnNldCc6IG9mZnNldH0KICAgICAgICBpZiBxdWVyeToKICAgICAgICAgICAgdXJsX3BhcmFtc1snZmlsdGVyJ10gPSBxdWVyeQogICAgICAgIHJldHVybiBzZWxmLl9fZ2V0KCdkZXZpY2VzL3F1ZXJpZXMvZGV2aWNlcy92MScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsX3BhcmFtcz11cmxfcGFyYW1zLAogICAgICAgICAgICAgICAgICAgICAgICAgIGRvX2Jhc2ljX2F1dGg9bm90IHNlbGYuX2dvdF90b2tlbikKCiAgICBkZWYgZ2V0X2RldmljZXNfaWRzX3Njcm9sbChzZWxmLCBvZmZzZXQ6IE9wdGlvbmFsW3N0cl0sIGRldmljZXNfcGVyX3BhZ2U6IGludCwgcXVlcnk6IHN0ciA9IE5vbmUpIC0+IGRpY3Q6CiAgICAgICAgIiIiCiAgICAgICAgR2V0IGRldmljZXMgaWRzIGZyb20gY3Jvd2RzdHJpa2UgYXBpCiAgICAgICAgOnBhcmFtIG9mZnNldDogcGFnaW5nIG9mZnNldAogICAgICAgIDpwYXJhbSBkZXZpY2VzX3Blcl9wYWdlOiBkZXZpY2VzIHBlciBwYWdlCiAgICAgICAgOnJldHVybjoKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuZGVidWcoZidHZXR0aW5nIGRldmljZXMgb2Zmc2V0IHtvZmZzZXR9LCBkZXZpY2VzIHBlciBwYWdlOiB7ZGV2aWNlc19wZXJfcGFnZX0sIHF1ZXJ5OiB7c3RyKHF1ZXJ5KX0nKQogICAgICAgIHVybF9wYXJhbXMgPSB7J2xpbWl0JzogZGV2aWNlc19wZXJfcGFnZX0KICAgICAgICBpZiBvZmZzZXQ6CiAgICAgICAgICAgIHVybF9wYXJhbXNbJ29mZnNldCddID0gb2Zmc2V0CiAgICAgICAgaWYgcXVlcnk6CiAgICAgICAgICAgIHVybF9wYXJhbXNbJ2ZpbHRlciddID0gcXVlcnkKICAgICAgICByZXR1cm4gc2VsZi5fX2dldCgnZGV2aWNlcy9xdWVyaWVzL2RldmljZXMtc2Nyb2xsL3YxJywKICAgICAgICAgICAgICAgICAgICAgICAgICB1cmxfcGFyYW1zPXVybF9wYXJhbXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgZG9fYmFzaWNfYXV0aD1ub3Qgc2VsZi5fZ290X3Rva2VuKQoKICAgICMgcHlsaW50OiBkaXNhYmxlPWFyZ3VtZW50cy1kaWZmZXIKICAgIGRlZiBnZXRfZGV2aWNlX2xpc3Qoc2VsZiwgc2hvdWxkX2dldF9wb2xpY2llcywgc2hvdWxkX2dldF92dWxuZXJhYmlsaXRpZXMpOgogICAgICAgICIiIgogICAgICAgIEdldCBkZXZpY2VzIGRhdGEgbGlzdCBmcm9tIENyb3dkU3RyaWtlIEFwaQogICAgICAgICIiIgogICAgICAgICMgQ3Jvd2RTdHJpa2UgaGFzIGEgc2Nyb2xsIGFwaSB0aGF0IHN1cHBvcnRzIG1vcmUgdGhhbiAxNTAsMDAwIGRldmljZXMgYnV0IGl0IGlzIG5vdCBvcGVuIHRvIGV2ZXJ5b25lLgogICAgICAgICMgdHJ5IGl0IGZpcnN0CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXNwb25zZSA9IHNlbGYuZ2V0X2RldmljZXNfaWRzX3Njcm9sbChOb25lLCAxMCkKICAgICAgICAgICAgcXVlcnlfY291bnQgPSByZXNwb25zZVsnbWV0YSddWydwYWdpbmF0aW9uJ11bJ3RvdGFsJ10KICAgICAgICAgICAgbG9nZ2VyLmluZm8oZidVc2luZyBzY3JvbGwgYXBpIHdpdGggdG90YWwgZGV2aWNlczoge3F1ZXJ5X2NvdW50fScpCiAgICAgICAgICAgIGhhc19zY3JvbGxfYXBpID0gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYnUHJvYmxlbSB1c2luZyBzY3JvbGwgYXBpLCByZXZlcnRpbmcgdG8gcmVndWxhciBhcGknLCBleGNfaW5mbz1UcnVlKQogICAgICAgICAgICBoYXNfc2Nyb2xsX2FwaSA9IEZhbHNlCgogICAgICAgIGlmIGhhc19zY3JvbGxfYXBpOgogICAgICAgICAgICB5aWVsZCBmcm9tIHNlbGYuZ2V0X2RldmljZV9saXN0X3dpdGhfc2Nyb2xsX2FwaShzaG91bGRfZ2V0X3BvbGljaWVzLCBzaG91bGRfZ2V0X3Z1bG5lcmFiaWxpdGllcykKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMgSWYgdGhhdCBkb2Vzbid0IHdvcmsgdGhlbiB3ZSBuZWVkIHRvIHVzZSB0aGUgJ3JlZ3VsYXInIGFwaS4KICAgICAgICAjIER1ZSB0byB0aGUgQVBJJ3MgcGFnaW5hdGlvbiBsaW1pdCAodXAgdG8gMTUwLDAwMCBkZXZpY2VzIHBlciBvbmUgcXVlcnkpIHdlIGhhdmUgdG8gc3BsaXQgdGhlCiAgICAgICAgIyB5aWVsZHMgZm9yIGRpZmZlcm5ldCBxdWVyaWVzLgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLmdldF9kZXZpY2VzX2lkcygwLCAxMCkKICAgICAgICAgICAgdG90YWxfY291bnQgPSByZXNwb25zZVsnbWV0YSddWydwYWdpbmF0aW9uJ11bJ3RvdGFsJ10KICAgICAgICAgICAgbG9nZ2VyLmluZm8oZidUb3RhbCBjb3VudCBvZiBhbGwgYXNzZXRzOiB7dG90YWxfY291bnR9JykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGYnQ2FuIG5vdCBnZXQgaW5pdGlhbCBwYWdpbmF0aW9uIHJlc3BvbnNlJykKICAgICAgICAgICAgcmFpc2UKCiAgICAgICAgIyBZaWVsZCBhbGwgaG9zdG5hbWUgdGhhdCBzdGFydCB3aXRoIEEsIEIsIEMsIGV0Yy4gTm90ZSEgdGhpcyBpcyBjYXNlIGluLXNlbnNpdGl2ZS4KICAgICAgICBsZXR0ZXJzID0gW2Nocih4KSBmb3IgeCBpbiByYW5nZShvcmQoJ0EnKSwgb3JkKCdBJykgKyAyNildCiAgICAgICAgZm9yIGxldHRlciBpbiBsZXR0ZXJzOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB5aWVsZCBmcm9tIHNlbGYuZ2V0X2RldmljZV9saXN0X3dpdGhfcXVlcnkoCiAgICAgICAgICAgICAgICAgICAgc2hvdWxkX2dldF9wb2xpY2llcywKICAgICAgICAgICAgICAgICAgICBzaG91bGRfZ2V0X3Z1bG5lcmFiaWxpdGllcywKICAgICAgICAgICAgICAgICAgICBmJ2hvc3RuYW1lOlwne2xldHRlcn0qXCcnCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGYnQ2FuIG5vdCB5aWVsZCBmb3IgbGV0dGVyIHtsZXR0ZXJ9JykKCiAgICAgICAgIyBUaGVuLCB5aWVsZCBmcm9tIGFsbCB0aG9zZSB3aG8gZG8gbm90IHN0YXJ0IHdpdGggYXNjaWkgbGV0dGVycwogICAgICAgIHRyeToKICAgICAgICAgICAgeWllbGQgZnJvbSBzZWxmLmdldF9kZXZpY2VfbGlzdF93aXRoX3F1ZXJ5KAogICAgICAgICAgICAgICAgc2hvdWxkX2dldF9wb2xpY2llcywKICAgICAgICAgICAgICAgIHNob3VsZF9nZXRfdnVsbmVyYWJpbGl0aWVzLAogICAgICAgICAgICAgICAgJysnLmpvaW4oW2YnaG9zdG5hbWU6IVwne2xldHRlcn0qXCcnIGZvciBsZXR0ZXIgaW4gbGV0dGVyc10pCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGYnQ2FuIG5vdCB5aWVsZCBub3Qgb2YgYWxsIGxldHRlcnMnKQoKICAgICAgICAjIFRoZW4sIHlpZWxkIHRob3NlIHdobyBkbyBub3QgaGF2ZSBhIGhvc3RuYW1lLiBUaGlzIHNob3VsZCBoYXZlIGJlZW4gcGFydCBvZiB0aGUgJ25vdCBhbGwgbGV0dGVycycKICAgICAgICAjIGZpbHRlciBidXQgZG8gdGhpcyBqdXN0IGluIGNhc2UuCiAgICAgICAgdHJ5OgogICAgICAgICAgICB5aWVsZCBmcm9tIHNlbGYuZ2V0X2RldmljZV9saXN0X3dpdGhfcXVlcnkoCiAgICAgICAgICAgICAgICBzaG91bGRfZ2V0X3BvbGljaWVzLAogICAgICAgICAgICAgICAgc2hvdWxkX2dldF92dWxuZXJhYmlsaXRpZXMsCiAgICAgICAgICAgICAgICAnaG9zdG5hbWU6bnVsbCcKICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZidDYW4gbm90IHlpZWxkIGZyb20gaG9zdG5hbWUgbnVsbCcpCgogICAgZGVmIGdldF9kZXZpY2VfbGlzdF93aXRoX3Njcm9sbF9hcGkoc2VsZiwgc2hvdWxkX2dldF9wb2xpY2llcywgc2hvdWxkX2dldF92dWxuZXJhYmlsaXRpZXMpOgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLmdldF9kZXZpY2VzX2lkc19zY3JvbGwoTm9uZSwgY29uc3RzLkRFVklDRVNfUEVSX1BBR0UpCiAgICAgICAgICAgIG9mZnNldCA9IHJlc3BvbnNlWydtZXRhJ11bJ3BhZ2luYXRpb24nXVsnb2Zmc2V0J10KICAgICAgICAgICAgc2VsZi5yZXF1ZXN0c19jb3VudCArPSAxCiAgICAgICAgICAgIHRvdGFsX2NvdW50ID0gcmVzcG9uc2VbJ21ldGEnXVsncGFnaW5hdGlvbiddWyd0b3RhbCddCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ0NhbnQgZ2V0IHRvdGFsIGNvdW50JykKICAgICAgICAgICAgcmFpc2UgUkVTVEV4Y2VwdGlvbignQ2FudCBnZXQgdG90YWwgY291bnQnKQoKICAgICAgICBsb2dnZXIuaW5mbyhmJ0RldmljZXMgc2Nyb2xsOiBnb3QgdG90YWwgY291bnQgb2Yge3RvdGFsX2NvdW50fScpCgogICAgICAgIGRldmljZXNfcGVyX3BhZ2UgPSBpbnQoY29uc3RzLkRFVklDRVNfUEVSX1BBR0VfUEVSQ0VOVEFHRSAvIDEwMCAqIHRvdGFsX2NvdW50KQogICAgICAgICMgY2hlY2sgaWYgZGV2aWNlc19wZXJfcGFnZSBpcyBub3QgdG9vIGJpZyBvciB0b28gc21hbGwKICAgICAgICBpZiBkZXZpY2VzX3Blcl9wYWdlID4gY29uc3RzLk1BWF9ERVZJQ0VTX1BFUl9QQUdFOgogICAgICAgICAgICBkZXZpY2VzX3Blcl9wYWdlID0gY29uc3RzLk1BWF9ERVZJQ0VTX1BFUl9QQUdFCiAgICAgICAgaWYgZGV2aWNlc19wZXJfcGFnZSA8IGNvbnN0cy5ERVZJQ0VTX1BFUl9QQUdFOgogICAgICAgICAgICBkZXZpY2VzX3Blcl9wYWdlID0gY29uc3RzLkRFVklDRVNfUEVSX1BBR0UKCiAgICAgICAgIyBXZSBoYXZlIHRvIGZpcnN0IHB1bGwgYWxsIHJlc291cmNlcywgdGhlbiBwdWxsIHRoZSBkYXRhLiBUaGUgcmVhc29uIGJlaW5nIGlzIHRoYXQKICAgICAgICAjIHRoZSBzY3JvbGxpbmcgY3Vyc29yIGlzIGFjdGl2ZSBqdXN0IGZvciAyIG1pbnV0ZXMsIGFuZCBzbyB3ZSBoYXZlIHRvIG1ha2UgdGhvc2UgcmVxdWVzdHMgcXVpY2sgZW5vdWdoCiAgICAgICAgIyBhbmQgbm90IHRydXN0IGdldF9kZXZpY2VzX2RhdGEgd2hpY2ggY291bGQgYmUgc2xvdy4KICAgICAgICBhbGxfZGV2aWNlc19yZXNvdXJjZXMgPSByZXNwb25zZVsncmVzb3VyY2VzJ10KCiAgICAgICAgcGFnZXMgPSAwCiAgICAgICAgd2hpbGUgcGFnZXMgPCBNQVhfUEFHRVNfUFJPVEVDVElPTjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcGFnZXMgKz0gMQogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLmdldF9kZXZpY2VzX2lkc19zY3JvbGwob2Zmc2V0LCBkZXZpY2VzX3Blcl9wYWdlKQoKICAgICAgICAgICAgICAgIGlmIG5vdCByZXNwb25zZVsncmVzb3VyY2VzJ106CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgICAgICBhbGxfZGV2aWNlc19yZXNvdXJjZXMuZXh0ZW5kKHJlc3BvbnNlWydyZXNvdXJjZXMnXSkKICAgICAgICAgICAgICAgIHNlbGYucmVxdWVzdHNfY291bnQgKz0gMgogICAgICAgICAgICAgICAgaWYgc2VsZi5fZ290X3Rva2VuIGFuZCBzZWxmLnJlcXVlc3RzX2NvdW50ID49IGNvbnN0cy5SRUZSRVNIX1RPS0VOX1JFUVVFU1RTOgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVmcmVzaF9hY2Nlc3NfdG9rZW4oKQoKICAgICAgICAgICAgICAgIG9mZnNldCA9IHJlc3BvbnNlWydtZXRhJ11bJ3BhZ2luYXRpb24nXVsnb2Zmc2V0J10KICAgICAgICAgICAgICAgIGlmIG5vdCBvZmZzZXQ6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZidQcm9ibGVtIGdldHRpbmcgZGV2aWNlLXJlc291cmNlcyBvZmZzZXQge29mZnNldH0nKQogICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgbG9nZ2VyLmluZm8oZidHb3Qge2xlbihhbGxfZGV2aWNlc19yZXNvdXJjZXMpfSBkZXZpY2UtaWRzIGluIHtwYWdlc30gcGFnZXMuIFlpZWxkaW5nIHdpdGggZGF0YSBub3cnKQoKICAgICAgICBmb3IgY2h1bmsgaW4gY2h1bmtzKGRldmljZXNfcGVyX3BhZ2UsIGFsbF9kZXZpY2VzX3Jlc291cmNlcyk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGRldmljZXMgPSBzZWxmLmdldF9kZXZpY2VzX2RhdGEoY2h1bmssIHNob3VsZF9nZXRfcG9saWNpZXMsIHNob3VsZF9nZXRfdnVsbmVyYWJpbGl0aWVzKQogICAgICAgICAgICAgICAgeWllbGQgZnJvbSBkZXZpY2VzWydyZXNvdXJjZXMnXQoKICAgICAgICAgICAgICAgIHNlbGYucmVxdWVzdHNfY291bnQgKz0gMgogICAgICAgICAgICAgICAgaWYgc2VsZi5fZ290X3Rva2VuIGFuZCBzZWxmLnJlcXVlc3RzX2NvdW50ID49IGNvbnN0cy5SRUZSRVNIX1RPS0VOX1JFUVVFU1RTOgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVmcmVzaF9hY2Nlc3NfdG9rZW4oKQoKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZidQcm9ibGVtIGdldHRpbmcgb2Zmc2V0IHtvZmZzZXR9JykKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgZGVmIGdldF9kZXZpY2VfbGlzdF93aXRoX3F1ZXJ5KHNlbGYsIHNob3VsZF9nZXRfcG9saWNpZXMsIHNob3VsZF9nZXRfdnVsbmVyYWJpbGl0aWVzLCBxdWVyeSk6CiAgICAgICAgb2Zmc2V0ID0gMAogICAgICAgIGRldmljZXNfcGVyX3BhZ2UgPSBjb25zdHMuREVWSUNFU19QRVJfUEFHRQogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLmdldF9kZXZpY2VzX2lkcyhvZmZzZXQsIGRldmljZXNfcGVyX3BhZ2UsIHF1ZXJ5KQogICAgICAgICAgICBvZmZzZXQgKz0gcmVzcG9uc2VbJ21ldGEnXVsncGFnaW5hdGlvbiddWydvZmZzZXQnXQogICAgICAgICAgICBzZWxmLnJlcXVlc3RzX2NvdW50ICs9IDEKICAgICAgICAgICAgdG90YWxfY291bnQgPSByZXNwb25zZVsnbWV0YSddWydwYWdpbmF0aW9uJ11bJ3RvdGFsJ10KICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGYnQ2FudCBnZXQgdG90YWwgY291bnQnKQogICAgICAgICAgICByYWlzZSBSRVNURXhjZXB0aW9uKCdDYW50IGdldCB0b3RhbCBjb3VudCcpCgogICAgICAgIGxvZ2dlci5pbmZvKGYnVG90YWwgY291bnQgZm9yICJ7c3RyKHF1ZXJ5KX0iOiB7dG90YWxfY291bnR9JykKCiAgICAgICAgaWYgdG90YWxfY291bnQgPiAxNTAwMDA6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYnV2FybmluZyAtIG1vcmUgdGhhbiAxNTAsMDAwIGRldmljZXMgcGVyIHF1ZXJ5ISBDcm93ZC1TdHJpa2UgQVBJIGRvZXMgbm90IHN1cHBvcnQgdGhhdC4gJwogICAgICAgICAgICAgICAgICAgICAgICAgICBmJ1F1ZXJ5aW5nIHVwIHRvIDE1MCwwMDAuJykKICAgICAgICAgICAgdG90YWxfY291bnQgPSAxNTAwMDAKCiAgICAgICAgZGV2aWNlc19wZXJfcGFnZSA9IGludChjb25zdHMuREVWSUNFU19QRVJfUEFHRV9QRVJDRU5UQUdFIC8gMTAwICogdG90YWxfY291bnQpCiAgICAgICAgIyBjaGVjayBpZiBkZXZpY2VzX3Blcl9wYWdlIGlzIG5vdCB0b28gYmlnIG9yIHRvbyBzbWFsbAogICAgICAgIGlmIGRldmljZXNfcGVyX3BhZ2UgPiBjb25zdHMuTUFYX0RFVklDRVNfUEVSX1BBR0U6CiAgICAgICAgICAgIGRldmljZXNfcGVyX3BhZ2UgPSBjb25zdHMuTUFYX0RFVklDRVNfUEVSX1BBR0UKICAgICAgICBpZiBkZXZpY2VzX3Blcl9wYWdlIDwgY29uc3RzLkRFVklDRVNfUEVSX1BBR0U6CiAgICAgICAgICAgIGRldmljZXNfcGVyX3BhZ2UgPSBjb25zdHMuREVWSUNFU19QRVJfUEFHRQoKICAgICAgICBkZXZpY2VzID0gc2VsZi5nZXRfZGV2aWNlc19kYXRhKHJlc3BvbnNlWydyZXNvdXJjZXMnXSwgc2hvdWxkX2dldF9wb2xpY2llcywgc2hvdWxkX2dldF92dWxuZXJhYmlsaXRpZXMpCiAgICAgICAgeWllbGQgZnJvbSBkZXZpY2VzWydyZXNvdXJjZXMnXQoKICAgICAgICB3aGlsZSBvZmZzZXQgPCB0b3RhbF9jb3VudCBhbmQgb2Zmc2V0IDwgY29uc3RzLk1BWF9OVU1CRVJfT0ZfREVWSUNFUzoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLmdldF9kZXZpY2VzX2lkcyhvZmZzZXQsIGRldmljZXNfcGVyX3BhZ2UsIHF1ZXJ5KQogICAgICAgICAgICAgICAgZGV2aWNlcyA9IHNlbGYuZ2V0X2RldmljZXNfZGF0YShyZXNwb25zZVsncmVzb3VyY2VzJ10sIHNob3VsZF9nZXRfcG9saWNpZXMsIHNob3VsZF9nZXRfdnVsbmVyYWJpbGl0aWVzKQogICAgICAgICAgICAgICAgeWllbGQgZnJvbSBkZXZpY2VzWydyZXNvdXJjZXMnXQogICAgICAgICAgICAgICAgc2VsZi5yZXF1ZXN0c19jb3VudCArPSAyCiAgICAgICAgICAgICAgICBpZiBzZWxmLl9nb3RfdG9rZW4gYW5kIHNlbGYucmVxdWVzdHNfY291bnQgPj0gY29uc3RzLlJFRlJFU0hfVE9LRU5fUkVRVUVTVFM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWZyZXNoX2FjY2Vzc190b2tlbigpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGYnUHJvYmxlbSBnZXR0aW5nIG9mZnNldCB7b2Zmc2V0fScpCiAgICAgICAgICAgIG9mZnNldCArPSBkZXZpY2VzX3Blcl9wYWdlCg==',
    f'{CORTEX}/adapters/crowd_strike_adapter/service.py': b'aW1wb3J0IGRhdGV0aW1lCmltcG9ydCBsb2dnaW5nCgpmcm9tIHR5cGluZyBpbXBvcnQgTGlzdAoKZnJvbSBheG9uaXVzLmFkYXB0ZXJfYmFzZSBpbXBvcnQgQWRhcHRlckJhc2UsIEFkYXB0ZXJQcm9wZXJ0eQpmcm9tIGF4b25pdXMuYWRhcHRlcl9leGNlcHRpb25zIGltcG9ydCBDbGllbnRDb25uZWN0aW9uRXhjZXB0aW9uCmZyb20gYXhvbml1cy5jbGllbnRzLnJlc3QuY29ubmVjdGlvbiBpbXBvcnQgUkVTVENvbm5lY3Rpb24KZnJvbSBheG9uaXVzLmNsaWVudHMucmVzdC5leGNlcHRpb24gaW1wb3J0IFJFU1RFeGNlcHRpb24KZnJvbSBheG9uaXVzLmRldmljZXMuZGV2aWNlX2FkYXB0ZXIgaW1wb3J0IERldmljZUFkYXB0ZXIsIEFHRU5UX05BTUVTCmZyb20gYXhvbml1cy5maWVsZHMgaW1wb3J0IEZpZWxkLCBMaXN0RmllbGQKZnJvbSBheG9uaXVzLm1peGlucy5jb25maWd1cmFibGUgaW1wb3J0IENvbmZpZ3VyYWJsZQpmcm9tIGF4b25pdXMuc21hcnRfanNvbl9jbGFzcyBpbXBvcnQgU21hcnRKc29uQ2xhc3MKZnJvbSBheG9uaXVzLnV0aWxzLmZpbGVzIGltcG9ydCBnZXRfbG9jYWxfY29uZmlnX2ZpbGUKZnJvbSBheG9uaXVzLnV0aWxzLmRhdGV0aW1lIGltcG9ydCBwYXJzZV9kYXRlCmZyb20gYXhvbml1cy51dGlscy5wYXJzaW5nIGltcG9ydCBpc19kb21haW5fdmFsaWQKZnJvbSBjcm93ZF9zdHJpa2VfYWRhcHRlciBpbXBvcnQgY29uc3RzCmZyb20gY3Jvd2Rfc3RyaWtlX2FkYXB0ZXIuY29ubmVjdGlvbiBpbXBvcnQgQ3Jvd2RTdHJpa2VDb25uZWN0aW9uCgpsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcihmJ2F4b25pdXMue19fbmFtZV9ffScpCgoKY2xhc3MgR3JvdXAoU21hcnRKc29uQ2xhc3MpOgogICAgY3JlYXRlZF9ieSA9IEZpZWxkKHN0ciwgJ0NyZWF0ZWQgQnknKQogICAgY3JlYXRlZF90aW1lc3RhbXAgPSBGaWVsZChkYXRldGltZS5kYXRldGltZSwgJ0NyZWF0ZWQgVGltZScpCiAgICBkZXNjcmlwdGlvbiA9IEZpZWxkKHN0ciwgJ0Rlc2NyaXB0aW9uJykKICAgIGdyb3VwX3R5cGUgPSBGaWVsZChzdHIsICdHcm91cCBUeXBlJykKICAgIGlkID0gRmllbGQoc3RyLCAnSWQnKQogICAgbW9kaWZpZWRfYnkgPSBGaWVsZChzdHIsICdNb2RpZmllZCBCeScpCiAgICBtb2RpZmllZF90aW1lID0gRmllbGQoZGF0ZXRpbWUuZGF0ZXRpbWUsICdNb2RpZmllZCBUaW1lJykKICAgIG5hbWUgPSBGaWVsZChzdHIsICdOYW1lJykKCgpjbGFzcyBQb2xpY3lTZXR0aW5nVmFsdWUoU21hcnRKc29uQ2xhc3MpOgogICAgZW5hYmxlZCA9IEZpZWxkKGJvb2wsICdFbmFibGVkJykKCgpjbGFzcyBQb2xpY3lTZXR0aW5ncyhTbWFydEpzb25DbGFzcyk6CiAgICBpZCA9IEZpZWxkKHN0ciwgJ0lkJykKICAgIG5hbWUgPSBGaWVsZChzdHIsICduYW1lJykKICAgIGRlc2NyaXB0aW9uID0gRmllbGQoc3RyLCAnRGVzY3JpcHRpb24nKQogICAgdmFsdWUgPSBGaWVsZChQb2xpY3lTZXR0aW5nVmFsdWUsICdWYWx1ZScpCgoKY2xhc3MgUHJldmVudGlvblNldHRpbmdzKFNtYXJ0SnNvbkNsYXNzKToKICAgIG5hbWUgPSBGaWVsZChzdHIsICdOYW1lJykKICAgIHNldHRpbmdzID0gTGlzdEZpZWxkKFBvbGljeVNldHRpbmdzLCAnU2V0dGluZ3MnKQoKCmNsYXNzIFNlbnNvclVwZGF0ZVNldHRpbmdzKFNtYXJ0SnNvbkNsYXNzKToKICAgIGJ1aWxkID0gRmllbGQoc3RyLCAnQnVpbGQnKQoKCmNsYXNzIFBvbGljeShTbWFydEpzb25DbGFzcyk6CiAgICBuYW1lID0gRmllbGQoc3RyLCAnTmFtZScpCiAgICBkZXNjcmlwdGlvbiA9IEZpZWxkKHN0ciwgJ0Rlc2NyaXB0aW9uJykKICAgIHBsYXRmb3JtX25hbWUgPSBGaWVsZChzdHIsICdQbGF0Zm9ybSBOYW1lJykKICAgIGdyb3VwcyA9IExpc3RGaWVsZChHcm91cCwgJ0dyb3VwcycpCiAgICBlbmFibGVkID0gRmllbGQoYm9vbCwgJ0VuYWJsZWQnKQogICAgY3JlYXRlZF9ieSA9IEZpZWxkKHN0ciwgJ0NyZWF0ZWQgQnknKQogICAgY3JlYXRlZF90aW1lID0gRmllbGQoZGF0ZXRpbWUuZGF0ZXRpbWUsICdDcmVhdGVkIFRpbWUnKQogICAgcHJldmVudGlvbl9zZXR0aW5ncyA9IExpc3RGaWVsZChQcmV2ZW50aW9uU2V0dGluZ3MsICdQcmV2ZW50aW9uIFNldHRpbmdzJykKICAgIHNlbnNvcl91cGRhdGVfc2V0dGluZ3MgPSBGaWVsZChTZW5zb3JVcGRhdGVTZXR0aW5ncywgJ1NlbnNvciBVcGRhdGUgU2V0dGluZ3MnKQoKCmNsYXNzIFNwb3RsaWdodFZ1bG5lcmFiaWxpdHkoU21hcnRKc29uQ2xhc3MpOgogICAgY3JlYXRlZF90aW1lc3RhbXAgPSBGaWVsZChkYXRldGltZS5kYXRldGltZSwgJ0NyZWF0ZWQgVGltZScpCiAgICBjbG9zZWRfdGltZXN0YW1wID0gRmllbGQoZGF0ZXRpbWUuZGF0ZXRpbWUsICdDbG9zZWQgVGltZScpCiAgICBzdGF0dXMgPSBGaWVsZChzdHIsICdTdGF0dXMnKQogICAgY3ZlX2lkID0gRmllbGQoc3RyLCAnQ1ZFJykKICAgIGN2ZV9zY29yZSA9IEZpZWxkKGludCwgJ0NWRSBTY29yZScpCiAgICBjdmVfc2V2ZXJpdHkgPSBGaWVsZChzdHIsICdDVkUgU2V2ZXJpdHknKQogICAgYXBwbGljYXRpb25fbmFtZSA9IEZpZWxkKHN0ciwgJ0FwcGxpY2F0aW9uIE5hbWUnKQoKCmNsYXNzIENyb3dkU3RyaWtlQWRhcHRlcihBZGFwdGVyQmFzZSwgQ29uZmlndXJhYmxlKToKICAgICMgcHlsaW50OiBkaXNhYmxlPXRvby1tYW55LWluc3RhbmNlLWF0dHJpYnV0ZXMKICAgIGNsYXNzIE15RGV2aWNlQWRhcHRlcihEZXZpY2VBZGFwdGVyKToKICAgICAgICBleHRlcm5hbF9pcCA9IEZpZWxkKHN0ciwgJ0V4dGVybmFsIElQJykKICAgICAgICBncm91cHMgPSBMaXN0RmllbGQoR3JvdXAsICdHcm91cHMnKQogICAgICAgIHByZXZlbnRpb25fcG9saWN5ID0gRmllbGQoUG9saWN5LCAnUHJldmVudGlvbiBQb2xpY3knKQogICAgICAgIHNlbnNvcl91cGRhdGVfcG9saWN5ID0gRmllbGQoUG9saWN5LCAnU2Vuc29yIFVwZGF0ZSBQb2xpY3knKQogICAgICAgIGNzX2FnZW50X3ZlcnNpb24gPSBGaWVsZChzdHIsICdDcm93ZFN0cmlrZSBBZ2VudCBWZXJzaW9uJykKICAgICAgICBzeXN0ZW1fcHJvZHVjdF9uYW1lID0gRmllbGQoc3RyLCAnU3lzdGVtIFByb2R1Y3QgTmFtZScpCiAgICAgICAgZnVsbF9vc3hfdmVyc2lvbiA9IEZpZWxkKHN0ciwgJ0Z1bGwgT1MgWCBWZXJzaW9uJykKICAgICAgICBzcG90bGlnaHRfdnVsbmVyYWJpbGl0aWVzID0gTGlzdEZpZWxkKFNwb3RsaWdodFZ1bG5lcmFiaWxpdHksICdEZXZpY2UgVnVsbmVyYWJpbGl0aWVzJykKCiAgICBkZWYgX19pbml0X18oc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKGNvbmZpZ19maWxlX3BhdGg9Z2V0X2xvY2FsX2NvbmZpZ19maWxlKF9fZmlsZV9fKSwgKmFyZ3MsICoqa3dhcmdzKQoKICAgIGRlZiBhY3Rpb24oc2VsZiwgYWN0aW9uX3R5cGUpOgogICAgICAgIHJhaXNlIE5vdEltcGxlbWVudGVkRXJyb3IoKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfZ2V0X2NsaWVudF9pZChjbGllbnRfY29uZmlnKToKICAgICAgICByZXR1cm4gY2xpZW50X2NvbmZpZ1snZG9tYWluJ10gKyAnXycgKyBjbGllbnRfY29uZmlnWyd1c2VybmFtZSddCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF90ZXN0X3JlYWNoYWJpbGl0eShjbGllbnRfY29uZmlnKToKICAgICAgICByZXR1cm4gUkVTVENvbm5lY3Rpb24udGVzdF9yZWFjaGFiaWxpdHkoY2xpZW50X2NvbmZpZy5nZXQoJ2RvbWFpbicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwc19wcm94eT1jbGllbnRfY29uZmlnLmdldCgnaHR0cHNfcHJveHknKSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX2Nvbm5lY3RfY2xpZW50KGNsaWVudF9jb25maWcpOgogICAgICAgIHRyeToKICAgICAgICAgICAgY29ubmVjdGlvbiA9IENyb3dkU3RyaWtlQ29ubmVjdGlvbihkb21haW49Y2xpZW50X2NvbmZpZ1snZG9tYWluJ10sIHZlcmlmeV9zc2w9Y2xpZW50X2NvbmZpZ1sndmVyaWZ5X3NzbCddLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lPWNsaWVudF9jb25maWdbJ3VzZXJuYW1lJ10sIHBhc3N3b3JkPWNsaWVudF9jb25maWdbJ2FwaWtleSddLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHBzX3Byb3h5PWNsaWVudF9jb25maWcuZ2V0KCdodHRwc19wcm94eScpKQogICAgICAgICAgICB3aXRoIGNvbm5lY3Rpb246CiAgICAgICAgICAgICAgICBwYXNzICAjIGNoZWNrIHRoYXQgdGhlIGNvbm5lY3Rpb24gY3JlZGVudGlhbHMgYXJlIHZhbGlkCiAgICAgICAgICAgIHJldHVybiBjb25uZWN0aW9uCiAgICAgICAgZXhjZXB0IFJFU1RFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbWVzc2FnZSA9ICdFcnJvciBjb25uZWN0aW5nIHRvIGNsaWVudCB3aXRoIGRvbWFpbiB7MH0sIHJlYXNvbjogezF9Jy5mb3JtYXQoCiAgICAgICAgICAgICAgICBjbGllbnRfY29uZmlnWydkb21haW4nXSwgc3RyKGUpKQogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKG1lc3NhZ2UpCiAgICAgICAgICAgIHJhaXNlIENsaWVudENvbm5lY3Rpb25FeGNlcHRpb24obWVzc2FnZSkKCiAgICBkZWYgX3F1ZXJ5X2RldmljZXNfYnlfY2xpZW50KHNlbGYsIGNsaWVudF9uYW1lLCBjbGllbnRfZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgR2V0IGFsbCBkZXZpY2VzIGZyb20gYSBzcGVjaWZpYyAgZG9tYWluCgogICAgICAgIDpwYXJhbSBzdHIgY2xpZW50X25hbWU6IFRoZSBuYW1lIG9mIHRoZSBjbGllbnQKICAgICAgICA6cGFyYW0gb2JqIGNsaWVudF9kYXRhOiBUaGUgZGF0YSB0aGF0IHJlcHJlc2VudCBhIGNvbm5lY3Rpb24KCiAgICAgICAgOnJldHVybjogQSBqc29uIHdpdGggYWxsIHRoZSBhdHRyaWJ1dGVzIHJldHVybmVkIGZyb20gdGhlIFNlcnZlcgogICAgICAgICIiIgogICAgICAgIHdpdGggY2xpZW50X2RhdGE6CiAgICAgICAgICAgIHlpZWxkIGZyb20gY2xpZW50X2RhdGEuZ2V0X2RldmljZV9saXN0KHNlbGYuX2dldF9wb2xpY2llcywgc2VsZi5fZ2V0X3Z1bG5lcmFiaWxpdGllcykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX2NsaWVudHNfc2NoZW1hKCk6CiAgICAgICAgIiIiCiAgICAgICAgVGhlIHNjaGVtYSB0aGUgYWRhcHRlciBleHBlY3RzIGZyb20gY29uZmlncwoKICAgICAgICA6cmV0dXJuOiBKU09OIHNjaGVtZQogICAgICAgICIiIgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdpdGVtcyc6IFsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAnbmFtZSc6ICdkb21haW4nLAogICAgICAgICAgICAgICAgICAgICd0aXRsZSc6ICdDcm93ZFN0cmlrZSBEb21haW4nLAogICAgICAgICAgICAgICAgICAgICd0eXBlJzogJ3N0cmluZycKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgJ25hbWUnOiAndXNlcm5hbWUnLAogICAgICAgICAgICAgICAgICAgICd0aXRsZSc6ICdVc2VyIE5hbWUgLyBDbGllbnQgSUQnLAogICAgICAgICAgICAgICAgICAgICd0eXBlJzogJ3N0cmluZycKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgJ25hbWUnOiAnYXBpa2V5JywKICAgICAgICAgICAgICAgICAgICAndGl0bGUnOiAnQVBJIEtleSAvIFNlY3JldCcsCiAgICAgICAgICAgICAgICAgICAgJ3R5cGUnOiAnc3RyaW5nJywKICAgICAgICAgICAgICAgICAgICAnZm9ybWF0JzogJ3Bhc3N3b3JkJwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAnbmFtZSc6ICd2ZXJpZnlfc3NsJywKICAgICAgICAgICAgICAgICAgICAndGl0bGUnOiAnVmVyaWZ5IFNTTCcsCiAgICAgICAgICAgICAgICAgICAgJ3R5cGUnOiAnYm9vbCcKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgJ25hbWUnOiAnaHR0cHNfcHJveHknLAogICAgICAgICAgICAgICAgICAgICd0aXRsZSc6ICdIVFRQUyBQcm94eScsCiAgICAgICAgICAgICAgICAgICAgJ3R5cGUnOiAnc3RyaW5nJwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBdLAogICAgICAgICAgICAncmVxdWlyZWQnOiBbCiAgICAgICAgICAgICAgICAnZG9tYWluJywKICAgICAgICAgICAgICAgICd1c2VybmFtZScsCiAgICAgICAgICAgICAgICAnYXBpa2V5JywKICAgICAgICAgICAgICAgICd2ZXJpZnlfc3NsJwogICAgICAgICAgICBdLAogICAgICAgICAgICAndHlwZSc6ICdhcnJheScKICAgICAgICB9CgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHBhcnNlX2dyb3Vwcyhncm91cHMpOgogICAgICAgIHBhcnNlZF9ncm91cHMgPSBbXQogICAgICAgIGlmIGdyb3VwcyBhbmQgaXNpbnN0YW5jZShncm91cHMsIGxpc3QpOgogICAgICAgICAgICBmb3IgZ3JvdXAgaW4gZ3JvdXBzOgogICAgICAgICAgICAgICAgcGFyc2VkX2dyb3Vwcy5hcHBlbmQoR3JvdXAoY3JlYXRlZF9ieT1ncm91cC5nZXQoJ2NyZWF0ZWRfYnknKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZWRfdGltZXN0YW1wPXBhcnNlX2RhdGUoZ3JvdXAuZ2V0KCdjcmVhdGVkX3RpbWVzdGFtcCcpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPWdyb3VwLmdldCgnZGVzY3JpcHRpb24nKSwgZ3JvdXBfdHlwZT1ncm91cC5nZXQoJ2dyb3VwX3R5cGUnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkPWdyb3VwLmdldCgnaWQnKSwgbW9kaWZpZWRfYnk9Z3JvdXAuZ2V0KCdtb2RpZmllZF9ieScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZpZWRfdGltZT1wYXJzZV9kYXRlKGdyb3VwLmdldCgnbW9kaWZpZWRfdGltZScpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU9Z3JvdXAuZ2V0KCduYW1lJykpKQogICAgICAgIHJldHVybiBwYXJzZWRfZ3JvdXBzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHBhcnNlX3Z1bG5lcmFiaWxpdGllcyh2dWxuZXJhYmlsaXRpZXMpOgogICAgICAgIHBhcnNlZF92dWxuZXJhYmlsaXRpZXMgPSBbXQogICAgICAgIGlmIGlzaW5zdGFuY2UodnVsbmVyYWJpbGl0aWVzLCBsaXN0KToKICAgICAgICAgICAgZm9yIHZ1bG5lcmFiaWxpdHkgaW4gdnVsbmVyYWJpbGl0aWVzOgogICAgICAgICAgICAgICAgdnVsID0gU3BvdGxpZ2h0VnVsbmVyYWJpbGl0eShjcmVhdGVkX3RpbWVzdGFtcD1wYXJzZV9kYXRlKHZ1bG5lcmFiaWxpdHkuZ2V0KCdjcmVhdGVkX3RpbWVzdGFtcCcpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xvc2VkX3RpbWVzdGFtcD1wYXJzZV9kYXRlKHZ1bG5lcmFiaWxpdHkuZ2V0KCdjbG9zZWRfdGltZXN0YW1wJykpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM9dnVsbmVyYWJpbGl0eS5nZXQoJ3N0YXR1cycpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdmVfaWQ9dnVsbmVyYWJpbGl0eS5nZXQoJ2N2ZScsIHt9KS5nZXQoJ2lkJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN2ZV9zY29yZT12dWxuZXJhYmlsaXR5LmdldCgnY3ZlJywge30pLmdldCgnYmFzZV9zY29yZScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdmVfc2V2ZXJpdHk9dnVsbmVyYWJpbGl0eS5nZXQoJ2N2ZScsIHt9KS5nZXQoJ3NldmVyaXR5JyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uX25hbWU9dnVsbmVyYWJpbGl0eS5nZXQoJ2FwcCcsIHt9KS5nZXQoJ3Byb2R1Y3RfbmFtZV92ZXJzaW9uJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIHBhcnNlZF92dWxuZXJhYmlsaXRpZXMuYXBwZW5kKHZ1bCkKICAgICAgICByZXR1cm4gcGFyc2VkX3Z1bG5lcmFiaWxpdGllcwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBhZGRfdnVsbmVyYWJsZV9zb2Z0d2FyZXMoZGV2aWNlOiBEZXZpY2VBZGFwdGVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJzZWRfdnVsbmVyYWJpbGl0aWVzOiBMaXN0W1Nwb3RsaWdodFZ1bG5lcmFiaWxpdHldKToKICAgICAgICAiIiIKICAgICAgICBBZGQgdnVsbmVyYWJsZSBzb2Z0d2FyZXMgdG8gZGV2aWNlIGRhdGEKICAgICAgICA6cGFyYW0gZGV2aWNlOiBkZXZpY2UgZm9yIGFkZGluZyBpdHMgc29mdHdhcmVzCiAgICAgICAgOnBhcmFtIHBhcnNlZF92dWxuZXJhYmlsaXRpZXM6IHBhcnNlZCB2dWxuZXJhYmlsaXRpZXMKICAgICAgICA6cmV0dXJuOiBOb25lCiAgICAgICAgIiIiCiAgICAgICAgZm9yIHZ1bCBpbiBwYXJzZWRfdnVsbmVyYWJpbGl0aWVzOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZXZlcml0eSA9IHZ1bC5jdmVfc2V2ZXJpdHkgaWYgdnVsLmN2ZV9zZXZlcml0eSBpbiBbJ05PTkUnLCAnTE9XJywgJ01FRElVTScsICdISUdIJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnQ1JJVElDQUwnXSBlbHNlICdOT05FJwogICAgICAgICAgICAgICAgZGV2aWNlLmFkZF92dWxuZXJhYmxlX3NvZnR3YXJlKGN2ZV9pZD12dWwuY3ZlX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvZnR3YXJlX25hbWU9dnVsLmFwcGxpY2F0aW9uX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3ZlX3NldmVyaXR5PXNldmVyaXR5KQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbignRXJyb3IgYWRkaW5nIHZ1bG5lcmFibGUgc29mdHdhcmUnKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBwYXJzZV9wb2xpY3kocG9saWN5LCBzZXR0aW5nc190eXBlKToKICAgICAgICBpZiBub3QgcG9saWN5OgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIHBhcnNlZF9wb2xpY3kgPSBOb25lCiAgICAgICAgcGFyc2VkX2dyb3VwcyA9IFtdCiAgICAgICAgcGFyc2VkX3ByZXZlbnRpb25fc2V0dGluZ3MgPSBbXQogICAgICAgIHBhcnNlZF9zZW5zb3JfdXBkYXRlX3NldHRpbmdzID0gTm9uZQogICAgICAgIHRyeToKICAgICAgICAgICAgZ3JvdXBzID0gcG9saWN5LmdldCgnZ3JvdXBzJykKICAgICAgICAgICAgIyBwYXJzZSBwb2xpY2llcyBncm91cHMKICAgICAgICAgICAgcGFyc2VkX2dyb3VwcyA9IENyb3dkU3RyaWtlQWRhcHRlci5wYXJzZV9ncm91cHMoZ3JvdXBzKQoKICAgICAgICAgICAgIyBwYXJzZSBwb2xpY2llcyBzZXR0aW5ncwogICAgICAgICAgICBpZiBzZXR0aW5nc190eXBlID09ICdwcmV2ZW50aW9uX3NldHRpbmdzJzoKICAgICAgICAgICAgICAgIHByZXZlbnRpb25fc2V0dGluZ3MgPSBwb2xpY3kuZ2V0KCdwcmV2ZW50aW9uX3NldHRpbmdzJywgW10pCiAgICAgICAgICAgICAgICBmb3IgcHJldmVudGlvbl9zZXR0IGluIHByZXZlbnRpb25fc2V0dGluZ3M6CiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3MgPSBwcmV2ZW50aW9uX3NldHQuZ2V0KCdzZXR0aW5ncycsIFtdKQogICAgICAgICAgICAgICAgICAgIGFsbF9zZXR0aW5ncyA9IFtdCiAgICAgICAgICAgICAgICAgICAgZm9yIHNldHQgaW4gc2V0dGluZ3M6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IFBvbGljeVNldHRpbmdWYWx1ZShlbmFibGVkPXNldHQuZ2V0KCd2YWx1ZScpLmdldCgnZW5hYmxlZCcpKSBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBzZXR0LmdldCgndmFsdWUnKSBlbHNlIE5vbmUKICAgICAgICAgICAgICAgICAgICAgICAgYWxsX3NldHRpbmdzLmFwcGVuZChQb2xpY3lTZXR0aW5ncyhpZD1zZXR0LmdldCgnaWQnKSwgbmFtZT1zZXR0LmdldCgnbmFtZScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPXNldHQuZ2V0KCdkZXNjcmlwdGlvbicpLCB2YWx1ZT12YWwpKQogICAgICAgICAgICAgICAgICAgIHBhcnNlZF9wcmV2ZW50aW9uX3NldHRpbmdzLmFwcGVuZChQcmV2ZW50aW9uU2V0dGluZ3MoCiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU9cHJldmVudGlvbl9zZXR0LmdldCgnbmFtZScpLCBzZXR0aW5ncz1hbGxfc2V0dGluZ3MpKQoKICAgICAgICAgICAgZWxpZiBzZXR0aW5nc190eXBlID09ICdzZW5zb3JfdXBkYXRlX3NldHRpbmdzJzoKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gcG9saWN5LmdldCgnc2V0dGluZ3MnKQogICAgICAgICAgICAgICAgaWYgc2V0dGluZ3M6CiAgICAgICAgICAgICAgICAgICAgcGFyc2VkX3NlbnNvcl91cGRhdGVfc2V0dGluZ3MgPSBTZW5zb3JVcGRhdGVTZXR0aW5ncyhidWlsZD1zZXR0aW5ncy5nZXQoJ2J1aWxkJykpCgogICAgICAgICAgICBwYXJzZWRfcG9saWN5ID0gUG9saWN5KG5hbWU9cG9saWN5LmdldCgnbmFtZScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uPXBvbGljeS5nZXQoJ2RlY3JpcHRpb24nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGF0Zm9ybV9uYW1lPXBvbGljeS5nZXQoJ3BsYXRmb3JtX25hbWUnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cHM9cGFyc2VkX2dyb3VwcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmFibGVkPXBvbGljeS5nZXQoJ2VuYWJsZWQnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVkX2J5PXBvbGljeS5nZXQoJ2NyZWF0ZWRfYnknKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVkX3RpbWU9cGFyc2VfZGF0ZShwb2xpY3kuZ2V0KCdjcmVhdGVkX3RpbWUnKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmVudGlvbl9zZXR0aW5ncz1wYXJzZWRfcHJldmVudGlvbl9zZXR0aW5ncywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5zb3JfdXBkYXRlX3NldHRpbmdzPXBhcnNlZF9zZW5zb3JfdXBkYXRlX3NldHRpbmdzKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oJ0Vycm9yIGdldHRpbmcgcG9saWN5ICVzJywgcG9saWN5LmdldCgnaWQnKSkKICAgICAgICByZXR1cm4gcGFyc2VkX3BvbGljeQoKICAgICMgcHlsaW50OiBkaXNhYmxlPXRvby1tYW55LXN0YXRlbWVudHMsdG9vLW1hbnktYnJhbmNoZXMsdG9vLW1hbnktbmVzdGVkLWJsb2NrcwogICAgZGVmIF9wYXJzZV9yYXdfZGF0YShzZWxmLCBkZXZpY2VzX3Jhd19kYXRhKToKICAgICAgICBmb3IgZGV2aWNlX3JhdyBpbiBkZXZpY2VzX3Jhd19kYXRhOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkZXZpY2UgPSBzZWxmLl9uZXdfZGV2aWNlX2FkYXB0ZXIoKQogICAgICAgICAgICAgICAgZGV2aWNlX2lkID0gZGV2aWNlX3Jhdy5nZXQoJ2RldmljZV9pZCcpCiAgICAgICAgICAgICAgICBpZiBub3QgZGV2aWNlX2lkOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBkZXZpY2UuaWQgPSBkZXZpY2VfaWQKICAgICAgICAgICAgICAgIGRldmljZS5hZGRfYWdlbnRfdmVyc2lvbihhZ2VudD1BR0VOVF9OQU1FUy5jcm93ZF9zdHJpa2UsIHZlcnNpb249ZGV2aWNlX3Jhdy5nZXQoJ2FnZW50X3ZlcnNpb24nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM9ZGV2aWNlX3Jhdy5nZXQoJ3N0YXR1cycpKQogICAgICAgICAgICAgICAgZGV2aWNlLmNzX2FnZW50X3ZlcnNpb24gPSBkZXZpY2VfcmF3LmdldCgnYWdlbnRfdmVyc2lvbicpCiAgICAgICAgICAgICAgICBtYWNfYWRkcmVzcyA9IGRldmljZV9yYXcuZ2V0KCdtYWNfYWRkcmVzcycpCiAgICAgICAgICAgICAgICBsb2NhbF9pcCA9IGRldmljZV9yYXcuZ2V0KCdsb2NhbF9pcCcpCiAgICAgICAgICAgICAgICBkZXZpY2UuYWRkX2lwc19hbmRfbWFjcyhtYWNfYWRkcmVzcywgbG9jYWxfaXAuc3BsaXQoJywnKSBpZiBsb2NhbF9pcCBpcyBub3QgTm9uZSBlbHNlIE5vbmUpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaG9zdG5hbWUgPSBkZXZpY2VfcmF3LmdldCgnaG9zdG5hbWUnKQogICAgICAgICAgICAgICAgICAgIGRvbWFpbiA9IGRldmljZV9yYXcuZ2V0KCdtYWNoaW5lX2RvbWFpbicpCiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzZWxmLl9fbWFjaGluZV9kb21haW5fd2hpdGVsaXN0LCBsaXN0KSBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmQgc2VsZi5fX21hY2hpbmVfZG9tYWluX3doaXRlbGlzdCBhbmQgXAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyKGRvbWFpbikubG93ZXIoKSBub3QgaW4gc2VsZi5fX21hY2hpbmVfZG9tYWluX3doaXRlbGlzdDoKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICBpZiBub3QgaXNfZG9tYWluX3ZhbGlkKGRvbWFpbik6CiAgICAgICAgICAgICAgICAgICAgICAgIGRvbWFpbiA9IE5vbmUKICAgICAgICAgICAgICAgICAgICBkZXZpY2UuZG9tYWluID0gZG9tYWluCiAgICAgICAgICAgICAgICAgICAgZGV2aWNlLmhvc3RuYW1lID0gaG9zdG5hbWUKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ1Byb2JsZW0gZ2V0dGluZyBob3N0bmFtZSBmb3Ige2RldmljZV9yYXd9JykKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBkZXZpY2UuZmlndXJlX29zKChkZXZpY2VfcmF3LmdldCgncGxhdGZvcm1fbmFtZScpIG9yICcnKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZGV2aWNlX3Jhdy5nZXQoJ29zX3ZlcnNpb24nKSBvciAnJykpCiAgICAgICAgICAgICAgICAgICAgZGV2aWNlLm9zLmJ1aWxkID0gZGV2aWNlX3Jhdy5nZXQoJ2J1aWxkX251bWJlcicpCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2Uub3MubWFqb3IgPSBpbnQoZGV2aWNlX3Jhdy5nZXQoJ3NlcnZpY2VfcGFja19tYWpvcicpKQogICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2Uub3MubWlub3IgPSBpbnQoZGV2aWNlX3Jhdy5nZXQoJ3NlcnZpY2VfcGFja19taW5vcicpKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBpZiBkZXZpY2Uub3MudHlwZSA9PSAnT1MgWCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2UuZnVsbF9vc3hfdmVyc2lvbiA9IFwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2VfcmF3LmdldCgnb3NfdmVyc2lvbicpLnNwbGl0KCcgJylbLTFdLnN0cmlwKCcpJykuc3RyaXAoJygnKSBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAnLicgKyBkZXZpY2VfcmF3LmdldCgnbWlub3JfdmVyc2lvbicpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGYnUHJvYmxlbSBnZXR0aW5nIE9TIGZvciB7ZGV2aWNlX3Jhd30nKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGRldmljZS5sYXN0X3NlZW4gPSBwYXJzZV9kYXRlKGRldmljZV9yYXcuZ2V0KCdsYXN0X3NlZW4nKSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ1Byb2JsZW0gZ2V0dGluZyBsYXN0IHNlZW4gZm9yIHtkZXZpY2VfcmF3fScpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgZGV2aWNlLmZpcnN0X3NlZW4gPSBwYXJzZV9kYXRlKGRldmljZV9yYXcuZ2V0KCdmaXJzdF9zZWVuJykpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZidQcm9ibGVtIGdldHRpbmcgZmlyc3Qgc2VlbicpCiAgICAgICAgICAgICAgICBkZXZpY2UuZXh0ZXJuYWxfaXAgPSBkZXZpY2VfcmF3LmdldCgnZXh0ZXJuYWxfaXAnKQogICAgICAgICAgICAgICAgZGV2aWNlLmRldmljZV9tYW51ZmFjdHVyZXIgPSBkZXZpY2VfcmF3LmdldCgnYmlvc19tYW51ZmFjdHVyZXInKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGRldmljZS5ncm91cHMgPSBzZWxmLnBhcnNlX2dyb3VwcyhkZXZpY2VfcmF3LmdldCgnZ3JvdXBzX2RhdGEnKSkKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLl9fZ3JvdXBfbmFtZV93aGl0ZWxpc3Q6CiAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kX2dyb3VwID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGdyb3VwX3JhdyBpbiBkZXZpY2VfcmF3LmdldCgnZ3JvdXBzX2RhdGEnKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGdyb3VwX3Jhdy5nZXQoJ25hbWUnKSBpbiBzZWxmLl9fZ3JvdXBfbmFtZV93aGl0ZWxpc3Q6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRfZ3JvdXAgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBmb3VuZF9ncm91cDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZidQcm9ibGVtIGdldHRpbmcgZ3JvdXBzIGZvciB7ZGV2aWNlX3Jhd30nKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHBvbGljaWVzID0gZGV2aWNlX3Jhdy5nZXQoJ2RldmljZV9wb2xpY2llcycpCiAgICAgICAgICAgICAgICAgICAgaWYgcG9saWNpZXM6CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnRpb25fcG9sID0gcG9saWNpZXMuZ2V0KGNvbnN0cy5Qb2xpY3lUeXBlcy5QcmV2ZW50aW9uLnZhbHVlKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBwcmV2ZW50aW9uX3BvbDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBwcmV2ZW50aW9uX3BvbC5nZXQoJ2RhdGEnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV2aWNlLnByZXZlbnRpb25fcG9saWN5ID0gc2VsZi5wYXJzZV9wb2xpY3koZGF0YSwgJ3ByZXZlbnRpb25fc2V0dGluZ3MnKSBpZiBkYXRhIGVsc2UgTm9uZQogICAgICAgICAgICAgICAgICAgICAgICBzZW5zb3JfdXBkYXRlX3BvbCA9IHBvbGljaWVzLmdldChjb25zdHMuUG9saWN5VHlwZXMuU2Vuc29yVXBkYXRlLnZhbHVlKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZW5zb3JfdXBkYXRlX3BvbDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBzZW5zb3JfdXBkYXRlX3BvbC5nZXQoJ2RhdGEnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV2aWNlLnNlbnNvcl91cGRhdGVfcG9saWN5ID0gc2VsZi5wYXJzZV9wb2xpY3koCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSwgJ3NlbnNvcl91cGRhdGVfc2V0dGluZ3MnKSBpZiBkYXRhIGVsc2UgTm9uZQogICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2VfcmF3LnBvcCgnZGV2aWNlX3BvbGljaWVzJykKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ1Byb2JsZW0gZ2V0dGluZyBwb2xpY2llcyBhdCB7ZGV2aWNlX3Jhd30nKQogICAgICAgICAgICAgICAgZGV2aWNlLnN5c3RlbV9wcm9kdWN0X25hbWUgPSBkZXZpY2VfcmF3LmdldCgnc3lzdGVtX3Byb2R1Y3RfbmFtZScpCiAgICAgICAgICAgICAgICB2dWxuZXJhYmlsaXRpZXMgPSBkZXZpY2VfcmF3LmdldCgndnVsbmVyYWJpbGl0aWVzJykKICAgICAgICAgICAgICAgIGlmIHZ1bG5lcmFiaWxpdGllczoKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlZF92dWxuZXJhYmlsaXRpZXMgPSBzZWxmLnBhcnNlX3Z1bG5lcmFiaWxpdGllcyh2dWxuZXJhYmlsaXRpZXMpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYWRkX3Z1bG5lcmFibGVfc29mdHdhcmVzKGRldmljZSwgcGFyc2VkX3Z1bG5lcmFiaWxpdGllcykKICAgICAgICAgICAgICAgICAgICAgICAgZGV2aWNlLnNwb3RsaWdodF92dWxuZXJhYmlsaXRpZXMgPSBwYXJzZWRfdnVsbmVyYWJpbGl0aWVzCiAgICAgICAgICAgICAgICAgICAgICAgIGRldmljZV9yYXcucG9wKCd2dWxuZXJhYmlsaXRpZXMnKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZidQcm9ibGVtIGdldHRpbmcgdnVsbmVyYWJpbGl0aWVzIGZvciB7ZGV2aWNlX3Jhd30nKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGlmIGxlbihzdHIoZGV2aWNlX3JhdykpID4gKDEyICogKDEwMjQgKiogMikpOgogICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2VfcmF3ID0gc3RyKGRldmljZV9yYXcpWzooMTIgKiAoMTAyNCAqKiAyKSldCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZidQcm9ibGVtIHRyaW1taW5nIGRldmljZSByYXcnKQogICAgICAgICAgICAgICAgZGV2aWNlLnNldF9yYXcoZGV2aWNlX3JhdykKICAgICAgICAgICAgICAgIHlpZWxkIGRldmljZQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ1Byb2JsZW0gd2l0aCBmZXRjaGluZyBDcm93ZFN0cmlrZSBEZXZpY2Uge2RldmljZV9yYXd9JykKCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiBhZGFwdGVyX3Byb3BlcnRpZXMoY2xzKToKICAgICAgICByZXR1cm4gW0FkYXB0ZXJQcm9wZXJ0eS5BZ2VudCwgQWRhcHRlclByb3BlcnR5LkVuZHBvaW50X1Byb3RlY3Rpb25fUGxhdGZvcm1dCgogICAgQGNsYXNzbWV0aG9kCiAgICBkZWYgX2RiX2NvbmZpZ19zY2hlbWEoY2xzKSAtPiBkaWN0OgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdpdGVtcyc6IFsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAnbmFtZSc6ICdnZXRfcG9saWNpZXMnLAogICAgICAgICAgICAgICAgICAgICd0aXRsZSc6ICdHZXQgZGV2aWNlcyBwb2xpY2llcycsCiAgICAgICAgICAgICAgICAgICAgJ3R5cGUnOiAnYm9vbCcKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgJ25hbWUnOiAnZ2V0X3Z1bG5lcmFiaWxpdGllcycsCiAgICAgICAgICAgICAgICAgICAgJ3RpdGxlJzogJ0dldCBkZXZpY2VzIHZ1bG5lcmFiaWxpdGllcycsCiAgICAgICAgICAgICAgICAgICAgJ3R5cGUnOiAnYm9vbCcKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgJ25hbWUnOiAnbWFjaGluZV9kb21haW5fd2hpdGVsaXN0JywKICAgICAgICAgICAgICAgICAgICAndGl0bGUnOiAnTWFjaGluZSBkb21haW4gd2hpdGVsaXN0JywKICAgICAgICAgICAgICAgICAgICAndHlwZSc6ICdzdHJpbmcnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICduYW1lJzogJ2dyb3VwX25hbWVfd2hpdGVsaXN0JywKICAgICAgICAgICAgICAgICAgICAndGl0bGUnOiAnR3JvdXAgbmFtZSB3aGl0ZWxpc3QnLAogICAgICAgICAgICAgICAgICAgICd0eXBlJzogJ3N0cmluZycKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgXSwKICAgICAgICAgICAgJ3JlcXVpcmVkJzogWwogICAgICAgICAgICAgICAgJ2dldF9wb2xpY2llcycsCiAgICAgICAgICAgICAgICAnZ2V0X3Z1bG5lcmFiaWxpdGllcycKICAgICAgICAgICAgXSwKICAgICAgICAgICAgJ3ByZXR0eV9uYW1lJzogJ0Nyb3dkU3RyaWtlIEZhbGNvbiBDb25maWd1cmF0aW9uJywKICAgICAgICAgICAgJ3R5cGUnOiAnYXJyYXknCiAgICAgICAgfQoKICAgIEBjbGFzc21ldGhvZAogICAgZGVmIF9kYl9jb25maWdfZGVmYXVsdChjbHMpOgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdnZXRfcG9saWNpZXMnOiBGYWxzZSwKICAgICAgICAgICAgJ2dldF92dWxuZXJhYmlsaXRpZXMnOiBGYWxzZSwKICAgICAgICAgICAgJ21hY2hpbmVfZG9tYWluX3doaXRlbGlzdCc6IE5vbmUsCiAgICAgICAgICAgICdncm91cF9uYW1lX3doaXRlbGlzdCc6IE5vbmUKICAgICAgICB9CgogICAgZGVmIF9vbl9jb25maWdfdXBkYXRlKHNlbGYsIGNvbmZpZyk6CiAgICAgICAgc2VsZi5fZ2V0X3BvbGljaWVzID0gY29uZmlnWydnZXRfcG9saWNpZXMnXQogICAgICAgIHNlbGYuX2dldF92dWxuZXJhYmlsaXRpZXMgPSBjb25maWdbJ2dldF92dWxuZXJhYmlsaXRpZXMnXQogICAgICAgIHNlbGYuX19tYWNoaW5lX2RvbWFpbl93aGl0ZWxpc3QgPSBbeC5sb3dlcigpIGZvciB4IGluIGNvbmZpZy5nZXQoJ21hY2hpbmVfZG9tYWluX3doaXRlbGlzdCcpLnNwbGl0KCcsJyldIFwKICAgICAgICAgICAgaWYgY29uZmlnLmdldCgnbWFjaGluZV9kb21haW5fd2hpdGVsaXN0JykgZWxzZSBOb25lCiAgICAgICAgc2VsZi5fX2dyb3VwX25hbWVfd2hpdGVsaXN0ID0gY29uZmlnLmdldCgnZ3JvdXBfbmFtZV93aGl0ZWxpc3QnKS5zcGxpdCgnLCcpIFwKICAgICAgICAgICAgaWYgY29uZmlnLmdldCgnZ3JvdXBfbmFtZV93aGl0ZWxpc3QnKSBlbHNlIE5vbmUK',
}

ADAPTERS_TO_RESTART = ['crowd_strike']

COMMANDS_TO_RUN = []


def main():
    print(f'Updating CrowdStrike 2020-05-20')

    # assert current client
    cs = core_service.CoreService()
    print(f'Current client {cs.node_id}')

    # 1. Backup original
    try:
        for path_to_update in FILES_TO_UPDATE.keys():
            bak_path = f'{path_to_update}.bak'
            if os.path.exists(bak_path):
                os.unlink(bak_path)

        for path_to_update in FILES_TO_UPDATE.keys():
            os.rename(path_to_update, f'{path_to_update}.bak')
    except Exception:
        pass

    # 2. write new files
    for path_to_update, b64_contents in FILES_TO_UPDATE.items():
        with open(path_to_update, 'wb') as f:
            f.write(base64.b64decode(b64_contents))

    # 3. Restart adapters
    for adapter_name in ADAPTERS_TO_RESTART:
        restart_command = f'./se.sh re {adapter_name}'
        for i in range(5):
            try:
                print(f'running {restart_command}')
                subprocess.check_call(restart_command, shell=True, cwd=CORTEX)
                print(f'{restart_command} succeeded on trial {i}')
                break
            except Exception:
                print(f'{restart_command} on trial {i}')
                time.sleep(5)

    # 4. Restart GUI
    try:
        for command in COMMANDS_TO_RUN:
            print(f'Running {command}')
            subprocess.check_call(command, shell=True)
            print(f'Done running {command}')
    except Exception as e:
        print(f'An error has occurred, please proceed manually: {str(e)}')

    print(f'Done!')
    return 0


if __name__ == '__main__':
    sys.exit(main())
