import sys
import subprocess
import base64
import os

CONNECTION_PY_B64 = b'aW1wb3J0IGxvZ2dpbmcKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUsIHRpbWVkZWx0YQpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgTGlzdAoKaW1wb3J0IGFkYWwKZnJvbSBheG9uaXVzLmNsaWVudHMucmVzdC5jb25uZWN0aW9uIGltcG9ydCBSRVNUQ29ubmVjdGlvbgpmcm9tIGF4b25pdXMuY2xpZW50cy5yZXN0LmV4Y2VwdGlvbiBpbXBvcnQgUkVTVEV4Y2VwdGlvbgoKbG9nZ2VyID0gbG9nZ2luZy5nZXRMb2dnZXIoZidheG9uaXVzLntfX25hbWVfX30nKQoKCkFVVEhPUklUWV9IT1NUX1VSTCA9ICdodHRwczovL2xvZ2luLm1pY3Jvc29mdG9ubGluZS5jb20nCkdSQVBIX0FQSV9VUkwgPSAnaHR0cHM6Ly9ncmFwaC5taWNyb3NvZnQuY29tJwpBWlVSRV9BRF9HUkFQSF9BUElfVVJMID0gJ2h0dHBzOi8vZ3JhcGgud2luZG93cy5uZXQnICAgICMgbGVnYWN5IGFwaSByZXF1aXJlZCBmb3IgYXp1cmUgYWQgYjJjClRFTVBMQVRFX0FVVEhaX1VSTCA9ICdodHRwczovL2xvZ2luLndpbmRvd3MubmV0L3t0ZW5hbnRfaWR9L29hdXRoMi9hdXRob3JpemU/cmVzcG9uc2VfdHlwZT1jb2RlJmNsaWVudF9pZD17Y2xpZW50X2lkfScgXAogICAgICAgICAgICAgICAgICAgICAnJnJlZGlyZWN0X3VyaT1odHRwczovL2xvY2FsaG9zdCZzdGF0ZT1hZnRlci1hdXRoJnJlc291cmNlPWh0dHBzOi8vZ3JhcGgubWljcm9zb2Z0LmNvbScgXAogICAgICAgICAgICAgICAgICAgICAnJnByb21wdD1hZG1pbl9jb25zZW50JwpERUZBVUxUX0VYUElSQVRJT05fSU5fU0VDT05EUyA9IDYwICogMjAgICAgICMgMjAgbWluCk1BWF9QQUdFX05VTV9UT19BVk9JRF9JTkZJTklURV9MT09QID0gMjAwMDAKTE9HX0RFVklDRVNfQ09VTlQgPSA1MApVU0VSU19BVFRSSUJVVEVTID0gWwogICAgJ2FjY291bnRFbmFibGVkJywKICAgICdjaXR5JywKICAgICdjb3VudHJ5JywKICAgICdkZXBhcnRtZW50JywKICAgICdkaXNwbGF5TmFtZScsCiAgICAnZ2l2ZW5OYW1lJywKICAgICdzdXJuYW1lJywKICAgICdpZCcsCiAgICAnam9iVGl0bGUnLAogICAgJ21haWwnLAogICAgJ21vYmlsZVBob25lJywKICAgICdvblByZW1pc2VzRG9tYWluTmFtZScsCiAgICAnb25QcmVtaXNlc1NhbUFjY291bnROYW1lJywKICAgICdvblByZW1pc2VzU2VjdXJpdHlJZGVudGlmaWVyJywKICAgICdvblByZW1pc2VzVXNlclByaW5jaXBhbE5hbWUnLAogICAgJ29uUHJlbWlzZXNTeW5jRW5hYmxlZCcsCiAgICAnb25QcmVtaXNlc0ltbXV0YWJsZUlkJywKICAgICdvblByZW1pc2VzTGFzdFN5bmNEYXRlVGltZScsCiAgICAnc3RyZWV0QWRkcmVzcycsCiAgICAncGFzc3dvcmRQb2xpY2llcycsCiAgICAndXNlclByaW5jaXBhbE5hbWUnCl0KCkRFVklDRV9BVFRSSUJVVEVTID0gWwogICAgJ2FjY291bnRFbmFibGVkJywKICAgICdhcHByb3hpbWF0ZUxhc3RTaWduSW5EYXRlVGltZScsCiAgICAnZGV2aWNlSWQnLAogICAgJ2Rpc3BsYXlOYW1lJywKICAgICdpZCcsCiAgICAnaXNDb21wbGlhbnQnLAogICAgJ2lzTWFuYWdlZCcsCiAgICAnb25QcmVtaXNlc0xhc3RTeW5jRGF0ZVRpbWUnLAogICAgJ29uUHJlbWlzZXNTeW5jRW5hYmxlZCcsCiAgICAnb3BlcmF0aW5nU3lzdGVtJywKICAgICdvcGVyYXRpbmdTeXN0ZW1WZXJzaW9uJywKICAgICd0cnVzdFR5cGUnCl0KCgojIHB5bGludDogZGlzYWJsZT1sb2dnaW5nLWZvcm1hdC1pbnRlcnBvbGF0aW9uCmNsYXNzIEF6dXJlQWRDbGllbnQoUkVTVENvbm5lY3Rpb24pOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNsaWVudF9pZCwgY2xpZW50X3NlY3JldCwgdGVuYW50X2lkLCAqYXJncywgaXNfYXp1cmVfYWRfYjJjPU5vbmUsICoqa3dhcmdzKToKICAgICAgICBzZWxmLl9jbGllbnRfaWQgPSBjbGllbnRfaWQKICAgICAgICBzZWxmLl9jbGllbnRfc2VjcmV0ID0gY2xpZW50X3NlY3JldAogICAgICAgIHNlbGYuX3RlbmFudF9pZCA9IHRlbmFudF9pZAogICAgICAgIHNlbGYuX3JlZnJlc2hfdG9rZW4gPSBOb25lCiAgICAgICAgc2VsZi5faXNfYXp1cmVfYWRfYjJjID0gaXNfYXp1cmVfYWRfYjJjCiAgICAgICAgbG9nZ2VyLmluZm8oZidDcmVhdGluZyBBenVyZSBBRCB3aXRoIHRlbmFudCB7dGVuYW50X2lkfSBhbmQgY2xpZW50IGlkIHtjbGllbnRfaWR9LiAnCiAgICAgICAgICAgICAgICAgICAgZidCMkM6IHtib29sKGlzX2F6dXJlX2FkX2IyYyl9JykKICAgICAgICBpZiBpc19henVyZV9hZF9iMmM6CiAgICAgICAgICAgIHNlbGYuX2FwaV9lbmRwb2ludCA9IEFaVVJFX0FEX0dSQVBIX0FQSV9VUkwKICAgICAgICAgICAgc3VwZXIoKS5fX2luaXRfXyhkb21haW49QVpVUkVfQURfR1JBUEhfQVBJX1VSTCwgdXJsX2Jhc2VfcHJlZml4PWYnL3tzZWxmLl90ZW5hbnRfaWR9JywgKmFyZ3MsICoqa3dhcmdzKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuX2FwaV9lbmRwb2ludCA9IEdSQVBIX0FQSV9VUkwKICAgICAgICAgICAgc3VwZXIoKS5fX2luaXRfXyhkb21haW49R1JBUEhfQVBJX1VSTCwgdXJsX2Jhc2VfcHJlZml4PScvdjEuMCcsICphcmdzLCAqKmt3YXJncykKCiAgICBkZWYgc2V0X3JlZnJlc2hfdG9rZW4oc2VsZiwgcmVmcmVzaF90b2tlbik6CiAgICAgICAgc2VsZi5fcmVmcmVzaF90b2tlbiA9IHJlZnJlc2hfdG9rZW4KCiAgICBkZWYgZ2V0X3JlZnJlc2hfdG9rZW5fZnJvbV9hdXRob3JpemF0aW9uX2NvZGUoc2VsZiwgYXV0aG9yaXphdGlvbl9jb2RlKToKICAgICAgICBjb250ZXh0ID0gYWRhbC5BdXRoZW50aWNhdGlvbkNvbnRleHQoZid7QVVUSE9SSVRZX0hPU1RfVVJMfS97c2VsZi5fdGVuYW50X2lkfScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3hpZXM9c2VsZi5fcHJveGllcywgdmVyaWZ5X3NzbD1zZWxmLl92ZXJpZnlfc3NsKQogICAgICAgIGFuc3dlciA9IGNvbnRleHQuYWNxdWlyZV90b2tlbl93aXRoX2F1dGhvcml6YXRpb25fY29kZSgKICAgICAgICAgICAgYXV0aG9yaXphdGlvbl9jb2RlLAogICAgICAgICAgICAnaHR0cHM6Ly9sb2NhbGhvc3QnLAogICAgICAgICAgICBzZWxmLl9hcGlfZW5kcG9pbnQsCiAgICAgICAgICAgIHNlbGYuX2NsaWVudF9pZCwKICAgICAgICAgICAgc2VsZi5fY2xpZW50X3NlY3JldAogICAgICAgICkKCiAgICAgICAgaWYgJ3JlZnJlc2hUb2tlbicgbm90IGluIGFuc3dlcjoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmJ0F1dGhlbnRpY2F0aW9uIGVycm9yOiB7YW5zd2VyfScpCgogICAgICAgIHJldHVybiBhbnN3ZXJbJ3JlZnJlc2hUb2tlbiddCgogICAgZGVmIF9jb25uZWN0KHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgY29udGV4dCA9IGFkYWwuQXV0aGVudGljYXRpb25Db250ZXh0KGYne0FVVEhPUklUWV9IT1NUX1VSTH0ve3NlbGYuX3RlbmFudF9pZH0nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJveGllcz1zZWxmLl9wcm94aWVzLCB2ZXJpZnlfc3NsPXNlbGYuX3ZlcmlmeV9zc2wpCiAgICAgICAgICAgIGlmIHNlbGYuX3JlZnJlc2hfdG9rZW46CiAgICAgICAgICAgICAgICB0b2tlbl9hbnN3ZXIgPSBjb250ZXh0LmFjcXVpcmVfdG9rZW5fd2l0aF9yZWZyZXNoX3Rva2VuKAogICAgICAgICAgICAgICAgICAgIHNlbGYuX3JlZnJlc2hfdG9rZW4sCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2xpZW50X2lkLAogICAgICAgICAgICAgICAgICAgIHNlbGYuX2FwaV9lbmRwb2ludCwKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jbGllbnRfc2VjcmV0CiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB0b2tlbl9hbnN3ZXIgPSBjb250ZXh0LmFjcXVpcmVfdG9rZW5fd2l0aF9jbGllbnRfY3JlZGVudGlhbHMoCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fYXBpX2VuZHBvaW50LAogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NsaWVudF9pZCwKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jbGllbnRfc2VjcmV0KQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oJ0F1dGhvcml6YXRpb24gVVJMIGZvciBvYXV0aDogezB9Jy5mb3JtYXQoCiAgICAgICAgICAgICAgICAgICAgVEVNUExBVEVfQVVUSFpfVVJMLmZvcm1hdCh0ZW5hbnRfaWQ9c2VsZi5fdGVuYW50X2lkLCBjbGllbnRfaWQ9c2VsZi5fY2xpZW50X2lkKQogICAgICAgICAgICAgICAgKSkKCiAgICAgICAgICAgIGlmICdhY2Nlc3NUb2tlbicgbm90IGluIHRva2VuX2Fuc3dlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmJ0Vycm9yIGF1dGhlbnRpY2F0aW5nLCByZXNwb25zZSBpcyB7dG9rZW5fYW5zd2VyfScpCiAgICAgICAgICAgICAgICByYWlzZSBSRVNURXhjZXB0aW9uKGYnQXV0aCBlcnJvcicpCgogICAgICAgICAgICAjIFRoaXMgdG9rZW4gaGFzIGV4cGlyYXRpb24gZGF0ZQogICAgICAgICAgICBzZWxmLl9hY2Nlc3NfdG9rZW4gPSB0b2tlbl9hbnN3ZXJbJ2FjY2Vzc1Rva2VuJ10KICAgICAgICAgICAgc2VsZi5fYWNjZXNzX3Rva2VuX2V4cGlyZXNfaW4gPSBpbnQodG9rZW5fYW5zd2VyLmdldCgnZXhwaXJlc0luJykgb3IgREVGQVVMVF9FWFBJUkFUSU9OX0lOX1NFQ09ORFMpCiAgICAgICAgICAgIHNlbGYuX3Rva2VuX2V4cGlyZXNfZGF0ZSA9IGRhdGV0aW1lLm5vdygpICsgdGltZWRlbHRhKHNlY29uZHM9c2VsZi5fYWNjZXNzX3Rva2VuX2V4cGlyZXNfaW4pCgogICAgICAgICAgICBzZWxmLl9zZXNzaW9uX2hlYWRlcnMgPSB7J0F1dGhvcml6YXRpb24nOiBmJ0JlYXJlciB7c2VsZi5fYWNjZXNzX3Rva2VufSd9CiAgICAgICAgZXhjZXB0IGFkYWwuYWRhbF9lcnJvci5BZGFsRXJyb3IgYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ0Vycm9yIGdldHRpbmcgdG9rZW4nKQoKICAgICAgICAgICAgaWYgJ2Vycm9yIHZhbGlkYXRpbmcgY3JlZGVudGlhbHMnIGluIHN0cihlKS5sb3dlcigpOgogICAgICAgICAgICAgICAgcmFpc2UgUkVTVEV4Y2VwdGlvbihmJ0Vycm9yIHZhbGlkYXRpbmcgY3JlZGVudGlhbHMnKQogICAgICAgICAgICBpZiAnd2FzIG5vdCBmb3VuZCBpbiB0aGUgZGlyZWN0b3J5JyBpbiBzdHIoZSkubG93ZXIoKToKICAgICAgICAgICAgICAgIHJhaXNlIFJFU1RFeGNlcHRpb24oZidBcHBsaWNhdGlvbiBJRCB3YXMgbm90IGZvdW5kIGluIHRoZSBkaXJlY3RvcnknKQogICAgICAgICAgICBpZiAnbm90IGZvdW5kLiB0aGlzIG1heSBoYXBwZW4gaWYgdGhlcmUgYXJlIG5vIGFjdGl2ZSBzdWJzY3JpcHRpb25zIGZvciB0aGUgdGVuYW50LicgaW4gc3RyKGUpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICByYWlzZSBSRVNURXhjZXB0aW9uKGYnVGVuYW50IElEIHtzZWxmLl90ZW5hbnRfaWR9IG5vdCBmb3VuZCcpCiAgICAgICAgICAgIHJhaXNlCgogICAgZGVmIF9yZW5ld190b2tlbl9pZl9uZWVkZWQoc2VsZik6CiAgICAgICAgaWYgZGF0ZXRpbWUubm93KCkgPj0gc2VsZi5fdG9rZW5fZXhwaXJlc19kYXRlOgogICAgICAgICAgICBzZWxmLl9jb25uZWN0KCkKCiAgICBkZWYgX2dldChzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgICAgIHNlbGYuX3JlbmV3X3Rva2VuX2lmX25lZWRlZCgpCiAgICAgICAgcmV0dXJuIHN1cGVyKCkuX2dldCgqYXJncywgKiprd2FyZ3MpCgogICAgZGVmIF9wYWdlZF9nZXQoc2VsZiwgcmVzb3VyY2UpOgogICAgICAgICMgVGFrZSBjYXJlIG9mIHBhZ2luZyBnZW5lcmljYWxseTogaHR0cHM6Ly9kZXZlbG9wZXIubWljcm9zb2Z0LmNvbS9lbi11cy9ncmFwaC9kb2NzL2NvbmNlcHRzL3BhZ2luZwogICAgICAgIHJlc3VsdCA9IHNlbGYuX2dldChyZXNvdXJjZSkKICAgICAgICB5aWVsZCBmcm9tIHJlc3VsdFsndmFsdWUnXQoKICAgICAgICBwYWdlX251bSA9IDEKICAgICAgICB3aGlsZSAnQG9kYXRhLm5leHRMaW5rJyBpbiByZXN1bHQgYW5kIHBhZ2VfbnVtIDwgTUFYX1BBR0VfTlVNX1RPX0FWT0lEX0lORklOSVRFX0xPT1A6CiAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYuX2dldChyZXN1bHRbJ0BvZGF0YS5uZXh0TGluayddLCBmb3JjZV9mdWxsX3VybD1UcnVlKQogICAgICAgICAgICB5aWVsZCBmcm9tIHJlc3VsdFsndmFsdWUnXQogICAgICAgICAgICBwYWdlX251bSArPSAxCgogICAgZGVmIGdldF9pbnN0YWxsZWRfYXBwcyhzZWxmKSAtPiBEaWN0W3N0ciwgTGlzdFtEaWN0XV06CiAgICAgICAgIiIiCiAgICAgICAgR2V0IGluc3RhbGxlZCBhcHBzIG9uIGF6dXJlIEludHVuZS4KICAgICAgICBmaXJzdCByZXF1ZXN0IGlzIGZvciBkZXZpY2VNYW5hZ2VtZW50L2RldGVjdGVkQXBwcyBmb3IgZ2V0dGluZyBhcHAgZGF0YQogICAgICAgIHRoZSBuZXh0IHJlcXVlc3QgaXMgZm9yIGRldmljZU1hbmFnZW1lbnQvZGV0ZWN0ZWRBcHBzL3thcHBfaWR9L21hbmFnZWREZXZpY2VzCiAgICAgICAgZm9yIGdldHRpbmcgZGV2aWNlcyB0aGF0IGhhdmUgdGhpcyBhcHAgaW5zdGFsbGVkIG9uIHRoZW0uCiAgICAgICAgc28gdGhlIGJlc3QgdGhpbmcgdG8gZG8gaXMgc2F2ZSBhIGRpY3QgY29udGFpbmluZyBkZXZpY2VzIGlkcyBhbmQgdGhlaXIgaW5zdGFsbGVkIGFwcHMuCiAgICAgICAgOnJldHVybjpkaWN0IG9mIGRldmljZXMgYW5kIHRoZWlyIGFwcHMsIGZvciBleGFtcGxlOiBkZXZpY2VzX2FwcHNbREVWSUNFX0lEXSA9IFt7YXBwX2RhdGF9LCAuLl0KICAgICAgICAiIiIKICAgICAgICBkZXZpY2VzX2FwcHMgPSB7fQogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oJ0dldHRpbmcgSW5zdGFsbGVkIEFwcHMnKQogICAgICAgICAgICBhcHBzX2dvdCA9IDAKICAgICAgICAgICAgZm9yIGFwcF9yYXcgaW4gc2VsZi5fcGFnZWRfZ2V0KCdkZXZpY2VNYW5hZ2VtZW50L2RldGVjdGVkQXBwcycpOgogICAgICAgICAgICAgICAgYXBwX2lkID0gYXBwX3Jhdy5nZXQoJ2lkJykKICAgICAgICAgICAgICAgIGlmIG5vdCBhcHBfaWQ6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGZvciBkZXZpY2VfcmF3IGluIHNlbGYuX3BhZ2VkX2dldChmJ2RldmljZU1hbmFnZW1lbnQvZGV0ZWN0ZWRBcHBzL3thcHBfaWR9L21hbmFnZWREZXZpY2VzJyk6CiAgICAgICAgICAgICAgICAgICAgZGV2aWNlX2lkID0gZGV2aWNlX3Jhdy5nZXQoJ2lkJykKICAgICAgICAgICAgICAgICAgICBpZiBub3QgZGV2aWNlX2lkOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIGRldmljZXNfYXBwcy5zZXRkZWZhdWx0KGRldmljZV9pZCwgW10pLmFwcGVuZChhcHBfcmF3KQogICAgICAgICAgICAgICAgYXBwc19nb3QgKz0gMQogICAgICAgICAgICAgICAgaWYgYXBwc19nb3QgJSBMT0dfREVWSUNFU19DT1VOVCA9PSAwOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYnR290IHthcHBzX2dvdH0gaW5zdGFsbGVkIGFwcHMnKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oJ0NhbnQgZ2V0IEludHVuZSBpbnN0YWxsZWQgYXBwcycpCiAgICAgICAgcmV0dXJuIGRldmljZXNfYXBwcwoKICAgIGRlZiBnZXRfZGV2aWNlX2xpc3Qoc2VsZik6CiAgICAgICAgaWYgc2VsZi5faXNfYXp1cmVfYWRfYjJjOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmJ0F6dXJlIEFEIEIyQzogTm90IHlpZWxkaW5nIGRldmllY3MnKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBmb3IgZGV2aWNlX3JhdyBpbiBzZWxmLl9wYWdlZF9nZXQoZidkZXZpY2VzPyRzZWxlY3Q9eyIsIi5qb2luKERFVklDRV9BVFRSSUJVVEVTKX0nKToKICAgICAgICAgICAgeWllbGQgZGV2aWNlX3JhdywgJ0F6dXJlIEFEJwogICAgICAgIHRyeToKICAgICAgICAgICAgZGV2aWNlc19hcHBzID0gc2VsZi5nZXRfaW5zdGFsbGVkX2FwcHMoKQogICAgICAgICAgICBmb3IgZGV2aWNlX3JhdyBpbiBzZWxmLl9wYWdlZF9nZXQoZidkZXZpY2VNYW5hZ2VtZW50L21hbmFnZWREZXZpY2VzJyk6CiAgICAgICAgICAgICAgICBkZXZfaWQgPSBkZXZpY2VfcmF3LmdldCgnaWQnKQogICAgICAgICAgICAgICAgaW5zdGFsbGVkX2FwcHMgPSBkZXZpY2VzX2FwcHMuZ2V0KGRldl9pZCkgaWYgZGV2aWNlc19hcHBzLmdldChkZXZfaWQpIGVsc2UgW10KICAgICAgICAgICAgICAgIGRldmljZV9yYXdbJ2luc3RhbGxlZF9hcHBzJ10gPSBpbnN0YWxsZWRfYXBwcwogICAgICAgICAgICAgICAgeWllbGQgZGV2aWNlX3JhdywgJ0ludHVuZScKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGYnQ2FudCBnZXQgSW50dW5lJykKCiAgICBkZWYgZ2V0X3VzZXJfbGlzdChzZWxmKToKICAgICAgICBpZiBzZWxmLl9pc19henVyZV9hZF9iMmM6CiAgICAgICAgICAgIHlpZWxkIGZyb20gc2VsZi5fcGFnZWRfZ2V0KGYndXNlcnM/YXBpLXZlcnNpb249MS42JykKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIFdlIGhhdmUgdG8gc3BlY2lmeSB0aGUgYXR0cmlidXRlcywgIioiIGlzIG5vdCBzdXBwb3J0ZWQuCiAgICAgICAgICAgIHlpZWxkIGZyb20gc2VsZi5fcGFnZWRfZ2V0KGYndXNlcnM/JHNlbGVjdD17IiwiLmpvaW4oVVNFUlNfQVRUUklCVVRFUyl9JykKCiAgICBkZWYgdGVzdF9jb25uZWN0aW9uKHNlbGYpOgogICAgICAgIHNlbGYuY29ubmVjdCgpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzZWxmLl9pc19henVyZV9hZF9iMmM6CiAgICAgICAgICAgICAgICBmb3IgXyBpbiBzZWxmLl9wYWdlZF9nZXQoZid1c2Vycz9hcGktdmVyc2lvbj0xLjYnKToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZm9yIF8gaW4gc2VsZi5fcGFnZWRfZ2V0KGYnZGV2aWNlcz8kdG9wPTEnKToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgaWYgJ2luc3VmZmljaWVudCBwcml2aWxlZ2VzIHRvIGNvbXBsZXRlIHRoZSBvcGVyYXRpb24nIGluIHN0cihlKS5sb3dlcigpOgogICAgICAgICAgICAgICAgcmFpc2UgUkVTVEV4Y2VwdGlvbihmJ0luc3VmZmljaWVudCBwZXJtaXNzaW9ucy4gRGlkIHlvdSBncmFudCB0aGlzIGFwcGxpY2F0aW9uICcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZidHcmFwaCBBUEkgcmVhZG9ubHkgcGVybWlzc2lvbnM/JykKICAgICAgICAgICAgcmFpc2UK'
SERVICE_PY_B64 = b'aW1wb3J0IGRhdGV0aW1lCmltcG9ydCBsb2dnaW5nCgpmcm9tIGF4b25pdXMuYWRhcHRlcl9iYXNlIGltcG9ydCBBZGFwdGVyQmFzZSwgQWRhcHRlclByb3BlcnR5CmZyb20gYXhvbml1cy5hZGFwdGVyX2V4Y2VwdGlvbnMgaW1wb3J0IENsaWVudENvbm5lY3Rpb25FeGNlcHRpb24KZnJvbSBheG9uaXVzLmNsaWVudHMucmVzdC5jb25uZWN0aW9uIGltcG9ydCBSRVNUQ29ubmVjdGlvbgpmcm9tIGF4b25pdXMuZGV2aWNlcy5hZF9lbnRpdHkgaW1wb3J0IEFERW50aXR5CmZyb20gYXhvbml1cy5kZXZpY2VzLmRldmljZV9hZGFwdGVyIGltcG9ydCBEZXZpY2VBZGFwdGVyCmZyb20gYXhvbml1cy5maWVsZHMgaW1wb3J0IEZpZWxkCmZyb20gYXhvbml1cy51c2Vycy51c2VyX2FkYXB0ZXIgaW1wb3J0IFVzZXJBZGFwdGVyCmZyb20gYXhvbml1cy51dGlscy5maWxlcyBpbXBvcnQgZ2V0X2xvY2FsX2NvbmZpZ19maWxlCmZyb20gYXhvbml1cy51dGlscy5kYXRldGltZSBpbXBvcnQgcGFyc2VfZGF0ZQpmcm9tIGF6dXJlX2FkX2FkYXB0ZXIuY29ubmVjdGlvbiBpbXBvcnQgQVVUSE9SSVRZX0hPU1RfVVJMLCBBenVyZUFkQ2xpZW50Cgpsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcihmJ2F4b25pdXMue19fbmFtZV9ffScpCgoKQVpVUkVfQ0xJRU5UX0lEID0gJ2NsaWVudF9pZCcKQVpVUkVfQ0xJRU5UX1NFQ1JFVCA9ICdjbGllbnRfc2VjcmV0JwpBWlVSRV9URU5BTlRfSUQgPSAndGVuYW50X2lkJwpBWlVSRV9WRVJJRllfU1NMID0gJ3ZlcmlmeV9zc2wnCkFaVVJFX0FVVEhPUklaQVRJT05fQ09ERSA9ICdhdXRob3JpemF0aW9uX2NvZGUnCgoKIyBweWxpbnQ6IGRpc2FibGU9aW52YWxpZC1uYW1lLHRvby1tYW55LWluc3RhbmNlLWF0dHJpYnV0ZXMsYXJndW1lbnRzLWRpZmZlcgpjbGFzcyBBenVyZUFkQWRhcHRlcihBZGFwdGVyQmFzZSk6CiAgICBjbGFzcyBNeURldmljZUFkYXB0ZXIoRGV2aWNlQWRhcHRlcik6CiAgICAgICAgYWNjb3VudF90YWcgPSBGaWVsZChzdHIsICdBY2NvdW50IFRhZycpCiAgICAgICAgYXp1cmVfZGV2aWNlX2lkID0gRmllbGQoc3RyLCAnQXp1cmUgRGV2aWNlIElEJykKICAgICAgICBhenVyZV9kaXNwbGF5X25hbWUgPSBGaWVsZChzdHIsICdBenVyZSBEaXNwbGF5IE5hbWUnKQogICAgICAgIGF6dXJlX2lzX2NvbXBsaWFudCA9IEZpZWxkKGJvb2wsICdBenVyZSBJcyBDb21wbGlhbnQnKQogICAgICAgIGF6dXJlX2lzX21hbmFnZWQgPSBGaWVsZChib29sLCAnQXp1cmUgSXMgTWFuYWdlZCcpCiAgICAgICAgYWRfb25fcHJlbWlzZV9sYXN0X3N5bmNfZGF0ZV90aW1lID0gRmllbGQoZGF0ZXRpbWUuZGF0ZXRpbWUsICdPbiBQcmVtaXNlIExhc3QgU3luYyBEYXRlIFRpbWUnKQogICAgICAgIGFkX29uX3ByZW1pc2Vfc3luY19lbmFibGVkID0gRmllbGQoYm9vbCwgJ09uIFByZW1pc2UgU3luYyBFbmFibGVkJykKICAgICAgICBhZF9vbl9wcmVtaXNlX3RydXN0X3R5cGUgPSBGaWVsZChzdHIsICdBenVyZSBPbiBQcmVtaXNlIFRydXN0IFR5cGUnKQogICAgICAgIGFuZHJvaWRfc2VjdXJpdHlfcGF0Y2hfbGV2ZWwgPSBGaWVsZChzdHIsICdBbmRyb2lkIFNlY3VyaXR5IFBhdGNoIExldmVsJykKICAgICAgICBwaG9uZV9udW1iZXIgPSBGaWVsZChzdHIsICdQaG9uZSBOdW1iZXInKQogICAgICAgIGltZWkgPSBGaWVsZChzdHIsICdJTUVJJykKICAgICAgICBpc19lbmNyeXB0ZWQgPSBGaWVsZChib29sLCAnSXMgRW5jcnlwdGVkJykKICAgICAgICB1c2VyX3ByaW5jaXBhbF9uYW1lID0gRmllbGQoc3RyLCAnVXNlciBQcmluY2lwYWwgTmFtZScpCiAgICAgICAgbWFuYWdlZF9kZXZpY2VfbmFtZSA9IEZpZWxkKHN0ciwgJ01hbmFnZWQgRGV2aWNlIE5hbWUnKQogICAgICAgIGF6dXJlX2FkX2lkID0gRmllbGQoc3RyKQogICAgICAgIGxhc3Rfc2lnbl9pbiA9IEZpZWxkKGRhdGV0aW1lLmRhdGV0aW1lLCAnQXBwcm94aW1hdGUgTGFzdCBTaWduSW4gVGltZScpCgogICAgY2xhc3MgTXlVc2VyQWRhcHRlcihVc2VyQWRhcHRlciwgQURFbnRpdHkpOgogICAgICAgIGFjY291bnRfdGFnID0gRmllbGQoc3RyLCAnQWNjb3VudCBUYWcnKQogICAgICAgIGFkX29uX3ByZW1pc2VfaW1tdXRhYmxlX2lkID0gRmllbGQoc3RyLCAnT24gUHJlbWlzZSBJbW11dGFibGUgSUQnKQogICAgICAgIGFkX29uX3ByZW1pc2Vfc3luY19lbmFibGVkID0gRmllbGQoYm9vbCwgJ09uIFByZW1pc2UgU3luYyBFbmFibGVkJykKICAgICAgICBhZF9vbl9wcmVtaXNlX2xhc3Rfc3luY19kYXRlX3RpbWUgPSBGaWVsZChkYXRldGltZS5kYXRldGltZSwgJ09uIFByZW1pc2UgTGFzdCBTeW5jIERhdGUgVGltZSknKQoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKGdldF9sb2NhbF9jb25maWdfZmlsZShfX2ZpbGVfXykpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9nZXRfY2xpZW50X2lkKGNsaWVudF9jb25maWcpOgogICAgICAgIHJldHVybiBjbGllbnRfY29uZmlnW0FaVVJFX1RFTkFOVF9JRF0KCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX3Rlc3RfcmVhY2hhYmlsaXR5KGNsaWVudF9jb25maWcpOgogICAgICAgIHJldHVybiBSRVNUQ29ubmVjdGlvbi50ZXN0X3JlYWNoYWJpbGl0eShBVVRIT1JJVFlfSE9TVF9VUkwpCgogICAgZGVmIF9jb25uZWN0X2NsaWVudChzZWxmLCBjbGllbnRfY29uZmlnKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbm5lY3Rpb24gPSBBenVyZUFkQ2xpZW50KGNsaWVudF9pZD1jbGllbnRfY29uZmlnW0FaVVJFX0NMSUVOVF9JRF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsaWVudF9zZWNyZXQ9Y2xpZW50X2NvbmZpZ1tBWlVSRV9DTElFTlRfU0VDUkVUXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVuYW50X2lkPWNsaWVudF9jb25maWdbQVpVUkVfVEVOQU5UX0lEXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cHNfcHJveHk9Y2xpZW50X2NvbmZpZy5nZXQoJ2h0dHBzX3Byb3h5JyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlcmlmeV9zc2w9Y2xpZW50X2NvbmZpZy5nZXQoQVpVUkVfVkVSSUZZX1NTTCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzX2F6dXJlX2FkX2IyYz1jbGllbnRfY29uZmlnLmdldCgnaXNfYXp1cmVfYWRfYjJjJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICBhdXRoX2NvZGUgPSBjbGllbnRfY29uZmlnLmdldChBWlVSRV9BVVRIT1JJWkFUSU9OX0NPREUpCiAgICAgICAgICAgIHJlZnJlc2hfdG9rZW5zX2RiID0gc2VsZi5fZ2V0X2NvbGxlY3Rpb24oJ3JlZnJlc2hfdG9rZW5zJykKICAgICAgICAgICAgcnRfZG9jID0gcmVmcmVzaF90b2tlbnNfZGIuZmluZF9vbmUoeydhdXRoX2NvZGUnOiBhdXRoX2NvZGV9KQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBhdXRoX2NvZGU6CiAgICAgICAgICAgICAgICAgICAgaWYgYXV0aF9jb2RlLnN0YXJ0c3dpdGgoJ3JlZnJlc2gtJyk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2hfdG9rZW4gPSBhdXRoX2NvZGVbbGVuKCdyZWZyZXNoLScpOl0KICAgICAgICAgICAgICAgICAgICBlbGlmIHJ0X2RvYzoKICAgICAgICAgICAgICAgICAgICAgICAgcmVmcmVzaF90b2tlbiA9IHJ0X2RvY1sncmVmcmVzaF90b2tlbiddCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgcmVmcmVzaF90b2tlbiA9IGNvbm5lY3Rpb24uZ2V0X3JlZnJlc2hfdG9rZW5fZnJvbV9hdXRob3JpemF0aW9uX2NvZGUoYXV0aF9jb2RlKQogICAgICAgICAgICAgICAgICAgICAgICAjIGNsaWVudF9jb25maWdbQVpVUkVfQVVUSE9SSVpBVElPTl9DT0RFXSA9ICdyZWZyZXNoLScgKyByZWZyZXNoX3Rva2VuICAjIG92ZXJyaWRlIHJlZnJlc2ggdG9rZW4KICAgICAgICAgICAgICAgICAgICAgICAgcmVmcmVzaF90b2tlbnNfZGIudXBkYXRlX29uZSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsnYXV0aF9jb2RlJzogYXV0aF9jb2RlfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJHNldCc6IHsncmVmcmVzaF90b2tlbic6IHJlZnJlc2hfdG9rZW59CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBzZXJ0PVRydWUKICAgICAgICAgICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uLnNldF9yZWZyZXNoX3Rva2VuKHJlZnJlc2hfdG9rZW4pCgogICAgICAgICAgICAgICAgY29ubmVjdGlvbi50ZXN0X2Nvbm5lY3Rpb24oKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBpZiAnZXhwaXJlZCcgaW4gc3RyKGUpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgcmFpc2UgQ2xpZW50Q29ubmVjdGlvbkV4Y2VwdGlvbihmJ1Rva2VuIGhhcyBleHBpcmVkLiBQbGVhc2UgZm9sbG93IHRoZSBkb2N1bWVudGF0aW9uIHRvICcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYncmUtc2V0IHRoZSB0b2tlbi4gRnVsbCBtZXNzYWdlOiB7c3RyKGUpfScpCiAgICAgICAgICAgICAgICByYWlzZQogICAgICAgICAgICBtZXRhZGF0YV9kaWN0ID0gZGljdCgpCiAgICAgICAgICAgIGlmIGNsaWVudF9jb25maWcuZ2V0KCdhY2NvdW50X3RhZycpOgogICAgICAgICAgICAgICAgbWV0YWRhdGFfZGljdFsnYWNjb3VudF90YWcnXSA9IGNsaWVudF9jb25maWcuZ2V0KCdhY2NvdW50X3RhZycpCiAgICAgICAgICAgIHJldHVybiBjb25uZWN0aW9uLCBtZXRhZGF0YV9kaWN0CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBtZXNzYWdlID0gJ0Vycm9yIGNvbm5lY3RpbmcgdG8gQXp1cmUgQUQgd2l0aCB0ZW5hbnQgaWQgezB9LCByZWFzb246IHsxfScuZm9ybWF0KAogICAgICAgICAgICAgICAgY2xpZW50X2NvbmZpZ1tBWlVSRV9URU5BTlRfSURdLCBzdHIoZSkpCiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZid7c2VsZi5wbHVnaW5fdW5pcXVlX25hbWV9OiB7bWVzc2FnZX0nKQogICAgICAgICAgICByYWlzZSBDbGllbnRDb25uZWN0aW9uRXhjZXB0aW9uKG1lc3NhZ2UpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9xdWVyeV9kZXZpY2VzX2J5X2NsaWVudChjbGllbnRfbmFtZSwgZGF0YSk6CiAgICAgICAgc2Vzc2lvbiwgbWV0YWRhdGEgPSBkYXRhCiAgICAgICAgcmV0dXJuIHNlc3Npb24uZ2V0X2RldmljZV9saXN0KCksIG1ldGFkYXRhCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9xdWVyeV91c2Vyc19ieV9jbGllbnQoY2xpZW50X25hbWUsIGRhdGEpOgogICAgICAgIHNlc3Npb24sIG1ldGFkYXRhID0gZGF0YQogICAgICAgIHJldHVybiBzZXNzaW9uLmdldF91c2VyX2xpc3QoKSwgbWV0YWRhdGEKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX2NsaWVudHNfc2NoZW1hKCk6CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ2l0ZW1zJzogWwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICduYW1lJzogQVpVUkVfQ0xJRU5UX0lELAogICAgICAgICAgICAgICAgICAgICd0aXRsZSc6ICdBenVyZSBDbGllbnQgSUQnLAogICAgICAgICAgICAgICAgICAgICd0eXBlJzogJ3N0cmluZycKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgJ25hbWUnOiBBWlVSRV9DTElFTlRfU0VDUkVULAogICAgICAgICAgICAgICAgICAgICd0aXRsZSc6ICdBenVyZSBDbGllbnQgU2VjcmV0JywKICAgICAgICAgICAgICAgICAgICAndHlwZSc6ICdzdHJpbmcnLAogICAgICAgICAgICAgICAgICAgICdmb3JtYXQnOiAncGFzc3dvcmQnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICduYW1lJzogQVpVUkVfVEVOQU5UX0lELAogICAgICAgICAgICAgICAgICAgICd0aXRsZSc6ICdBenVyZSBUZW5hbnQgSUQnLAogICAgICAgICAgICAgICAgICAgICd0eXBlJzogJ3N0cmluZycKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgJ25hbWUnOiBBWlVSRV9BVVRIT1JJWkFUSU9OX0NPREUsCiAgICAgICAgICAgICAgICAgICAgJ3RpdGxlJzogJ0F6dXJlIE9hdXRoIEF1dGhvcml6YXRpb24gQ29kZScsCiAgICAgICAgICAgICAgICAgICAgJ3R5cGUnOiAnc3RyaW5nJywKICAgICAgICAgICAgICAgICAgICAnZm9ybWF0JzogJ3Bhc3N3b3JkJwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAnbmFtZSc6ICdhY2NvdW50X3RhZycsCiAgICAgICAgICAgICAgICAgICAgJ3RpdGxlJzogJ0FjY291bnQgVGFnJywKICAgICAgICAgICAgICAgICAgICAndHlwZSc6ICdzdHJpbmcnCgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAnbmFtZSc6ICdpc19henVyZV9hZF9iMmMnLAogICAgICAgICAgICAgICAgICAgICd0aXRsZSc6ICdJcyBBenVyZSBBRCBCMkMnLAogICAgICAgICAgICAgICAgICAgICd0eXBlJzogJ2Jvb2wnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICduYW1lJzogJ2h0dHBzX3Byb3h5JywKICAgICAgICAgICAgICAgICAgICAndGl0bGUnOiAnSFRUUFMgUHJveHknLAogICAgICAgICAgICAgICAgICAgICd0eXBlJzogJ3N0cmluZycKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgJ25hbWUnOiBBWlVSRV9WRVJJRllfU1NMLAogICAgICAgICAgICAgICAgICAgICd0aXRsZSc6ICdWZXJpZnkgU1NMJywKICAgICAgICAgICAgICAgICAgICAndHlwZSc6ICdib29sJywKICAgICAgICAgICAgICAgICAgICAnZGVmYXVsdCc6IFRydWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgXSwKICAgICAgICAgICAgJ3JlcXVpcmVkJzogWwogICAgICAgICAgICAgICAgQVpVUkVfQ0xJRU5UX0lELAogICAgICAgICAgICAgICAgQVpVUkVfQ0xJRU5UX1NFQ1JFVCwKICAgICAgICAgICAgICAgIEFaVVJFX1RFTkFOVF9JRCwKICAgICAgICAgICAgICAgIEFaVVJFX1ZFUklGWV9TU0wsCiAgICAgICAgICAgICAgICAnaXNfYXp1cmVfYWRfYjJjJwogICAgICAgICAgICBdLAogICAgICAgICAgICAndHlwZSc6ICdhcnJheScKICAgICAgICB9CgogICAgZGVmIF9jcmVhdGVfYXp1cmVfYWRfZGV2aWNlKHNlbGYsIHJhd19kZXZpY2VfZGF0YSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFNjaGVtYTogaHR0cHM6Ly9kZXZlbG9wZXIubWljcm9zb2Z0LmNvbS9lbi11cy9ncmFwaC9kb2NzL2FwaS1yZWZlcmVuY2UvdjEuMC9yZXNvdXJjZXMvdXNlcgogICAgICAgICAgICBkZXZpY2UgPSBzZWxmLl9uZXdfZGV2aWNlX2FkYXB0ZXIoKQoKICAgICAgICAgICAgZGV2aWNlLmlkID0gcmF3X2RldmljZV9kYXRhWydpZCddCgogICAgICAgICAgICBhY2NvdW50X2VuYWJsZWQgPSByYXdfZGV2aWNlX2RhdGEuZ2V0KCdhY2NvdW50RW5hYmxlZCcpCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoYWNjb3VudF9lbmFibGVkLCBib29sKToKICAgICAgICAgICAgICAgIGRldmljZS5kZXZpY2VfZGlzYWJsZWQgPSBub3QgYWNjb3VudF9lbmFibGVkCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkZXZpY2UubGFzdF9zaWduX2luID0gcGFyc2VfZGF0ZShyYXdfZGV2aWNlX2RhdGEuZ2V0KCdhcHByb3hpbWF0ZUxhc3RTaWduSW5EYXRlVGltZScpKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ0NhbiBub3QgcGFyc2UgbGFzdCBzZWVuJykKCiAgICAgICAgICAgIGRldmljZS5henVyZV9kZXZpY2VfaWQgPSByYXdfZGV2aWNlX2RhdGEuZ2V0KCdkZXZpY2VJZCcpCiAgICAgICAgICAgIGRldmljZS5uYW1lID0gcmF3X2RldmljZV9kYXRhLmdldCgnZGlzcGxheU5hbWUnKQogICAgICAgICAgICBkZXZpY2UuYXp1cmVfZGlzcGxheV9uYW1lID0gcmF3X2RldmljZV9kYXRhLmdldCgnZGlzcGxheU5hbWUnKQoKICAgICAgICAgICAgYXp1cmVfaXNfY29tcGxpYW50ID0gcmF3X2RldmljZV9kYXRhLmdldCgnaXNDb21wbGlhbnQnKQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGF6dXJlX2lzX2NvbXBsaWFudCwgYm9vbCk6CiAgICAgICAgICAgICAgICBkZXZpY2UuYXp1cmVfaXNfY29tcGxpYW50ID0gYXp1cmVfaXNfY29tcGxpYW50CgogICAgICAgICAgICBhenVyZV9pc19tYW5hZ2VkID0gcmF3X2RldmljZV9kYXRhLmdldCgnaXNNYW5hZ2VkJykKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShhenVyZV9pc19tYW5hZ2VkLCBib29sKToKICAgICAgICAgICAgICAgIGRldmljZS5henVyZV9pc19tYW5hZ2VkID0gYXp1cmVfaXNfbWFuYWdlZAoKICAgICAgICAgICAgYXp1cmVfc3luY19lbmFibGVkID0gcmF3X2RldmljZV9kYXRhLmdldCgnb25QcmVtaXNlc1N5bmNFbmFibGVkJykKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShhenVyZV9zeW5jX2VuYWJsZWQsIGJvb2wpOgogICAgICAgICAgICAgICAgZGV2aWNlLmFkX29uX3ByZW1pc2Vfc3luY19lbmFibGVkID0gYXp1cmVfc3luY19lbmFibGVkCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkZXZpY2UuYWRfb25fcHJlbWlzZV9sYXN0X3N5bmNfZGF0ZV90aW1lID0gcGFyc2VfZGF0ZSgKICAgICAgICAgICAgICAgICAgICByYXdfZGV2aWNlX2RhdGEuZ2V0KCdvblByZW1pc2VzTGFzdFN5bmNEYXRlVGltZScpKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ0NhbiBub3QgcGFyc2UgbGFzdCBzeW5jIGRhdGUgdGltZScpCgogICAgICAgICAgICBkZXZpY2UuYWRfb25fcHJlbWlzZV90cnVzdF90eXBlID0gcmF3X2RldmljZV9kYXRhLmdldCgndHJ1c3RUeXBlJykKICAgICAgICAgICAgZGV2aWNlLmZpZ3VyZV9vcyhyYXdfZGV2aWNlX2RhdGEuZ2V0KCdvcGVyYXRpbmdTeXN0ZW0nLCAnJykpCiAgICAgICAgICAgIGRldmljZS5vcy5idWlsZCA9IHJhd19kZXZpY2VfZGF0YS5nZXQoJ29wZXJhdGluZ1N5c3RlbVZlcnNpb24nKQogICAgICAgICAgICBkZXZpY2UuYWRhcHRlcl9wcm9wZXJ0aWVzID0gW0FkYXB0ZXJQcm9wZXJ0eS5Bc3NldHMubmFtZSwgQWRhcHRlclByb3BlcnR5Lk1hbmFnZXIubmFtZV0KICAgICAgICAgICAgZGV2aWNlLnNldF9yYXcocmF3X2RldmljZV9kYXRhKQogICAgICAgICAgICByZXR1cm4gZGV2aWNlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ0dvdCBleGNlcHRpb24gZm9yIHJhd19kZXZpY2VfZGF0YToge3Jhd19kZXZpY2VfZGF0YX0nKQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICMgcHlsaW50OiBkaXNhYmxlPXRvby1tYW55LWJyYW5jaGVzLCB0b28tbWFueS1zdGF0ZW1lbnRzLCB0b28tbWFueS1uZXN0ZWQtYmxvY2tzCiAgICBkZWYgX2NyZWF0ZV9pbnR1bmVfZGV2aWNlKHNlbGYsIGRldmljZV9yYXcpOgogICAgICAgIHRyeToKICAgICAgICAgICAgZGV2aWNlID0gc2VsZi5fbmV3X2RldmljZV9hZGFwdGVyKCkKICAgICAgICAgICAgZGV2aWNlX2lkID0gZGV2aWNlX3Jhdy5nZXQoJ2lkJykKICAgICAgICAgICAgaWYgZGV2aWNlX2lkIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmJ0JhZCBkZXZpY2Ugd2l0aCBubyBJRCB7ZGV2aWNlX3Jhd30nKQogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgZGV2aWNlLmlkID0gZGV2aWNlX2lkICsgJ18nICsgKGRldmljZV9yYXcuZ2V0KCdkZXZpY2VOYW1lJykgb3IgJycpCiAgICAgICAgICAgIGRldmljZS5uYW1lID0gZGV2aWNlX3Jhdy5nZXQoJ2RldmljZU5hbWUnKQogICAgICAgICAgICBkZXZpY2UuZGV2aWNlX21hbnVmYWN0dXJlciA9IGRldmljZV9yYXcuZ2V0KCdtYW51ZmFjdHVyZXInKQogICAgICAgICAgICBkZXZpY2UuZGV2aWNlX21vZGVsID0gZGV2aWNlX3Jhdy5nZXQoJ21vZGVsJykKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdG90YWxfc3RvcmFnZV9zcGFjZV9pbl9nYiA9IGludChkZXZpY2VfcmF3LmdldCgndG90YWxTdG9yYWdlU3BhY2VJbkJ5dGVzJykpIC8gKDEwMjQuMCAqKiAzKQogICAgICAgICAgICAgICAgZnJlZV9zdG9yYWdlX3NwYWNlX2luX2diID0gaW50KGRldmljZV9yYXcuZ2V0KCdmcmVlU3RvcmFnZVNwYWNlSW5CeXRlcycpKSAvICgxMDI0LjAgKiogMykKICAgICAgICAgICAgICAgIGRldmljZS5hZGRfaGQodG90YWxfc2l6ZT10b3RhbF9zdG9yYWdlX3NwYWNlX2luX2diLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmVlX3NpemU9ZnJlZV9zdG9yYWdlX3NwYWNlX2luX2diKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ1Byb2JsZW0gZ2V0dGluZyBzdG9yYWdlJykKICAgICAgICAgICAgZGV2aWNlLm1hbmFnZWRfZGV2aWNlX25hbWUgPSBkZXZpY2VfcmF3LmdldCgnbWFuYWdlZERldmljZU5hbWUnKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkZXZpY2UuZmlndXJlX29zKChkZXZpY2VfcmF3LmdldCgnb3NWZXJzaW9uJykgb3IgJycpICsgJyAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKChkZXZpY2VfcmF3LmdldCgnb3BlcmF0aW5nU3lzdGVtJykpIG9yICcnKSkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBkZXZpY2Uub3MudHlwZSA9PSAnV2luZG93cyc6CiAgICAgICAgICAgICAgICAgICAgICAgIGRldmljZS5ob3N0bmFtZSA9IGRldmljZS5uYW1lCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZidQcm9ibGVtIGdldHRpbmcgb3MgZm9yIHtkZXZpY2VfcmF3fScpCiAgICAgICAgICAgIGRldmljZS5pbWVpID0gZGV2aWNlX3Jhdy5nZXQoJ2ltZWknKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkZXZpY2UubGFzdF9zZWVuID0gcGFyc2VfZGF0ZShkZXZpY2VfcmF3LmdldCgnbGFzdFN5bmNEYXRlVGltZScpKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ1ByYm9sZW0gZ2V0dGluZyBsYXN0IHNlZW4gZm9yIHtkZXZpY2VfcmF3fScpCiAgICAgICAgICAgIGRldmljZV9zZXJpYWwgPSBkZXZpY2VfcmF3LmdldCgnc2VyaWFsTnVtYmVyJykKICAgICAgICAgICAgaWYgZGV2aWNlX3NlcmlhbCBhbmQgZGV2aWNlX3NlcmlhbCBub3QgaW4gWydTeXN0ZW1TZXJpYWxOdW1iZXInLCAnU3lzdGVtIFNlcmlhbCBOdW1iZXInLCAnRGVmYXVsdCBzdHJpbmcnXToKICAgICAgICAgICAgICAgIGRldmljZS5kZXZpY2Vfc2VyaWFsID0gZGV2aWNlX3NlcmlhbAogICAgICAgICAgICBkZXZpY2UucGhvbmVfbnVtYmVyID0gZGV2aWNlX3Jhdy5nZXQoJ3Bob25lTnVtYmVyJykKICAgICAgICAgICAgZGV2aWNlLmFuZHJvaWRfc2VjdXJpdHlfcGF0Y2hfbGV2ZWwgPSBkZXZpY2VfcmF3LmdldCgnYW5kcm9pZFNlY3VyaXR5UGF0Y2hMZXZlbCcpCiAgICAgICAgICAgIGRldmljZS5lbWFpbCA9IGRldmljZV9yYXcuZ2V0KCdlbWFpbEFkZHJlc3MnKQogICAgICAgICAgICBpZiBkZXZpY2VfcmF3LmdldCgnd2lGaU1hY0FkZHJlc3MnKToKICAgICAgICAgICAgICAgIGRldmljZS5hZGRfbmljKGRldmljZV9yYXcuZ2V0KCd3aUZpTWFjQWRkcmVzcycpLCBOb25lKQogICAgICAgICAgICBkZXZpY2UuaXNfZW5jcnlwdGVkID0gZGV2aWNlX3Jhdy5nZXQoJ2lzRW5jcnlwdGVkJykKICAgICAgICAgICAgZGV2aWNlLnVzZXJfcHJpbmNpcGFsX25hbWUgPSBkZXZpY2VfcmF3LmdldCgndXNlclByaW5jaXBhbE5hbWUnKQogICAgICAgICAgICBkZXZpY2UuYXp1cmVfYWRfaWQgPSBkZXZpY2VfcmF3LmdldCgnYXp1cmVBRERldmljZUlkJykKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaW5zdGFsbGVkX2FwcHMgPSBkZXZpY2VfcmF3LmdldCgnaW5zdGFsbGVkX2FwcHMnKSBvciBbXQogICAgICAgICAgICAgICAgZm9yIGFwcCBpbiBpbnN0YWxsZWRfYXBwczoKICAgICAgICAgICAgICAgICAgICBpZiBhcHAuZ2V0KCdkaXNwbGF5TmFtZScpOgogICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2UuYWRkX2luc3RhbGxlZF9zb2Z0d2FyZShuYW1lPWFwcC5nZXQoJ2Rpc3BsYXlOYW1lJyksIHZlcnNpb249YXBwLmdldCgndmVyc2lvbicpKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ0NhbnQgcGFyc2UgaW5zdGFsbGVkIGFwcHMgZm9yIGRldmljZSB7ZGV2aWNlX2lkfScpCiAgICAgICAgICAgIGRldmljZS5zZXRfcmF3KGRldmljZV9yYXcpCiAgICAgICAgICAgIHJldHVybiBkZXZpY2UKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGYnUHJvYmxlbSB3aXRoIGRldmljZSB7ZGV2aWNlX3Jhd30nKQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBfcGFyc2VfcmF3X2RhdGEoc2VsZiwgcmF3X2RhdGFfYWxsKToKICAgICAgICByYXdfZGF0YSwgbWV0YWRhdGEgPSByYXdfZGF0YV9hbGwKICAgICAgICBmb3IgcmF3X2RldmljZV9kYXRhLCBkZXZpZV90eXBlIGluIGl0ZXIocmF3X2RhdGEpOgogICAgICAgICAgICBkZXZpY2UgPSBOb25lCiAgICAgICAgICAgIGlmIGRldmllX3R5cGUgPT0gJ0F6dXJlIEFEJzoKICAgICAgICAgICAgICAgIGRldmljZSA9IHNlbGYuX2NyZWF0ZV9henVyZV9hZF9kZXZpY2UocmF3X2RldmljZV9kYXRhKQogICAgICAgICAgICBpZiBkZXZpZV90eXBlID09ICdJbnR1bmUnOgogICAgICAgICAgICAgICAgZGV2aWNlID0gc2VsZi5fY3JlYXRlX2ludHVuZV9kZXZpY2UocmF3X2RldmljZV9kYXRhKQogICAgICAgICAgICBpZiBkZXZpY2U6CiAgICAgICAgICAgICAgICBkZXZpY2UuYWNjb3VudF90YWcgPSBtZXRhZGF0YS5nZXQoJ2FjY291bnRfdGFnJykKICAgICAgICAgICAgICAgIHlpZWxkIGRldmljZQoKICAgIGRlZiBfcGFyc2VfdXNlcnNfcmF3X2RhdGEoc2VsZiwgcmF3X2RhdGFfYWxsKToKICAgICAgICByYXdfZGF0YSwgbWV0YWRhdGEgPSByYXdfZGF0YV9hbGwKICAgICAgICBmb3IgcmF3X3VzZXJfZGF0YSBpbiBpdGVyKHJhd19kYXRhKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBTY2hlbWE6IGh0dHBzOi8vZGV2ZWxvcGVyLm1pY3Jvc29mdC5jb20vZW4tdXMvZ3JhcGgvZG9jcy9hcGktcmVmZXJlbmNlL3YxLjAvcmVzb3VyY2VzL3VzZXIKICAgICAgICAgICAgICAgIHVzZXIgPSBzZWxmLl9uZXdfdXNlcl9hZGFwdGVyKCkKICAgICAgICAgICAgICAgIHVzZXJfaWQgPSByYXdfdXNlcl9kYXRhLmdldCgnaWQnKSBvciByYXdfdXNlcl9kYXRhLmdldCgnb2JqZWN0SWQnKQogICAgICAgICAgICAgICAgaWYgbm90IHVzZXJfaWQ6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZidXYXJuaW5nIC0gbm8gdXNlciBpZCBmb3Ige3Jhd191c2VyX2RhdGF9LCBieXBhc3NpbmcnKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICB1c2VyLmlkID0gc3RyKHVzZXJfaWQpCiAgICAgICAgICAgICAgICB1c2VyLmFjY291bnRfdGFnID0gbWV0YWRhdGEuZ2V0KCdhY2NvdW50X3RhZycpCgogICAgICAgICAgICAgICAgYWNjb3VudF9lbmFibGVkID0gcmF3X3VzZXJfZGF0YS5nZXQoJ2FjY291bnRFbmFibGVkJykKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoYWNjb3VudF9lbmFibGVkLCBib29sKToKICAgICAgICAgICAgICAgICAgICB1c2VyLmFjY291bnRfZGlzYWJsZWQgPSBub3QgYWNjb3VudF9lbmFibGVkCgogICAgICAgICAgICAgICAgbWFpbCA9IHJhd191c2VyX2RhdGEuZ2V0KCdtYWlsJykKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBub3QgbWFpbDoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHNpZ25faW5fbmFtZV9yYXcgaW4gKHJhd191c2VyX2RhdGEuZ2V0KCdzaWduSW5OYW1lcycpIG9yIFtdKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNpZ25faW5fbmFtZV9yYXcuZ2V0KCd0eXBlJykgPT0gJ2VtYWlsQWRkcmVzcyc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpbCA9IHNpZ25faW5fbmFtZV9yYXcuZ2V0KCd2YWx1ZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IG1haWw6CiAgICAgICAgICAgICAgICAgICAgICAgIG90aGVyX21haWxzID0gcmF3X3VzZXJfZGF0YS5nZXQoJ290aGVyTWFpbHMnKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBvdGhlcl9tYWlscyBhbmQgaXNpbnN0YW5jZShvdGhlcl9tYWlscywgbGlzdCkgYW5kIGxlbihvdGhlcl9tYWlscykgPiAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpbCA9IG90aGVyX21haWxzWzBdCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZidGYWlsZWQgcGFyc2luZyBtYWlsIGZvciB1c2VyIHtyYXdfdXNlcl9kYXRhfScpCgogICAgICAgICAgICAgICAgdXNlci51c2VyX2NpdHkgPSByYXdfdXNlcl9kYXRhLmdldCgnY2l0eScpCiAgICAgICAgICAgICAgICB1c2VyLnVzZXJfY291bnRyeSA9IHJhd191c2VyX2RhdGEuZ2V0KCdjb3VudHJ5JykKICAgICAgICAgICAgICAgIHVzZXIudXNlcl9kZXBhcnRtZW50ID0gcmF3X3VzZXJfZGF0YS5nZXQoJ2RlcGFydG1lbnQnKQogICAgICAgICAgICAgICAgdXNlci5hZF9kaXNwbGF5X25hbWUgPSByYXdfdXNlcl9kYXRhLmdldCgnZGlzcGxheU5hbWUnKQogICAgICAgICAgICAgICAgdXNlci5maXJzdF9uYW1lID0gcmF3X3VzZXJfZGF0YS5nZXQoJ2dpdmVuTmFtZScpCiAgICAgICAgICAgICAgICB1c2VyLmxhc3RfbmFtZSA9IHJhd191c2VyX2RhdGEuZ2V0KCdzdXJuYW1lJykKICAgICAgICAgICAgICAgIHVzZXIudXNlcl90aXRsZSA9IHJhd191c2VyX2RhdGEuZ2V0KCdqb2JUaXRsZScpCiAgICAgICAgICAgICAgICB1c2VyLm1haWwgPSBtYWlsCiAgICAgICAgICAgICAgICB1c2VyLnVzZXJfdGVsZXBob25lX251bWJlciA9IHJhd191c2VyX2RhdGEuZ2V0KCdtb2JpbGVQaG9uZScpCgogICAgICAgICAgICAgICAgIyBPbiBwcmVtaXNlIHNldHRpbmdzCiAgICAgICAgICAgICAgICBhZF9vbl9wcmVtaXNlX3NhbWFjY291bnRuYW1lID0gcmF3X3VzZXJfZGF0YS5nZXQoJ29uUHJlbWlzZXNTYW1BY2NvdW50TmFtZScpCiAgICAgICAgICAgICAgICBhZF9vbl9wcmVtaXNlX3VzZXJfcHJpbmNpcGFsX25hbWUgPSByYXdfdXNlcl9kYXRhLmdldCgnb25QcmVtaXNlc1VzZXJQcmluY2lwYWxOYW1lJykKICAgICAgICAgICAgICAgIGF6dXJlX3VzZXJfcHJpbmNpcGFsX25hbWUgPSByYXdfdXNlcl9kYXRhLmdldCgndXNlclByaW5jaXBhbE5hbWUnKQoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB1c2VyLmFkX3NBTUFjY291bnROYW1lID0gYWRfb25fcHJlbWlzZV9zYW1hY2NvdW50bmFtZQoKICAgICAgICAgICAgICAgICAgICBpZiBhZF9vbl9wcmVtaXNlX3VzZXJfcHJpbmNpcGFsX25hbWU6CiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXIuYWRfdXNlcl9wcmluY2lwYWxfbmFtZSA9IGFkX29uX3ByZW1pc2VfdXNlcl9wcmluY2lwYWxfbmFtZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXIuYWRfdXNlcl9wcmluY2lwYWxfbmFtZSA9IGF6dXJlX3VzZXJfcHJpbmNpcGFsX25hbWUKCiAgICAgICAgICAgICAgICAgICAgaWYgYWRfb25fcHJlbWlzZV9zYW1hY2NvdW50bmFtZToKICAgICAgICAgICAgICAgICAgICAgICAgdXNlci51c2VybmFtZSA9IGFkX29uX3ByZW1pc2Vfc2FtYWNjb3VudG5hbWUKICAgICAgICAgICAgICAgICAgICBlbGlmIGFkX29uX3ByZW1pc2VfdXNlcl9wcmluY2lwYWxfbmFtZToKICAgICAgICAgICAgICAgICAgICAgICAgdXNlci51c2VybmFtZSA9IGFkX29uX3ByZW1pc2VfdXNlcl9wcmluY2lwYWxfbmFtZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXIudXNlcm5hbWUgPSBhenVyZV91c2VyX3ByaW5jaXBhbF9uYW1lCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oJ0NvdWxkIG5vdCBzZXQgc29tZSBvbiBwcmVtaXNlIHZhbHVlcycpCgogICAgICAgICAgICAgICAgdXNlci5kb21haW4gPSByYXdfdXNlcl9kYXRhLmdldCgnb25QcmVtaXNlc0RvbWFpbk5hbWUnKQogICAgICAgICAgICAgICAgdXNlci5hZF9vbl9wcmVtaXNlX2ltbXV0YWJsZV9pZCA9IHJhd191c2VyX2RhdGEuZ2V0KCdvblByZW1pc2VzSW1tdXRhYmxlSWQnKQogICAgICAgICAgICAgICAgdXNlci5hZF9zaWQgPSByYXdfdXNlcl9kYXRhLmdldCgnb25QcmVtaXNlc1NlY3VyaXR5SWRlbnRpZmllcicpCgogICAgICAgICAgICAgICAgYWRfb25fcHJlbWlzZV9zeW5jX2VuYWJsZWQgPSByYXdfdXNlcl9kYXRhLmdldCgnb25QcmVtaXNlc1N5bmNFbmFibGVkJykKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoYWRfb25fcHJlbWlzZV9zeW5jX2VuYWJsZWQsIGJvb2wpOgogICAgICAgICAgICAgICAgICAgIHVzZXIuYWRfb25fcHJlbWlzZV9zeW5jX2VuYWJsZWQgPSBhZF9vbl9wcmVtaXNlX3N5bmNfZW5hYmxlZAogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHVzZXIuYWRfb25fcHJlbWlzZV9sYXN0X3N5bmNfZGF0ZV90aW1lID0gcGFyc2VfZGF0ZShyYXdfdXNlcl9kYXRhLmdldCgnb25QcmVtaXNlc0xhc3RTeW5jRGF0ZVRpbWUnKSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ0NhbiBub3QgcGFyc2Ugb25QcmVtaXNlc0xhc3RTeW5jRGF0ZVRpbWUnKQoKICAgICAgICAgICAgICAgIHVzZXIuc2V0X3JhdyhyYXdfdXNlcl9kYXRhKQogICAgICAgICAgICAgICAgeWllbGQgdXNlcgogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ1Byb2JsZW0gcGFyc2luZyB1c2VyOiB7c3RyKHJhd191c2VyX2RhdGEpfScpCgogICAgQGNsYXNzbWV0aG9kCiAgICBkZWYgYWRhcHRlcl9wcm9wZXJ0aWVzKGNscyk6CiAgICAgICAgcmV0dXJuIFtBZGFwdGVyUHJvcGVydHkuVXNlck1hbmFnZW1lbnRdCg=='

CONNECTION_PY_PATH = '/home/ubuntu/cortex/adapters/azure_ad_adapter/connection.py'
SERVICE_PY_PATH = '/home/ubuntu/cortex/adapters/azure_ad_adapter/service.py'


def main():
    print(f'Upgrading Azure-AD Adapter to support Azure-AD B2C....')
    try:
        os.rename(CONNECTION_PY_PATH, CONNECTION_PY_PATH + '.bak')
        os.rename(SERVICE_PY_PATH, SERVICE_PY_PATH + '.bak')
    except Exception:
        pass

    with open(CONNECTION_PY_PATH, 'wb') as f:
        f.write(base64.b64decode(CONNECTION_PY_B64))

    with open(SERVICE_PY_PATH, 'wb') as f:
        f.write(base64.b64decode(SERVICE_PY_B64))

    subprocess.check_call('./axonius.sh adapter azure_ad up --restart --prod', shell=True, cwd='/home/ubuntu/cortex')

    print(f'Done!')
    return 0


if __name__ == '__main__':
    sys.exit(main())
