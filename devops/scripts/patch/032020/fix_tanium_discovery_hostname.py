import sys
import subprocess
import base64
import os

from axonius.entities import EntityType
from testing.services.plugins.static_correlator_service import StaticCorrelatorService
from testing.services.plugins.aggregator_service import AggregatorService
from testing.services.adapters.tanium_discover_service import TaniumDiscoverService

PARSING_PY_B64 = b'IiIiClBhcnNpbmdVdGlscy5weTogQ29sbGVjdGlvbiBvZiB1dGlscyB0aGF0IG1pZ2h0IGJlIHVzZWQgYnkgcGFyc2Vycywgc3BlY2lmaWNhbGx5IGFkYXB0ZXJzCiIiIgppbXBvcnQgYmFzZTY0CmltcG9ydCBiaW5hc2NpaQppbXBvcnQgY3N2CmltcG9ydCBkYXRldGltZQppbXBvcnQgaXBhZGRyZXNzCmltcG9ydCBsb2dnaW5nCmltcG9ydCBvcwppbXBvcnQgcmUKaW1wb3J0IHN0cmluZwppbXBvcnQgc3lzCmZyb20gdHlwZXMgaW1wb3J0IEZ1bmN0aW9uVHlwZQpmcm9tIHR5cGluZyBpbXBvcnQgQ2FsbGFibGUsIE5ld1R5cGUsIExpc3QsIEl0ZXJhYmxlLCBPcHRpb25hbAoKaW1wb3J0IHB5dHoKCmltcG9ydCBheG9uaXVzCmZyb20gYXhvbml1cy5lbnRpdGllcyBpbXBvcnQgRW50aXR5VHlwZQpmcm9tIGF4b25pdXMudXRpbHMuZGF0ZXRpbWUgaW1wb3J0IGlzX2RhdGVfcmVhbCwgcGFyc2VfZGF0ZSwgX3BhcnNlX3VuaXhfdGltZXN0YW1wCgpsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcihmJ2F4b25pdXMue19fbmFtZV9ffScpCgpvc3hfdmVyc2lvbl9mYWxsYmFjayA9IHJlLmNvbXBpbGUocidbXlx3XShcZCtcLlxkKy5cZCspJykKb3N4X3ZlcnNpb24gPSByZS5jb21waWxlKHInW15cd10oXGQrXC5cZCsuXGQrKVteXHddJykKb3N4X3ZlcnNpb25fZnVsbCA9IHJlLmNvbXBpbGUocidbXlx3XShcZCtcLlxkKy5cZCspXHMqKFwoXHcrXCkpJykKIyBtYXRjaCBhbnkgb2Y6IChVYnVudHUgLyB1YnVudHUgLyBVYnVudHVTZXJ2ZXIgLyB1YnVudHVzZXJ2ZXIgLyBVYnVudHVzZXJ2ZXIpICsgdmVyc2lvbiBudW1iZXIKdWJ1bnR1X2Z1bGwgPSByZS5jb21waWxlKHInKFtVdV1idW50dSg/OltTc11lcnZlcik/IFxkXGRcLlxkXGQoPzpcLlxkKyk/KScpCm1vYmlsZV92ZXJzaW9uID0gcmUuY29tcGlsZShyJyhcZCtcLlxkKy5cZCspJykKCiMgVW5mb3J0dW5hdGVseSB0aGVyZSdzIG5vIG5vcm1hbGl6ZWQgd2F5IHRvIHJldHVybiBhIGhvc3RuYW1lIC0gY3VycmVudGx5IG1hbnkgYWRhcHRlcnMgcmV0dXJuIGhvc3RuYW1lLmRvbWFpbi4KIyBIb3dldmVyIGluIG5vbi13aW5kb3dzIHN5c3RlbXMsIHRoZSBob3N0bmFtZSBpdHNlbGYgY2FuIGNvbnRhaW4gIi4iIHdoaWNoIG1lYW5zIHRoZXJlJ3Mgbm8gd2F5IHRvIHRlbGwgd2hpY2ggcGFydCBpcwojIHRoZSBob3N0bmFtZSB3aGVuIHNwbGl0dGluZy4KIyBUaGUgcHJvYmxlbSBzdGFydHMgYXMgc29tZSBhZGFwdGVycyB5aWVsZCBhIGhvc3RuYW1lIHdpdGggYSBkZWZhdWx0IGRvbWFpbiBhZGRlZCB0byBpdCBldmVuIHdoZW4gYSBkb21haW4gZXhpc3RzLCBhbmQKIyBzb21lIGRvbid0IHJldHVybiBhIGRvbWFpbiBhdCBhbGwuCiMgSW4gb3JkZXIgdG8gaWdub3JlIHRoYXQgYW5kIGFsbG93IHByb3BlciBob3N0bmFtZSBjb21wYXJpc29uIHdlIHdhbnQgdG8gcmVtb3ZlIHRoZSBkZWZhdWx0IGRvbWFpbnMuCiMgQ3VycmVudGx5ICgyOC8wMS8yMDE4KSB0aGlzIG1lYW5zIHJlbW92aW5nIExPQ0FMIGFuZCBXT1JLR1JPVVAuCiMgQWxzbyB3ZSB3YW50IHRvIHNwbGl0IHRoZSBob3N0bmFtZSBvbiAiLiIgYW5kIG1ha2Ugc3VyZSBvbmUgc3BsaXQgbGlzdCBpcyB0aGUgYmVnaW5uaW5nIG9mIHRoZSBvdGhlci4KTk9STUFMSVpFRF9IT1NUTkFNRSA9ICdub3JtYWxpemVkX2hvc3RuYW1lJwpPU1hfTkFNRVMgPSBbJ21vamF2ZScsICdzaWVycmEnLCAnY2FwaXRhbicsICd5b3NlbWl0ZScsICdtYXZlcmlja3MnLCAnZGFyd2luJ10KTUFDX05BTUVTID0gWydvcyB4JywgJ29zeCcsICdtYWNvcycsICdtYWMgb3MnLCAnbWFjYm9vayddCiMgSW4gc29tZSBjYXNlcyB3ZSBkb24ndCB3YW50IHRvIHVzZSBjb21wYXJlX2hvc3RuYW1lcyBiZWNhdXNlIGluZGV4aW5nIHVzaW5nIGl0IGlzIGNvbXBsaWNhdGVkCiMgYW5kIGluIHNvbWUgY2FzZXMgaW5kZXhzaW5nIGlzIHBlcmZvcm1hbmNlIGNyaXRpY2FsCk5PUk1BTElaRURfSE9TVE5BTUVfU1RSSU5HID0gJ25vcm1hbGl6ZWRfaG9zdG5hbWVfc3RyaW5nJwpORVRfQklPU19NQVhfTEVOR1RIID0gMTUKREVGQVVMVF9ET01BSU5fRVhURU5TSU9OUyA9IFsnLkxPQ0FMJywgJy5XT1JLR1JPVVAnLCAnLkxPQ0FMSE9TVCddCiMgSW4gTWFjT3MgaG9zdG5hbWUgb2YgdGhlIHNhbWUgY29tcHV0ZXIgY2FuIHJldHVybiBpbiBkaWZmZXJlbnQgc2hhcGVzLAojIHRoYXQncyB3aHkgd2Ugd291bGQgbGlrZSB0byBjb21wYXJlIHRoZW0gd2l0aG91dCB0aGVzZSBzdHJpbmdzCkRFRkFVTFRfTUFDX0VYVEVOU0lPTlMgPSBbJy1NQUNCT09LLVBSTycsICdNQUNCT09LLVBSTycsICctTUJQJywgJ01CUCcsICctTUJBJywgJy1NQUNCT09LLUFJUicsICdNQUNCT09LLUFJUiddICsgXAogICAgICAgICAgICAgICAgICAgICAgICAgW2YnLU1CUC17aW5kZXh9JyBmb3IgaW5kZXggaW4gcmFuZ2UoMjApXSArIFwKICAgICAgICAgICAgICAgICAgICAgICAgIFtmJy1NQlAtMHtpbmRleH0nIGZvciBpbmRleCBpbiByYW5nZSgxMCldICsgWyctQUlSJywgJ0FJUiddICsgXAogICAgICAgICAgICAgICAgICAgICAgICAgW2YnLU1BQ0JPT0stUFJPLXtpbmRleH0nIGZvciBpbmRleCBpbiByYW5nZSgyMCldICsgXAogICAgICAgICAgICAgICAgICAgICAgICAgW2YnLU1BQ0JPT0stUFJPLTB7aW5kZXh9JyBmb3IgaW5kZXggaW4gcmFuZ2UoMTApXSArIFwKICAgICAgICAgICAgICAgICAgICAgICAgIFtmJ01BQ0JPT0tQUk97aW5kZXh9JyBmb3IgaW5kZXggaW4gcmFuZ2UoMjApXSArIFtmJ01BQ0JPT0tQUk8we2luZGV4fScgZm9yIGluZGV4IGluIHJhbmdlKDEwKV0KIyBOT1JNQUxJWkVEX0lQUy9NQUNTIGZpZWxkcyB3aWxsIGhvbGQgdGhlIHNldCBvZiBJUHMgYW5kIE1BQ3MgYW4gYWRhcHRlciBkZXZpY2VzIGhhcyBleHRyYWN0ZWQuCiMgV2l0aG91dCBpdCwgaW4gb3JkZXIgdG8gY29tcGFyZSBJUHMgYW5kIE1BQ3Mgd2Ugd291bGQgaGF2ZSB0byBnbyB0aHJvdWdoIHRoZSBsaXN0IG9mIG5ldHdvcmsgaW50ZXJmYWNlcyBhbmQgZXh0cmFjdAojIHRoZW0gZWFjaCB0aW1lLgpOT1JNQUxJWkVEX0lQUyA9ICdub3JtYWxpemVkX2lwcycKTk9STUFMSVpFRF9JUFNfNCA9ICdub3JtYWxpemVkX2lwc180JwpOT1JNQUxJWkVEX0lQU182ID0gJ25vcm1hbGl6ZWRfaXBzXzYnCk5PUk1BTElaRURfTUFDUyA9ICdub3JtYWxpemVkX21hY3MnCkFMTE9XRURfVkFSX0NIQVJBQ1RFUlMgPSAnYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXpBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWjAxMjM0NTY3ODlfJwoKIyBDb25zdGFudHMgZm9yIHBhcnNpbmcgYW5kIGZvcm1hdHRpbmcgc29mdHdhcmUgdmVyc2lvbnMgaW4gb3JkZXIgdG8gY29tcGFyZQojIHRoZW0gaW4gdGhlIHF1ZXJ5IHdpemFyZApOX0NIQVJfRVhURU5TSU9OID0gOApERUZBVUxUX1ZFUlNJT05fRVhURU5TSU9OID0gJzAwMDAwMDAwJwpERUZBVUxUX0xJTlVYX1ZFUlNJT05fRVBPQ0ggPSAnMCcKQkFEX1NFUklBTFMgPSBbJ0lOVkFMSUQnLCAnTk9OLVVOSVFVRVMvTicsICcwJywgJ1NZU1RFTVNFUklBTE5VTUJFUicsCiAgICAgICAgICAgICAgICdERUZBVUxUU1RSSU5HJywgJ05BJywgJ04vQScsICcxMjM0NTY3ODknLCAnVU5LTk9XTicsICctJ10KCgojIFRoaXMgbnVtYmVyIHN0YW5kcyBmb3IgdGhlIGRlZmF1bHQgbnVtYmVyIG9mIGRheXMgbmVlZGVkIGZvciB1cyB0byBzYXkgYSBkZXZpY2UgaXMgb2xkLAojIGZpcnN0IHVzZSBpZiBmb3IgY29ycmVsYXRpb24gYXQgaXNfb2xkX2RldmljZQpERUZBVUxUX05VTUJFUl9PRl9EQVlTX0ZPUl9PTERfREVWSUNFID0gNwoKVE9fUkVNT1ZFX1ZBTFVFID0gb2JqZWN0KCkKCkJTT05fU1BFQ19NQVhfSU5UID0gMHg3ZmZmZmZmZmZmZmZmZmZmCnBhaXJfY29tcGFyYXRvciA9IE5ld1R5cGUoJ3BhaXJfY29tcGFyYXRvcicsIEZ1bmN0aW9uVHlwZSkKcGFyYW1ldGVyX2Z1bmN0aW9uID0gTmV3VHlwZSgncGFyYW1ldGVyX2Z1bmN0aW9uJywgQ2FsbGFibGUpCgojIE5ldyB2ZXJzaW9ucyBjYW4gYmUgZG93bmxvYWRlZCBmcm9tIHRoZSBmb2xsb3dpbmcgcmVzb3VyY2VzOgojIGh0dHBzOi8vZ2l0aHViLmNvbS93aXJlc2hhcmsvd2lyZXNoYXJrL3Jhdy9tYXN0ZXIvbWFudWYKIyBodHRwczovL2dpdGxhYi5jb20vd2lyZXNoYXJrL3dpcmVzaGFyay9yYXcvbWFzdGVyL21hbnVmCiMgaHR0cHM6Ly9jb2RlLndpcmVzaGFyay5vcmcvcmV2aWV3L2dpdHdlYj9wPXdpcmVzaGFyay5naXQ7YT1ibG9iX3BsYWluO2Y9bWFudWY7aGI9SEVBRApvdWlfZGF0YSA9IG9wZW4ob3MucGF0aC5qb2luKGF4b25pdXMuX19wYXRoX19bMF0sICdtYW51ZicpLCBlbmNvZGluZz0ndXRmOCcpLnJlYWQoKQoKIyBkaWN0OiBNQUMgMyBmaXJzdCBieXRlcyB0byBtYW51ZmFjdHVyZXIgZGF0YQptYWNfbWFudWZhY3R1cmVyX2RldGFpbHMgPSB7eFswXS5yZXBsYWNlKCc6JywgJycpOiB4IGZvciB4IGluIFt4LnNwbGl0KCdcdCcpIGZvciB4CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluIG91aV9kYXRhW291aV9kYXRhLmZpbmQoJzAwOjAwOjAwJyk6XS5zcGxpdGxpbmVzKCldfQpkZWwgb3VpX2RhdGEKCgpkZWYgcGFyc2VfYm9vbF9mcm9tX3Jhdyhib29sX3Jhd192YWx1ZSwgcmFpc2Vfb25fZXhjZXB0aW9uPUZhbHNlKToKICAgICIiIgogICAgR2V0cyBhIHJhdyB2YWx1ZSBhbmQgcmV0dXJucyB0aGUgYm9vbCBmcm9tIGl0LiB3ZSBkbyBpdCBzaW5jZSBib29sKHgpIGlzbid0IGdvb2QgZW5vdWdoLAogICAgZS5nLiBib29sKCJmYWxzZSIpIGlzIFRydWUuCiAgICA6cGFyYW0gYm9vbF9yYXdfdmFsdWU6IHRoZSByYXcgdmFsdWUKICAgIDpwYXJhbSByYWlzZV9vbl9leGNlcHRpb246IChvcHRpb25hbCkgcmFpc2UgYW4gZXhjZXB0aW9uIGlmIHlvdSBjYW4ndCBzdWNjZWVkLiBvdGhlcndpc2UgcmV0dXJuIE5vbmUKICAgIDpyZXR1cm46CiAgICAiIiIKICAgICMgQWxsIG9mIHRoZSBiZWxvdyBjYW4gaGFwcGVuCiAgICBpZiB0eXBlKGJvb2xfcmF3X3ZhbHVlKSA9PSBib29sOgogICAgICAgIHJldHVybiBib29sX3Jhd192YWx1ZQogICAgZWxpZiB0eXBlKGJvb2xfcmF3X3ZhbHVlKSA9PSBpbnQ6CiAgICAgICAgcmV0dXJuIGJvb2woYm9vbF9yYXdfdmFsdWUpCiAgICBlbGlmIHR5cGUoYm9vbF9yYXdfdmFsdWUpID09IHN0ciBhbmQgYm9vbF9yYXdfdmFsdWUubG93ZXIoKSBpbiBbJ3RydWUnLCAnZmFsc2UnLCAnMCcsICcxJ106CiAgICAgICAgcmV0dXJuIGJvb2xfcmF3X3ZhbHVlLmxvd2VyKCkgaW4gWyd0cnVlJywgJzEnXQoKICAgIGlmIHJhaXNlX29uX2V4Y2VwdGlvbiBpcyBUcnVlOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZid7Ym9vbF9yYXdfdmFsdWV9IGlzblwndCBhIGJvb2xlYW4gdmFsdWUnKQoKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIE5vbmUKCgpkZWYgZ2V0X21hbnVmYWN0dXJlcl9mcm9tX21hYyhtYWM6IHN0cikgLT4gT3B0aW9uYWxbc3RyXToKICAgIGlmIG1hYzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZvcm1hdHRlZF9tYWMgPSBmb3JtYXRfbWFjKG1hYykucmVwbGFjZSgnOicsICcnKQogICAgICAgICAgICBmb3IgaW5kZXggaW4gWzYsIDcsIDgsIDldOgogICAgICAgICAgICAgICAgbWFudWZhY3R1cmVyID0gbWFjX21hbnVmYWN0dXJlcl9kZXRhaWxzLmdldChmb3JtYXR0ZWRfbWFjWzppbmRleF0pCiAgICAgICAgICAgICAgICBpZiBtYW51ZmFjdHVyZXI6CiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKG1hbnVmYWN0dXJlcikgPiAyOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZid7bWFudWZhY3R1cmVyWzFdfSAoe21hbnVmYWN0dXJlclsyXX0pJwogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmJ3ttYW51ZmFjdHVyZXJbMV19JwogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ0Vycm9yIGluIHBhcnNpbmcgbWFjIHZlbmRvcjoge2V9JykKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCgpkZWYgbm9ybWFsaXplX3Zhcl9uYW1lKG5hbWUpOgogICAgIiIiCiAgICBUYWtlcyBhIHN0cmluZyBhbmQgcmV0dXJucyBhbm90aGVyIHN0cmluZyB3aGljaCBjYW4gYmUgYSB2YXJpYWJsZSBuYW1lIGluIHB5dGhvbi4KICAgIDpwYXJhbSBuYW1lOgogICAgOnJldHVybjoKICAgICIiIgogICAgbmFtZSA9IG5hbWUucmVwbGFjZSgnLScsICdfJykucmVwbGFjZSgnICcsICdfJykKICAgIG5hbWUgPSAnJy5qb2luKFtjaGFyYWN0ZXIgZm9yIGNoYXJhY3RlciBpbiBuYW1lIGlmIGNoYXJhY3RlciBpbiBBTExPV0VEX1ZBUl9DSEFSQUNURVJTXSkKICAgIHJldHVybiBuYW1lCgoKZGVmIGdldF9leGNlcHRpb25fc3RyaW5nKCk6CiAgICAiIiIKICAgIHdoZW4gaW5zaWRlIGEgY2F0Y2ggZXhjZXB0aW9uIGZsb3csIHJldHVybnMgYSByZWFsbHkgaW5mb3JtYXRpdmUgc3RyaW5nIHJlcHJlc2VudGluZyBpdC4KICAgIDpyZXR1cm46IGEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgZXhjZXB0aW9uLgogICAgIiIiCiAgICBleGNfdHlwZSwgZXhjX29iaiwgZXhjX3RiID0gc3lzLmV4Y19pbmZvKCkKCiAgICBleF9zdHIgPSAnVHJhY2ViYWNrIChtb3N0IHJlY2VudCBjYWxsIGxhc3QpOlxuJwogICAgd2hpbGUgZXhjX3RiIGlzIG5vdCBOb25lOgogICAgICAgIGV4X3N0ciA9IGV4X3N0ciArICcgIEZpbGUgezB9LCBsaW5lIHsxfSwgaW4gezJ9XG4nLmZvcm1hdCgKICAgICAgICAgICAgZXhjX3RiLnRiX2ZyYW1lLmZfY29kZS5jb19maWxlbmFtZSwKICAgICAgICAgICAgZXhjX3RiLnRiX2xpbmVubywKICAgICAgICAgICAgZXhjX3RiLnRiX2ZyYW1lLmZfY29kZS5jb19uYW1lKQoKICAgICAgICBleGNfdGIgPSBleGNfdGIudGJfbmV4dAoKICAgIGV4X3N0ciA9IGV4X3N0ciArIGYne2V4Y190eXBlfTp7ZXhjX29ian0nCiAgICByZXR1cm4gZXhfc3RyCgoKZGVmIGZpZ3VyZV9vdXRfY2xvdWQocyk6CiAgICAiIiIKICAgIEZpZ3VyZXMgb3V0IGEgY2xvdWQgcHJvdmlkZXIuIElmIHdlIGNhbid0IGZpbmQgaXQsIHJldHVybnMgTm9uZS4KICAgIDpwYXJhbSBzOiB0aGUgY2xvdWQgcHJvdmlkZXIsIGUuZy4gImFtYXpvbi13ZWItc2VydmljZXMiCiAgICA6cmV0dXJuOiBhIGdlbmVyaWMgdmFsdWUgcmVwcmVzZW50aW5nIHRoZSBjbG91ZCBwcm92aWRlciwgd2hpY2ggeW91IGNhbiB1c2UgZm9yIGRldmljZS5jbG91ZF9wcm92aWRlcgogICAgIiIiCiAgICBpZiBub3QgczoKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGNsb3VkX3Byb3ZpZGVyID0gcy5sb3dlcigpCgogICAgaWYgJ2F3cycgaW4gY2xvdWRfcHJvdmlkZXIgb3IgJ2FtYXpvbicgaW4gY2xvdWRfcHJvdmlkZXI6CiAgICAgICAgcmV0dXJuICdBV1MnCiAgICBlbGlmICdhenVyZScgaW4gY2xvdWRfcHJvdmlkZXIgb3IgJ21pY3Jvc29mdCcgaW4gY2xvdWRfcHJvdmlkZXI6CiAgICAgICAgcmV0dXJuICdBenVyZScKICAgIGVsaWYgJ2dvb2dsZScgaW4gY2xvdWRfcHJvdmlkZXIgb3IgJ2djcCcgaW4gY2xvdWRfcHJvdmlkZXI6CiAgICAgICAgcmV0dXJuICdHQ1AnCiAgICBlbGlmICdzb2Z0bGF5ZXInIGluIGNsb3VkX3Byb3ZpZGVyIG9yICdpYm0nIGluIGNsb3VkX3Byb3ZpZGVyOgogICAgICAgIHJldHVybiAnU29mdGxheWVyJwogICAgZWxpZiAndm13YXJlJyBpbiBjbG91ZF9wcm92aWRlciBvciAndmNlbnRlcicgaW4gY2xvdWRfcHJvdmlkZXIgXAogICAgICAgICAgICBvciAndnNwaGVyZScgaW4gY2xvdWRfcHJvdmlkZXIgb3IgJ2VzeCcgaW4gY2xvdWRfcHJvdmlkZXI6CiAgICAgICAgcmV0dXJuICdWTVdhcmUnCiAgICBlbGlmICdhbGliYWJhJyBpbiBjbG91ZF9wcm92aWRlciBvciAnYWxpeXVuJyBpbiBjbG91ZF9wcm92aWRlcjoKICAgICAgICByZXR1cm4gJ0FsaWJhYmEnCiAgICBlbGlmICdvcmFjbGUnIGluIGNsb3VkX3Byb3ZpZGVyOgogICAgICAgIHJldHVybiAnT3JhY2xlJwogICAgZWxzZToKICAgICAgICByZXR1cm4gTm9uZQoKCmRlZiBmaWd1cmVfb3V0X3dpbmRvd3NfZGlzdChzKToKICAgICMgV2UgZG8gdGhpcyB0byBhdm9pZCBjYXNlcyBsaWtlICJXaW5kb3dzIDEwIFhYWCAyMDE2IgogICAgaWYgJ3dpbmRvd3MgMTAgJyBpbiBzLmxvd2VyKCkgYW5kICdzZXJ2ZXInIG5vdCBpbiBzLmxvd2VyKCk6CiAgICAgICAgcmV0dXJuICcxMCcKICAgIHMgPSBzLnJlcGxhY2UoJ1dpbmRvd3MgJywgJycpLnJlcGxhY2UoJ1dpbmRvd3MnLCAnJykucmVwbGFjZSgnV2luJywgJycpCiAgICBkaXN0X25hbWUgPSAnJwogICAgaWYgJ3NlcnZlcicgaW4gczoKICAgICAgICBkaXN0X25hbWUgPSBmJ3tkaXN0X25hbWV9IFNlcnZlcicKICAgIGVsc2U6CiAgICAgICAgZGlzdHNfd2l0aF9ub192ZXJzaW9uID0gWydWaXN0YScsICdYUCddCiAgICAgICAgZm9yIGRpc3QgaW4gZGlzdHNfd2l0aF9ub192ZXJzaW9uOgogICAgICAgICAgICBpZiBkaXN0Lmxvd2VyKCkgaW4gczoKICAgICAgICAgICAgICAgIHJldHVybiBkaXN0CiAgICBkaXN0X3ZlcnNpb25zID0gWycyMDAwJywgJzIwMDMnLCAnMjAwOCcsICcyMDEyJywgJzIwMTYnLCAnMjAxOSddCiAgICBkaXN0X3ZlcnNpb25zLmV4dGVuZChbJyAxMCcsICcgOC4xJywgJyA5NScsICcgOTgnLCAnIDgnLCAnIDcnXSkKICAgIGZvciB2ZXJzaW9uIGluIGRpc3RfdmVyc2lvbnM6CiAgICAgICAgaWYgdmVyc2lvbiBpbiBzOgogICAgICAgICAgICBkaXN0X25hbWUgPSBmJ3tkaXN0X25hbWV9IHt2ZXJzaW9uLnN0cmlwKCl9JwogICAgICAgICAgICBicmVhawogICAgaWYgbm90IGRpc3RfbmFtZS5zdHJpcCgpOgogICAgICAgIHJldHVybiBOb25lCiAgICByZXR1cm4gZGlzdF9uYW1lLnN0cmlwKCkKCgpkZWYgZmlndXJlX291dF9vcyhzKToKICAgICIiIgogICAgR2l2ZXMgc29tZXRoaW5nIGxpa2UgdGhpcwogICAgewogICAgICAgICAidHlwZSI6ICJXaW5kb3dzIiwKICAgICAgICAgImRpc3RyaWJ1dGlvbiI6ICJWaXN0YSIsCiAgICAgICAgICJlZGl0aW9uIjogIkhvbWUgQmFzaWMiLAogICAgICAgICAibWFqb3IiOiAiNi4wIiwKICAgICAgICAgIm1pbm9yIjogIjYwMDIiLAogICAgICAgICAiYml0bmVzcyI6IDMyCiAgICAgfSwKCiAgICAgKG5vdCBldmVyeXRoaW5nIGlzIGltcGxlbWVudGVkKQogICAgZnJvbSBzdHVmZiBsaWtlIHRoaXM6CiAgICAiQ2Fub25pY2FsLCBVYnVudHUsIDE2LjA0IExUUywgYW1kNjQgeGVuaWFsIGltYWdlIGJ1aWxkIG9uIDIwMTctMDctMjEiCiAgICAiTWljcm9zb2Z0IFdpbmRvd3MgU2VydmVyIDIwMTYgKDY0LWJpdCkiCiAgICA6cGFyYW0gczogZGVzY3JpcHRpb24gb2YgT1MKICAgIDpyZXR1cm46IGRpY3QKICAgICIiIgogICAgaWYgcyBpcyBOb25lOgogICAgICAgICMgdGhpcyBtZWFucyB3ZSBkb24ndCBrbm93IGFueXRoaW5nCiAgICAgICAgcmV0dXJuIHt9CiAgICBvcmlnX3MgPSBzCiAgICBzID0gcy5zdHJpcCgpLmxvd2VyKCkucmVwbGFjZSgnwq4nLCAnJykKCiAgICBtYWtlc182NGJpdCA9IFsnYW1kNjQnLCAnNjQtYml0JywgJ3g2NCcsICc2NCBiaXQnLCAneDg2XzY0JywgJ1dpbjY0J10KICAgIG1ha2VzXzMyYml0ID0gWyczMi1iaXQnLCAneDg2J10KCiAgICBpc193aW5kb3dzX3NlcnZlciA9IEZhbHNlCiAgICBiaXRuZXNzID0gTm9uZQogICAgaWYgYW55KHggaW4gcyBmb3IgeCBpbiBtYWtlc182NGJpdCk6CiAgICAgICAgYml0bmVzcyA9IDY0CiAgICBlbGlmIGFueSh4IGluIHMgZm9yIHggaW4gbWFrZXNfMzJiaXQpOgogICAgICAgIGJpdG5lc3MgPSAzMgoKICAgIG9zX3R5cGUgPSBOb25lCiAgICBkaXN0cmlidXRpb24gPSBOb25lCiAgICBsaW51eF9uYW1lcyA9IFsnbGludXgnLCAndWJ1bnR1JywgJ2Nhbm9uaWNhbCcsICdyZWQgaGF0JywKICAgICAgICAgICAgICAgICAgICdkZWJpYW4nLCAnZmVkb3JhJywgJ2NlbnRvcycsICdvcmFjbGUnLCAnb3BlbnN1c2UnLCAncmhlbCBzZXJ2ZXInLCAnc2xlcycsICdnZW50b28nLCAnYXJjaCddCgogICAgaW9zX2RldmljZXMgPSBbJ2lwaG9uZScsICdpcGFkJywgJ2FwcGxlJ10KICAgIGlvc19uYW1lcyA9IGlvc19kZXZpY2VzICsgWydpb3MnXQoKICAgICMgU3RhcnQgd2l0aCB0aGUgb25lIHdobyBoYXZlIGZvciBzdXJlIGNhcGl0YWwgaW4gdGhlaXIgbmFtZXMKICAgICMgVGhlIGZpcnN0IHBhcnQgaXMgbm90IGVub3VnaCwgc2luY2Ugc29tZSBkZXZpY2VzIGhhdmUgb25seSAnSU9TJyBpbiB0aGVtLCBidXQgbm90ICJjaXNjbyIuCiAgICAjIFdlIGhhdmUgc2VlbiB0aGlzIGhhcHBlbmluZyBpbiBjbGllbnRzIChhIGRldmljZSB3aXRoIDIgYWRhcHRlcnMgaGFkICJDaXNjbyIsICJpT1MiIG9wZXJhdGluZyBzeXN0ZW1zLAogICAgIyBpbiBhIGNsaWVudCB0aGF0IGRpZCBub3QgbGV0IHVzIGNvbm5lY3QgdG8gYW55IHN5c3RlbSB0aGF0IHNlZSBtb2JpbGUgZGV2aWNlcykKICAgIGlmICdjaXNjbycgaW4gcyBvciAoJ0lPUycgaW4gb3JpZ19zIGFuZCBub3QgYW55KHggaW4gcyBmb3IgeCBpbiBpb3NfZGV2aWNlcykpOgogICAgICAgICMgSWYgaXQgaGFzICdjaXNjbycsIG9yIGl0IGhhcyAnSU9TJyAodXBwZXIgbGV0dGVycykgYW5kIGl0IGRvZXNuJ3QgaGF2ZSAnaXBob25lJywgJ2lwYWQnLCBldGMuCiAgICAgICAgb3NfdHlwZSA9ICdDaXNjbycKICAgIGVsaWYgJ3Z4d29ya3MnIGluIHM6CiAgICAgICAgb3NfdHlwZSA9ICdWeFdvcmtzJwogICAgZWxpZiAnd2luZG93cycgaW4gcyBvciAoJ3dpbicgaW4gcyBhbmQgJ2Rhcndpbicgbm90IGluIHMpOgogICAgICAgIG9zX3R5cGUgPSAnV2luZG93cycKICAgICAgICBkaXN0cmlidXRpb24gPSBmaWd1cmVfb3V0X3dpbmRvd3NfZGlzdChzKQogICAgICAgIGlmIGRpc3RyaWJ1dGlvbiBhbmQgJ3NlcnZlcicgaW4gZGlzdHJpYnV0aW9uLmxvd2VyKCk6CiAgICAgICAgICAgIGlzX3dpbmRvd3Nfc2VydmVyID0gVHJ1ZQogICAgZWxpZiAnYW5kcm9pZCcgaW4gczoKICAgICAgICBvc190eXBlID0gJ0FuZHJvaWQnCiAgICAgICAgdmVyc2lvbiA9IG1vYmlsZV92ZXJzaW9uLmZpbmRhbGwocykKICAgICAgICBpZiBsZW4odmVyc2lvbik6CiAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9IHZlcnNpb25bMF0KICAgIGVsaWYgYW55KHggaW4gcyBmb3IgeCBpbiBsaW51eF9uYW1lcyk6CiAgICAgICAgb3NfdHlwZSA9ICdMaW51eCcKICAgICAgICBsaW51eF9kaXN0cmlidXRpb25zID0gW3VidW50dV9mdWxsLCAnVWJ1bnR1JywgJ1JlZCBIYXQnLCAnRGViaWFuJywgJ0ZlZG9yYScsICdSSEVMJywgJ0dlbnRvbycsICdBcmNoJywgJ09yYWNsZSddCiAgICAgICAgZm9yIGRpc3QgaW4gbGludXhfZGlzdHJpYnV0aW9uczoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShkaXN0LCBzdHIpOgogICAgICAgICAgICAgICAgaWYgZGlzdC5sb3dlcigpIGluIHM6CiAgICAgICAgICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gZGlzdAogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBmb3VuZF92YWx1ZXMgPSBkaXN0LmZpbmRhbGwob3JpZ19zKQogICAgICAgICAgICAgICAgaWYgZm91bmRfdmFsdWVzOgogICAgICAgICAgICAgICAgICAgIGFzc2VydCBpc2luc3RhbmNlKGZvdW5kX3ZhbHVlc1swXSwgc3RyKQogICAgICAgICAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9IGZvdW5kX3ZhbHVlc1swXQogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgZWxpZiBhbnkoZWxlbSBpbiBzIGZvciBlbGVtIGluIE1BQ19OQU1FUykgXAogICAgICAgICAgICBvciBhbnkoZWxlbSBpbiBzIGZvciBlbGVtIGluIE9TWF9OQU1FUyk6CiAgICAgICAgb3NfdHlwZSA9ICdPUyBYJwogICAgICAgIHZlcnNpb24gPSBvc3hfdmVyc2lvbl9mdWxsLmZpbmRhbGwocykKICAgICAgICBpZiBsZW4odmVyc2lvbikgPiAwOgogICAgICAgICAgICBkaXN0cmlidXRpb24gPSAnICcuam9pbih2ZXJzaW9uWzBdKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHZlcnNpb24gPSBvc3hfdmVyc2lvbi5maW5kYWxsKHMpCiAgICAgICAgICAgIGlmIGxlbih2ZXJzaW9uKSA+IDA6CiAgICAgICAgICAgICAgICBkaXN0cmlidXRpb24gPSB2ZXJzaW9uWzBdCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB2ZXJzaW9uID0gb3N4X3ZlcnNpb25fZmFsbGJhY2suZmluZGFsbChzKQogICAgICAgICAgICAgICAgaWYgbGVuKHZlcnNpb24pID4gMDoKICAgICAgICAgICAgICAgICAgICBkaXN0cmlidXRpb24gPSB2ZXJzaW9uWzBdCiAgICBlbGlmIGFueSh4IGluIHMgZm9yIHggaW4gaW9zX25hbWVzKToKICAgICAgICBvc190eXBlID0gJ2lPUycKICAgICAgICB2ZXJzaW9uID0gbW9iaWxlX3ZlcnNpb24uZmluZGFsbChzKQogICAgICAgIGlmIGxlbih2ZXJzaW9uKToKICAgICAgICAgICAgZGlzdHJpYnV0aW9uID0gdmVyc2lvblswXQogICAgZWxpZiAnZnJlZWJzZCcgaW4gczoKICAgICAgICBvc190eXBlID0gJ0ZyZWVCU0QnCiAgICAgICAgZGlzdHJpYnV0aW9uID0gJ0ZyZWVCU0QnCiAgICBlbGlmICdqdW5vcycgaW4gczoKICAgICAgICBvc190eXBlID0gJ0ZyZWVCU0QnCiAgICAgICAgZGlzdHJpYnV0aW9uID0gJ0p1bm9zIE9TJwogICAgZWxpZiBzLnN0YXJ0c3dpdGgoJ3Ztd2FyZScpOgogICAgICAgIG9zX3R5cGUgPSAnVk1XYXJlJwogICAgICAgIGVzeF9kaXN0cmlidXRpb25zID0gWydFU1ggNC4wJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnRVNYIDQuMScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0VTWGkgNC4wJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnRVNYaSA0LjEnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICdFU1hpIDUuMCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0VTWGkgNS4xJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnRVNYaSA1LjEuMCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0VTWGkgNS4xLjBhJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnRVNYaSA1LjUnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICdFU1hpIDYuMCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0VTWGkgNi4wLjBiJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnRVNYaSA2LjUnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICdFU1hpIDYuNS4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICdFU1hpIDYuNS4wJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnRVNYaSA2LjUuMGQnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICdFU1hpL0VTWCA0LjEnXQogICAgICAgIGRpc3RyaWJ1dGlvbiA9IHMucmVwbGFjZSgnVk1XYXJlICcsICcnKQogICAgICAgIGlmIGRpc3RyaWJ1dGlvbiBub3QgaW4gZXN4X2Rpc3RyaWJ1dGlvbnM6CiAgICAgICAgICAgIGRpc3RyaWJ1dGlvbiA9ICcoPykgJyArIGRpc3RyaWJ1dGlvbgogICAgZWxpZiAnbWlrcm90aWsnIGluIHMubG93ZXIoKToKICAgICAgICBvc190eXBlID0gJ01pa3JvdGlrJwogICAgZWxpZiAnZjUgbmV0d29ya3MgYmlnLWlwJyA9PSBzLmxvd2VyKCk6CiAgICAgICAgb3NfdHlwZSA9ICdGNSBOZXR3b3JrcyBCaWctSVAnCiAgICBlbGlmICdzb2xhcmlzJyBpbiBzLmxvd2VyKCk6CiAgICAgICAgb3NfdHlwZSA9ICdTb2xhcmlzJwogICAgZWxpZiAnYWl4JyBpbiBzLmxvd2VyKCk6CiAgICAgICAgb3NfdHlwZSA9ICdBSVgnCiAgICBlbGlmICdwcmludGVyJyBpbiBzLmxvd2VyKCk6CiAgICAgICAgb3NfdHlwZSA9ICdQcmludGVyJwogICAgZWxpZiAncGxheXN0YXRpb24nIGluIHMubG93ZXIoKToKICAgICAgICBvc190eXBlID0gJ1BsYXlTdGF0aW9uJwogICAgZWxpZiAnY2hlY2sgcG9pbnQnIGluIHMubG93ZXIoKToKICAgICAgICBvc190eXBlID0gJ0NoZWNrIFBvaW50JwoKICAgIHJldHVybl9kaWN0ID0geyd0eXBlJzogb3NfdHlwZSwKICAgICAgICAgICAgICAgICAgICdkaXN0cmlidXRpb24nOiBkaXN0cmlidXRpb24sCiAgICAgICAgICAgICAgICAgICAnYml0bmVzcyc6IGJpdG5lc3MsCiAgICAgICAgICAgICAgICAgICAnb3Nfc3RyJzogc30KICAgIGlmIG9zX3R5cGUgPT0gJ1dpbmRvd3MnOgogICAgICAgIHJldHVybl9kaWN0Wydpc193aW5kb3dzX3NlcnZlciddID0gaXNfd2luZG93c19zZXJ2ZXIKICAgIHJldHVybiByZXR1cm5fZGljdAoKCmRlZiBjb252ZXJ0X2xkYXBfc2VhcmNocGF0aF90b19kb21haW5fbmFtZShsZGFwX3NlYXJjaF9wYXRoKToKICAgICIiIgogICAgQ29udmVydHMgTERBUCBzZWFyY2ggcGF0aCB0byBEQy4KICAgIGUuZy4gJ0NOPURFU0tUT1AtTVBQMTBVMSxDTj1Db21wdXRlcnMsREM9VGVzdERvbWFpbixEQz10ZXN0JyAtPiAnVGVzdERvbWFpbi50ZXN0JwogICAgOnBhcmFtIGxkYXBfc2VhcmNoX3BhdGg6IHRoZSBzdHIKICAgIDpyZXR1cm46CiAgICAiIiIKCiAgICByZXR1cm4gJy4nLmpvaW4oW3hbMzpdIGZvciB4IGluIGxkYXBfc2VhcmNoX3BhdGguc3RyaXAoKS5zcGxpdCgnLCcpIGlmIHgubG93ZXIoKS5zdGFydHN3aXRoKCdkYz0nKV0pCgoKZGVmIGdldF9vcmdhbml6YXRpb25hbF91bml0c19mcm9tX2RuKGRpc3Rpbmd1aXNoZWRfbmFtZSk6CiAgICB0cnk6CiAgICAgICAgb3VzID0gW291WzM6XSBmb3Igb3UgaW4gZGlzdGluZ3Vpc2hlZF9uYW1lLnNwbGl0KCcsJykgaWYgb3Uuc3RhcnRzd2l0aCgnT1U9JyldCiAgICAgICAgaWYgb3VzOgogICAgICAgICAgICByZXR1cm4gb3VzCiAgICAgICAgcmV0dXJuIE5vbmUKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuIE5vbmUKCgpkZWYgaXNfZG9tYWluX3ZhbGlkKGRvbWFpbik6CiAgICAiIiIKICAgIDpwYXJhbSBkb29tYWluOiBlLmcuIFRlc3REb21haW4KICAgIDpyZXR1cm46IGUuZy4gV2hldGhlciBkb21haW4gZXhpc3QgYW5kIGhhcyBhIHZhbGlkIHZhbHVlIHdoaWNoIGlzIG5vdCBhIGxvY2FsIHZhbHVlCiAgICAiIiIKICAgIGRvbWFpbiA9IChkb21haW4gb3IgJycpLnN0cmlwKCkubG93ZXIoKQogICAgaWYgZG9tYWluIGFuZCBub3QgJ3dvcmtncm91cCcgaW4gZG9tYWluIGFuZCBub3QgJ2xvY2FsJyA9PSBkb21haW4gYW5kIFwKICAgICAgICAgICAgbm90ICduL2EnIGluIGRvbWFpbiBhbmQgbm90ICcobm9uZSknIGluIGRvbWFpbjoKICAgICAgICByZXR1cm4gVHJ1ZQogICAgcmV0dXJuIEZhbHNlCgoKZGVmIG5vdF93aWZpX2FkYXB0ZXJzKGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKToKICAgIHJldHVybiBub3Rfd2lmaV9hZGFwdGVyKGFkYXB0ZXJfZGV2aWNlMSkgYW5kIG5vdF93aWZpX2FkYXB0ZXIoYWRhcHRlcl9kZXZpY2UyKQoKCmRlZiBub3Rfd2lmaV9hZGFwdGVyKGFkYXB0ZXJfZGV2aWNlKToKICAgIGlmIGFkYXB0ZXJfZGV2aWNlLmdldCgncGx1Z2luX25hbWUnKS5sb3dlcigpID09ICdhcnViYV9hZGFwdGVyJyBvciBcCiAgICAgICAgICAgIChhZGFwdGVyX2RldmljZS5nZXQoJ3BsdWdpbl9uYW1lJykubG93ZXIoKSA9PSAnY2lzY29fcHJpbWVfYWRhcHRlcicgYW5kCiAgICAgICAgICAgICBhZGFwdGVyX2RldmljZVsnZGF0YSddLmdldCgnZmV0Y2hfcHJvdG8nKSA9PSAnUFJJTUVfV0lGSV9DTElFTlQnKSBvclwKICAgICAgICAgICAgKGFkYXB0ZXJfZGV2aWNlLmdldCgncGx1Z2luX25hbWUnKS5sb3dlcigpID09ICd0YW5pdW1fZGlzY292ZXJfYWRhcHRlcicpIG9yIFwKICAgICAgICAgICAgaXNfY291bnRlcl9hY3RfYWRhcHRlcihhZGFwdGVyX2RldmljZSk6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICByZXR1cm4gVHJ1ZQoKCmRlZiBnZXRfZmlyc3Rfb2JqZWN0X2Zyb21fZG4oZG4pOgogICAgIiIiCiAgICA6cGFyYW0gZG46IGUuZy4gQ049QWRtaW5pc3RyYXRvcixDTj1Vc2VycyxEQz1UZXN0RG9tYWluLERDPXRlc3QKICAgIDpyZXR1cm46IGUuZy4gQWRtaW5pc3RyYXRvcgogICAgIiIiCiAgICBpZiB0eXBlKGRuKSA9PSBzdHI6CiAgICAgICAgZG4gPSBkbi5yZXBsYWNlKCdcXCwnLCAnJykKICAgICAgICBkbiA9IGRuLnNwbGl0KCcsJykKICAgICAgICBpZiBsZW4oZG4pID4gMDoKICAgICAgICAgICAgIyBUaGlzIHVzdWFsbHkgbG9va3MgbGlrZSBDTj1Vc2VyIE5hbWUsIENOPVVzZXJzLCBEQz0uLi4uIHNvIGxldHMgdGFrZSB0aGUgZmlyc3Qgb25lCiAgICAgICAgICAgIHJ2ID0gZG5bMF0uc3BsaXQoJz0nKQogICAgICAgICAgICBpZiBsZW4ocnYpID09IDI6CiAgICAgICAgICAgICAgICByZXR1cm4gcnZbMV0KCiAgICByZXR1cm4gTm9uZQoKCmRlZiBnZXRfbWVtYmVyX29mX2xpc3RfZnJvbV9tZW1iZXJvZihtZW1iZXJfb2YpIC0+IExpc3Rbc3RyXToKICAgIHRyeToKICAgICAgICBpZiBtZW1iZXJfb2YgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICMgbWVtYmVyX29mIGlzIGEgbGlzdCBvZiBkbidzIHRoYXQgbG9vayBsaWtlICdDTj1kLE9VPWIsREM9YyxEQz1hJwogICAgICAgICAgICAjIHNvIHdlIHRha2UgZWFjaCBzdHJpbmcgaW4gdGhlIGxpc3QgYW5kIHRyYW5zZm9ybSBpdCB0byBkLmIuYy5hCiAgICAgICAgICAgIHJldHVybiBbJy4nLmpvaW4oW3hbMzpdIGZvciB4IGluIG1lbWJlcl9vZl9lbnRyeS5zdHJpcCgpLnNwbGl0KCcsJyldKSBmb3IgbWVtYmVyX29mX2VudHJ5IGluIG1lbWJlcl9vZl0KICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKICAgIHJldHVybiBOb25lCgoKZGVmIGlzX3ZhbGlkX3VzZXIodXNlcm5hbWU6IHN0cikgLT4gYm9vbDoKICAgIGlmIG5vdCBpc2luc3RhbmNlKHVzZXJuYW1lLCBzdHIpOgogICAgICAgIHJldHVybiBGYWxzZQogICAgcmV0dXJuIHVzZXJuYW1lLnN0cmlwKCkubG93ZXIoKSBub3QgaW4gWyduL2EnLCAnPG5vbmU+JywgJ25vbmUnLCAndW5rbm93biddCgoKZGVmIGlzX3ZhbGlkX2lwKGlwKToKICAgIHRyeToKICAgICAgICBpcGFkZHJlc3MuaXBfYWRkcmVzcyhpcCkKICAgICAgICByZXR1cm4gVHJ1ZQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gRmFsc2UKCgpkZWYgaXNfdmFsaWRfaXB2NChpcCk6CiAgICAiIiJDaGVjayBpZiBhbiBpcCBhZGRyZXNzIGlzIGluIHZhbGlkIElQdjQgZm9ybWF0LgoKICAgIDpwYXJhbSBpcDogSVAgYWRkcmVzcyB0byBjaGVjay4KICAgIDp0eXBlIGlwOiBzdHIKICAgIDpydHlwZTogYm9vbAogICAgIiIiCiAgICB0cnk6CiAgICAgICAgcmV0dXJuIGlzaW5zdGFuY2UoaXBhZGRyZXNzLmlwX2FkZHJlc3MoaXApLCBpcGFkZHJlc3MuSVB2NEFkZHJlc3MpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiBGYWxzZQoKCmRlZiBpc192YWxpZF9pcHY2KGlwKToKICAgICIiIkNoZWNrIGlmIGFuIGlwIGFkZHJlc3MgaXMgaW4gdmFsaWQgSVB2NiBmb3JtYXQuCgogICAgOnBhcmFtIGlwOiBJUCBhZGRyZXNzIHRvIGNoZWNrLgogICAgOnR5cGUgaXA6IHN0cgogICAgOnJ0eXBlOiBib29sCiAgICAiIiIKICAgIHRyeToKICAgICAgICByZXR1cm4gaXNpbnN0YW5jZShpcGFkZHJlc3MuaXBfYWRkcmVzcyhpcCksIGlwYWRkcmVzcy5JUHY2QWRkcmVzcykKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuIEZhbHNlCgoKZGVmIGd1YXJhbnRlZWRfbGlzdCh4KToKICAgIGlmIG5vdCB4OgogICAgICAgIHJldHVybiBbXQogICAgZWxpZiBpc2luc3RhbmNlKHgsIGxpc3QpOgogICAgICAgIHJldHVybiB4CiAgICBlbHNlOgogICAgICAgIHJldHVybiBbeF0KCgpkZWYgZm9ybWF0X21hYyhtYWM6IHN0cik6CiAgICBpZiBtYWMgaXMgTm9uZSBvciBtYWMgPT0gJyc6CiAgICAgICAgcmV0dXJuIE5vbmUKICAgIG1hYyA9IHJlLnN1YignWy46LV0nLCAnJywgbWFjKS5sb3dlcigpICAjIHJlbW92ZSBkZWxpbWl0ZXJzIGFuZCBjb252ZXJ0IHRvIGxvd2VyIGNhc2UKICAgIG1hYyA9ICcnLmpvaW4obWFjLnNwbGl0KCkpICAjIHJlbW92ZSB3aGl0ZXNwYWNlcwoKICAgIGlmIGxlbihtYWMpICE9IDEyIG9yIGFueShtYXAobGFtYmRhIGNoYXI6IGNoYXIgbm90IGluIHN0cmluZy5oZXhkaWdpdHMsIG1hYykpOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZidJbnZhbGlkIG1hYyB7bWFjfScpCgogICAgIyBjb252ZXJ0IG1hYyBpbiBjYW5vbmljYWwgZm9ybSAoZWcuIDAwOjgwOjQxOmFlOmZkOjdlKQogICAgbWFjID0gJzonLmpvaW4oWyclcycgJSAobWFjW2k6aSArIDJdKSBmb3IgaSBpbiByYW5nZSgwLCAxMiwgMildKQogICAgcmV0dXJuIG1hYy51cHBlcigpCgoKZGVmIGZvcm1hdF9pcCh2YWx1ZSk6CiAgICB0cnk6CiAgICAgICAgcmV0dXJuIHN0cihpcGFkZHJlc3MuaXBfYWRkcmVzcyh2YWx1ZSkpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZidJbnZhbGlkIElQIGFkZHJlc3M6IHt2YWx1ZX0nKQoKCmRlZiBmb3JtYXRfc3VibmV0KHZhbHVlKToKICAgICMgTXVzdCBwYXNzIHtpcH0ve2ludC9pcHY0X3N1Ym5ldF9tYXNrfSBzdWNoIHRoYXQgaXQgd2lsbCBiZSBwb3NzaWJsZSB0byBkaXN0aW5ndWlzaCBiZXR3ZWVuIHR3bwogICAgIyBzdWJuZXQgbWFza3MgKGFuZCB0d28gaXBzKSBvbiBzYW1lIGludGVyZmFjZQogICAgdHJ5OgogICAgICAgIGFzc2VydCAnLycgaW4gdmFsdWUKICAgICAgICByZXR1cm4gc3RyKGlwYWRkcmVzcy5pcF9uZXR3b3JrKHZhbHVlLCBGYWxzZSkpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZidJbnZhbGlkIHN1Ym5ldDoge3ZhbHVlfScpCgoKZGVmIGFkX2ludGVnZXI4X3RvX3RpbWVkZWx0YShpOCk6CiAgICAiIiIKICAgIFRoZSBzeW50YXggaXMgSW50ZWdlcjgsIGFsc28gY2FsbGVkIExhcmdlSW50ZWdlci4gVGhlIHZhbHVlIGlzIGEgNjQtYml0IGludGVnZXIgcmVwcmVzZW50aW5nIHRpbWUgaW50ZXJ2YWxzCiAgICBpbiAxMDAtbmFub3NlY29uZCB0aWNrcy4gIFRoZSB2YWx1ZSBpcyBhbHdheXMgbmVnYXRpdmUuIEZvciBleGFtcGxlLCBpZiB0aGUgbWF4aW11bSBwYXNzd29yZCBhZ2UgaW4gdGhlIGRvbWFpbgogICAgaXMgMTAgZGF5cywgdGhlbiBtYXhQd2RBZ2Ugd2lsbCBoYXZlIHRoZSB2YWx1ZToKICAgIG1heFB3ZEFnZSA9ICgtMSkgeCAxMCBkYXlzIHggMjQgaG91cnMvZGF5IHggNjAgbWludXRlcy9ob3VyIHggNjAgc2Vjb25kcy9taW51dGUgeCAxMCwwMDAsMDAwIHRpY2tzL3NlY29uZAogICAgPSAtOCw2NDAsMDAwLDAwMCwwMDAgdGlja3MKICAgIDpwYXJhbSBpODogaW50ZWdlcjggdmFsdWUKICAgIDpyZXR1cm46IHRpbWVkZWx0YSBvYmplY3QKICAgICIiIgoKICAgIHJldHVybiBkYXRldGltZS50aW1lZGVsdGEoc2Vjb25kcz0oLTEgKiBpOCkgLyAxZSs3KQoKCmRlZiBieXRlc19pbWFnZV90b19iYXNlNjQodmFsdWUpOgogICAgIiIiCiAgICBUYWtlcyBhIGJ5dGVzIGxpc3QgYW5kIHJldHVybnMgYSBiYXNlNjQgc3RyIHRoYXQgd2lsbCBiZSBzaG93biByaWdodCBvbiA8aW1nIHNyYz0iIj4uCiAgICA6cGFyYW0gdmFsdWU6CiAgICA6cmV0dXJuOgogICAgIiIiCiAgICB0cnk6CiAgICAgICAgaGVhZGVyID0gYmluYXNjaWkuaGV4bGlmeSh2YWx1ZVs6NF0pCiAgICAgICAgaWYgaGVhZGVyLnN0YXJ0c3dpdGgoYidmZmQ4ZmYnKToKICAgICAgICAgICAgaGVhZGVyID0gJ2pwZWcnCiAgICAgICAgZWxpZiBoZWFkZXIgPT0gYic4OTUwNGU0Nyc6CiAgICAgICAgICAgIGhlYWRlciA9ICdwbmcnCiAgICAgICAgZWxpZiBoZWFkZXIgPT0gYic0NzQ5NDYzOCc6CiAgICAgICAgICAgIGhlYWRlciA9ICdnaWYnCiAgICAgICAgZWxpZiBoZWFkZXIgPT0gYic0OTQ5MmEwMCc6CiAgICAgICAgICAgICMgVGhpcyBpcyBhIHRpZmYgaW1hZ2UsIGJyb3dzZXIgZG8gbm90IHN1cHBvcnQgZGlzcGxheWluZyBpdC4KICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYnSW52YWxpZCBpbWFnZS4gaGVhZGVyIGlzIHtoZWFkZXJ9LCBjYW5ub3QgZGV0ZXJtaW5lIGlmIGpwZWcvcG5nL2dpZi4nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZidUaGlzIGNvdWxkIGJlIGEgbGVnaXRpbWF0ZSBlcnJvciwgc29tZSBpYW1nZXMgYXJlblwndCBwYXJzYWJsZScpCiAgICAgICAgcmV0dXJuICdkYXRhOmltYWdlL3swfTtiYXNlNjQsezF9Jy5mb3JtYXQoaGVhZGVyLCBiYXNlNjQuYjY0ZW5jb2RlKHZhbHVlKS5kZWNvZGUoJ3V0Zi04JykpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZidJbnZhbGlkIEltYWdlLiBFeGNlcHRpb24gaXMge2dldF9leGNlcHRpb25fc3RyaW5nKCl9JykKCgpkZWYgZm9ybWF0X2lwX3Jhdyh2YWx1ZSk6CiAgICB0cnk6CiAgICAgICAgYWRkcmVzcyA9IGlwYWRkcmVzcy5pcF9hZGRyZXNzKHZhbHVlKQogICAgICAgIGlmIGlzaW5zdGFuY2UoYWRkcmVzcywgaXBhZGRyZXNzLklQdjRBZGRyZXNzKToKICAgICAgICAgICAgcmV0dXJuIGFkZHJlc3MuX2lwCiAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAjIFRPRE86IEFkZCBzdXBwb3J0IHRvIGlwdjYKICAgICAgICAjIGRlY2ltYWwxMjhfY3R4ID0gY3JlYXRlX2RlY2ltYWwxMjhfY29udGV4dCgpCiAgICAgICAgIyB3aXRoIGRlY2ltYWwubG9jYWxjb250ZXh0KGRlY2ltYWwxMjhfY3R4KSBhcyBjdHg6CiAgICAgICAgIyByZXR1cm4gRGVjaW1hbDEyOChjdHguY3JlYXRlX2RlY2ltYWwoc3RyKGFkZHJlc3MuX2lwKSkpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZidJbnZhbGlkIHJhdyBJUCBhZGRyZXNzOiB7dmFsdWV9JykKCgpkZWYgcGFyc2VfdmVyc2lvbnNfcmF3KHZlcnNpb24pOgogICAgIiIiCiAgICBHZXRzIGEgc29mdHdhcmUgdmVyc2lvbiBudW1iZXIgYW5kIGZvcm1hdHMgaXQgc28gaXQgY2FuIGJlIGNvbXBhcmVkIGluCiAgICB0aGUgcXVlcnkgd2l6YXJkCiAgICA6cGFyYW0gdmVyc2lvbjoKICAgIDpyZXR1cm46CiAgICAiIiIKICAgIHRyeToKICAgICAgICBpZiBub3QgdmVyc2lvbiBvciBub3QgaXNpbnN0YW5jZSh2ZXJzaW9uLCBzdHIpOgogICAgICAgICAgICByZXR1cm4gJycKICAgICAgICB2ZXJzaW9uID0gdmVyc2lvbi5zdHJpcCgpCiAgICAgICAgIyBFdmVuIGlmIHRoZSB2ZXJzaW9uIGlzIG5vdCBsaW51eCBzb2Z0d2FyZSwgdGhlIGlucHV0IGlzIGZvcm1hdHRlZCBhcyBpZiBpdCB3ZXJlCiAgICAgICAgIyAobWVhbmluZyBpdCBoYXMgYSBsZWFkaW5nIDApIGJlY2F1c2UgaXQgbWF5IG9yIG1heSBub3QgYmUgY29tcGFyaW5nIGxpbnV4CiAgICAgICAgIyBzb2Z0d2FyZSB2ZXJzaW9ucywgc28gYWxsIHZlcnNpb25zIG5lZWQgdG8gaGF2ZSB0aGUgc2FtZSBhbGlnbm1lbnQgKG1lYW5pbmcgdGhleQogICAgICAgICMgc3RhcnQgd2l0aCBhIGxlYWRpbmcgMCkKICAgICAgICBleHRlbmRlZF92ZXJzaW9uID0gREVGQVVMVF9MSU5VWF9WRVJTSU9OX0VQT0NICgogICAgICAgICMgQ2hlY2sgZm9yIGxpbnV4IHNvZnR3YXJlIHNpbmNlIGl0IGhhcyBkaWZmZXJlbnQsIGluY29uc2lzdGVudCBmb3JtYXQKICAgICAgICBpZiBhbnkod29yZCBpbiB2ZXJzaW9uIGZvciB3b3JkIGluIFsndWJ1bnR1JywgJ2RzZmcnLCAnZHNmJywgJ2J1aWxkJywgJy0nLCAnficsICcrJywgJzonXSk6CiAgICAgICAgICAgIGV4dGVuZGVkX3ZlcnNpb24gPSBwYXJzZV9saW51eF9zb2Z0d2FyZV92ZXJzaW9uc19yYXcodmVyc2lvbikKICAgICAgICAgICAgcmV0dXJuIGV4dGVuZGVkX3ZlcnNpb24KCiAgICAgICAgc3BsaXRfb25fZG90ID0gdmVyc2lvbi5zcGxpdCgnLicpCgogICAgICAgIGZvciBmaWVsZCBpbiBzcGxpdF9vbl9kb3Q6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIG5vdCBzdHIuaXNkaWdpdChmaWVsZCk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnCiAgICAgICAgICAgICAgICAjIElmIHRoZSBleGlzdGluZyB2ZXJzaW9uIGlzIGxvbmdlciB0aGFuIHRoZSBuIGNoYXJhY3RlcnMgZWFjaCBmaWVsZCBpcyBhbGxvdHRlZCwgdHJpbSBpdAogICAgICAgICAgICAgICAgaWYgbGVuKGZpZWxkKSA+IE5fQ0hBUl9FWFRFTlNJT046CiAgICAgICAgICAgICAgICAgICAgZmllbGQgPSBmaWVsZFs6Tl9DSEFSX0VYVEVOU0lPTl0KICAgICAgICAgICAgICAgIGV4dGVuZGVkX3ZlcnNpb24gKz0gZXh0ZW5kX3RvX25fZGlnaXRzKGZpZWxkLCBOX0NIQVJfRVhURU5TSU9OKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ1Byb2JsZW0gcGFyc2luZyB2ZXJzaW9uIHt2ZXJzaW9ufScpCiAgICAgICAgICAgICAgICByZXR1cm4gJycKCiAgICAgICAgcmV0dXJuIGV4dGVuZGVkX3ZlcnNpb24KCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIGxvZ2dlci5leGNlcHRpb24oZidDb3VsZCBub3QgcGFyc2Ugc29mdHdhcmUgdmVyc2lvbiB7dmVyc2lvbn0nKQogICAgICAgIHJldHVybiAnJwoKCmRlZiBleHRlbmRfdG9fbl9kaWdpdHModmFsdWUsIG5fY2hhcnNfdG9fZXh0ZW5kKToKICAgIHRyeToKICAgICAgICBleHRlbmRlZF92YWx1ZSA9ICcnLmpvaW4oWycwJyBmb3IgXyBpbiByYW5nZShuX2NoYXJzX3RvX2V4dGVuZCAtIGxlbih2YWx1ZSkpXSkKICAgICAgICBleHRlbmRlZF92YWx1ZSArPSB2YWx1ZQogICAgICAgIHJldHVybiBleHRlbmRlZF92YWx1ZQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGYnUHJvYmxlbSBleHRlbmRpbmcgdmVyc2lvbiBmaWVsZCB7dmFsdWV9JykKICAgICAgICByZXR1cm4gJycKCgpkZWYgcGFyc2VfbGludXhfc29mdHdhcmVfdmVyc2lvbnNfcmF3KHZlcnNpb24pOgogICAgIiIiCiAgICBPbmx5IHBhcnNlcyB0aGUgdmVyc2lvbiBmb3IgdGhlIHNvdXJjZSAodGhlIGZpcnN0IHZlcnNpb24gbGlzdGVkKSwgZG9lc24ndAogICAgaGFuZGxlIHRoZSByZXN0IG9mIHRoZSB2ZXJzaW9uCiAgICA6cGFyYW0gdmVyc2lvbjoKICAgIDpyZXR1cm46CiAgICAiIiIKICAgIHRyeToKICAgICAgICBleHRlbmRlZF92ZXJzaW9uID0gREVGQVVMVF9MSU5VWF9WRVJTSU9OX0VQT0NIICAgICAgIyBJZiBubyBleHBsaWNpdCBlcG9jaCwgaXQgaGFzIGFuIGltcGxpZWQgMAogICAgICAgIGlmICc6JyBpbiB2ZXJzaW9uOgogICAgICAgICAgICBleHRlbmRlZF92ZXJzaW9uID0gdmVyc2lvbi5zcGxpdCgnOicpWzBdCiAgICAgICAgICAgIHZlcnNpb24gPSBzdHIodmVyc2lvbi5zcGxpdCgnOicpWzFdKQogICAgICAgIHRvX3NwbGl0ID0gdmVyc2lvbi5yZXBsYWNlKCd+JywgJy0nKS5yZXBsYWNlKCcrJywgJy0nKS5yZXBsYWNlKCd1YnVudHUnLCAnLScpCiAgICAgICAgcHJpbWFyeV92ZXJzaW9uID0gdG9fc3BsaXQuc3BsaXQoJy0nKVswXQogICAgICAgIGZvciBmaWVsZCBpbiBwcmltYXJ5X3ZlcnNpb24uc3BsaXQoJy4nKToKICAgICAgICAgICAgaWYgbm90IHN0ci5pc2RpZ2l0KGZpZWxkKToKICAgICAgICAgICAgICAgIHJldHVybiAnJwogICAgICAgICAgICBleHRlbmRlZF92ZXJzaW9uICs9IGV4dGVuZF90b19uX2RpZ2l0cyhmaWVsZCwgTl9DSEFSX0VYVEVOU0lPTikKICAgICAgICByZXR1cm4gZXh0ZW5kZWRfdmVyc2lvbgogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGYnUHJvYmxlbSBwYXJzaW5nIGxpbnV4IHNvZnR3YXJlIHZlcnNpb24ge3ZlcnNpb259JykKICAgICAgICByZXR1cm4gJycKCgpkZWYgcGFyc2VfdW5peF90aW1lc3RhbXAodW5peF90aW1lc3RhbXApOgogICAgcmV0dXJuIF9wYXJzZV91bml4X3RpbWVzdGFtcCh1bml4X3RpbWVzdGFtcCkKCgpkZWYgaXNfaG9zdG5hbWVfdmFsaWQoaG9zdG5hbWUpOgogICAgcmV0dXJuIGhvc3RuYW1lIGFuZCBob3N0bmFtZSBub3QgaW4gWydob3N0LmRvY2tlci5pbnRlcm5hbCcsICd3aW5kb3dzMTAubWljcm9kb25lLmNuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnU2NyZWVuY2FzdC1Qcm9kdWN0aW9uLUVuY29kZXItdG8tUHJlcGFyZS1BTUknXQoKCmRlZiBwYXJzZV9kYXRlX3dpdGhfdGltZXpvbmUoZGF0ZXRpbWVfdG9fcGFyc2UsIHRpbWVfem9uZSk6CiAgICAiIiIKICAgIFBhcnNlcyBkYXRlIGFuZCByZXR1cm5zIGl0IGFzIFVUQwogICAgIiIiCiAgICB0cnk6CiAgICAgICAgaWYgdHlwZShkYXRldGltZV90b19wYXJzZSkgPT0gZGF0ZXRpbWUuZGF0ZXRpbWU6CiAgICAgICAgICAgICMgc29tZXRpbWVzIHRoYXQgaGFwcGVucyB0b28KICAgICAgICAgICAgdGltZXpvbmUgPSBweXR6LnRpbWV6b25lKHRpbWVfem9uZSkKICAgICAgICAgICAgcmV0dXJuIHRpbWV6b25lLmxvY2FsaXplKGRhdGV0aW1lX3RvX3BhcnNlKQogICAgICAgIGRhdGV0aW1lX3RvX3BhcnNlID0gc3RyKGRhdGV0aW1lX3RvX3BhcnNlKQogICAgICAgIGQgPSBkYXRldGltZS5kYXRldGltZS5zdHJwdGltZShkYXRldGltZV90b19wYXJzZSwgJyVZLSVtLSVkICVIOiVNOiVTJykKICAgICAgICB0aW1lem9uZSA9IHB5dHoudGltZXpvbmUodGltZV96b25lKQogICAgICAgIGQgPSB0aW1lem9uZS5sb2NhbGl6ZShkKQoKICAgICAgICAjIFNvbWV0aW1lcywgdGhpcyB3b3VsZCBiZSBhIGZha2UgZGF0ZSAoc2VlIGlzX2RhdGVfcmVhbCkuIGluIHRoaXMgY2FzZSByZXR1cm4gTm9uZQogICAgICAgIHJldHVybiBkIGlmIGlzX2RhdGVfcmVhbChkKSBlbHNlIE5vbmUKICAgIGV4Y2VwdCAoVHlwZUVycm9yLCBWYWx1ZUVycm9yKToKICAgICAgICByZXR1cm4gTm9uZQoKCmRlZiBub3JtYWxpemVfdGltZXpvbmVfZGF0ZShkYXRlX3N0cjogc3RyKSAtPiBzdHI6CiAgICAiIiIKICAgIENvbnZlcnRzIGdpdmVuIHN0cmluZyB0byBhIGRhdGV0aW1lIG9iamVjdCwgYWxvbmcgd2l0aCAnSXNyYWVsJyB0aW1lem9uZS4KICAgIFBhcnNlcyB0aGlzIGRhdGUgYW5kIGNvbnZlcnRzIGJhY2sgdG8gc3RyLCBub3cgaW4gVVRDIHRpbWUuCgogICAgOnBhcmFtIGRhdGVfc3RyOiBTdHJpbmcgcmVwcmVzZW50aW5nIGEgZGF0ZSBpbiBmb3JtYXQgJVktJW0tJWQgJUg6JU06JVMKICAgIDpyZXR1cm46CiAgICAiIiIKICAgIHBhcnNlZF9kYXRlID0gcGFyc2VfZGF0ZV93aXRoX3RpbWV6b25lKGRhdGVfc3RyLCAnSXNyYWVsJykKICAgIGlmIG5vdCBwYXJzZWRfZGF0ZToKICAgICAgICByZXR1cm4gZGF0ZV9zdHIKICAgIHJldHVybiBwYXJzZV9kYXRlKHBhcnNlZF9kYXRlKS5zdHJmdGltZSgnJVktJW0tJWQgJUg6JU06JVMnKQoKCmRlZiBpc19pdGVtc19pbl9saXN0MV9hcmVfaW5fbGlzdDIobGlzdDEsIGxpc3QyKToKICAgIGlmIG5vdCBsaXN0MSBvciBub3QgbGlzdDI6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICByZXR1cm4gYWxsKGl0ZW0gaW4gbGlzdDIgZm9yIGl0ZW0gaW4gbGlzdDEpCgoKZGVmIGRvZXNfbGlzdF9zdGFydHN3aXRoKGxpc3QxLCBsaXN0Mik6CiAgICAiIiIKICAgICBieSBzbGljaW5nIGxpc3QxIHRoZSBzaXplIG9mIGxpc3QyIGFuZCBjb21wYXJpbmcgdG8gbGlzdDIgd2UgY2FuIGNoZWNrIGlmIGxpc3QxIHN0YXJ0cyB3aXRoIGxpc3QyCiAgICA6cGFyYW0gbGlzdDE6IHRoZSBsaXN0IHRvIHRlc3QKICAgIDpwYXJhbSBsaXN0MjogdGhlIGxpc3Qgd2Ugd2FudCBsaXN0MSB0byBiZWdpbiB3aXRoCiAgICA6cmV0dXJuOiByZXR1cm5zIFRydWUgaWYgbGlzdDEgc3RhcnRzIHdpdGggbGlzdDIKICAgICIiIgogICAgcmV0dXJuIGxpc3QxWzpsZW4obGlzdDIpXSA9PSBsaXN0MgoKCmRlZiByZW1vdmVfdHJhaWxpbmcoc3RyaW5nLCB0cmFpbGluZyk6CiAgICB0aGVfbGVuID0gbGVuKHRyYWlsaW5nKQogICAgaWYgc3RyaW5nWy10aGVfbGVuOl0gPT0gdHJhaWxpbmc6CiAgICAgICAgcmV0dXJuIHN0cmluZ1s6LXRoZV9sZW5dCiAgICByZXR1cm4gc3RyaW5nCgoKZGVmIGdldF9lbnRpdHlfaWRfZm9yX3BsdWdpbl9uYW1lKGFzc29jaWF0ZWRfYWRhcHRlcnMsIHBsdWdpbl9uYW1lX2tleSk6CiAgICAiIiIKICAgIGl0ZXJhdGVzIG92ZXIgYXNzb2NpYXRlZF9hZGFwdGVycyBhbmQgcmV0dXJucyB0aGUgZW50aXR5IGlkIG9mIHRoZSBlbnRpdHkgaW5mbyByZXR1cm5lZCBmcm9tCiAgICAgICAgcGx1Z2luX25hbWVfa2V5IG9yIE5vbmUgaWYgcGx1Z2luX25hbWVfa2V5IGlzIG5vdCBvbmUgb2YgdGhlIGFkYXB0ZXJzIHdoaWNoIHJldHVybmVkIGluZm8gb24gdGhlIGVudGl0eQogICAgOnBhcmFtIGFzc29jaWF0ZWRfYWRhcHRlcnM6IHRoZSBhZGFwdGVycyBjb250YWluaW5nIGFsbCB0aGUgaW5mbyBvZiB0aGUgZW50aXR5CiAgICA6cGFyYW0gcGx1Z2luX25hbWVfa2V5OiB0aGUgcGx1Z2luX3VuaXF1ZV9uYW1lIGZvciB3aGljaCB0byBzZWVrIHRoZSBlbnRpdHkgaWQKICAgICIiIgogICAgcmV0dXJuIG5leHQoKGVudGl0eV9pZCBmb3IgcGx1Z2luX3VuaXF1ZV9uYW1lLCBlbnRpdHlfaWQgaW4gYXNzb2NpYXRlZF9hZGFwdGVycwogICAgICAgICAgICAgICAgIGlmIHBsdWdpbl9uYW1lX2tleSA9PSBwbHVnaW5fdW5pcXVlX25hbWUpLCBOb25lKQoKCmRlZiBleHRyYWN0X2FsbF9pcHMobmV0d29ya19pZnMpOgogICAgIiIiCiAgICA6cGFyYW0gbmV0d29ya19pZnM6IHRoZSBuZXR3b3JrX2lmcyBhcyBhcHBlYXIgaW4gdGhlIGF4b25pdXMgZGV2aWNlIHNjaGVtZQogICAgOnJldHVybjogeWllbGRzIGV2ZXJ5IGlwIGluIHRoZSBuZXR3b3JrIGludGVyZmFjZXMKICAgICIiIgogICAgZnJvbSBheG9uaXVzLmRldmljZXMuZGV2aWNlX2FkYXB0ZXIgaW1wb3J0IElQU19GSUVMRAogICAgaWYgbmV0d29ya19pZnMgaXMgTm9uZToKICAgICAgICByZXR1cm4KICAgIGZvciBuZXR3b3JrX2lmIGluIG5ldHdvcmtfaWZzOgogICAgICAgIGZvciBpcCBpbiBuZXR3b3JrX2lmLmdldChJUFNfRklFTEQpIG9yIFtdOgogICAgICAgICAgICBpZiBpcCBub3QgaW4gWycxMjcuMC4wLjEnXToKICAgICAgICAgICAgICAgIHlpZWxkIGlwCgoKZGVmIG5vcm1hbGl6ZV9tYWMobWFjKToKICAgIGlmIG1hYzoKICAgICAgICByZXR1cm4gbWFjLnVwcGVyKCkucmVwbGFjZSgnLScsICcnKS5yZXBsYWNlKCc6JywgJycpCgoKZGVmIGV4dHJhY3RfYWxsX21hY3MobmV0d29ya19pZnMpOgogICAgIiIiCiAgICA6cGFyYW0gbmV0d29ya19pZnM6IHRoZSBuZXR3b3JrX2lmcyBhcyBhcHBlYXIgaW4gdGhlIGF4b25pdXMgZGV2aWNlIHNjaGVtZQogICAgOnJldHVybjogeWllbGRzIGV2ZXJ5IG1hYyBpbiB0aGUgbmV0d29yayBpbnRlcmZhY2VzCiAgICAiIiIKICAgIGZyb20gYXhvbml1cy5kZXZpY2VzLmRldmljZV9hZGFwdGVyIGltcG9ydCBNQUNfRklFTEQKICAgIGlmIG5ldHdvcmtfaWZzIGlzIE5vbmU6CiAgICAgICAgcmV0dXJuCiAgICBmb3IgbmV0d29ya19pZiBpbiBuZXR3b3JrX2lmczoKICAgICAgICBjdXJyZW50X21hYyA9IG5ldHdvcmtfaWYuZ2V0KE1BQ19GSUVMRCwgJycpCiAgICAgICAgaWYgY3VycmVudF9tYWMgIT0gJycgYW5kIGN1cnJlbnRfbWFjIGlzIG5vdCBOb25lOgogICAgICAgICAgICB5aWVsZCBub3JtYWxpemVfbWFjKGN1cnJlbnRfbWFjKQoKCmRlZiBpc19vbmVfc3Vic2V0X29mX3RoZV9vdGhlcihmaXJzdF9zZXQsIHNlY29uZF9zZXQpOgogICAgIiIiCiAgICA6cGFyYW0gZmlyc3Rfc2V0OiBhIHNldAogICAgOnBhcmFtIHNlY29uZF9zZXQ6IGEgc2V0CiAgICA6cmV0dXJuOiBUcnVlIGlmIG9uZSBvZiB0aGUgc2V0cyBpcyBhIHN1YnNldCBvZiB0aGUgb3RoZXIKICAgICIiIgogICAgaWYgbm90IGZpcnN0X3NldCBvciBub3Qgc2Vjb25kX3NldDoKICAgICAgICByZXR1cm4gRmFsc2UKICAgIHJldHVybiBmaXJzdF9zZXQuaXNzdWJzZXQoc2Vjb25kX3NldCkgb3Igc2Vjb25kX3NldC5pc3N1YnNldChmaXJzdF9zZXQpCgoKZGVmIGNvbXBhcmVfb3NfdHlwZShhZGFwdGVyX2RldmljZTEsIGFkYXB0ZXJfZGV2aWNlMik6CiAgICBmcm9tIGF4b25pdXMuZGV2aWNlcy5kZXZpY2VfYWRhcHRlciBpbXBvcnQgT1NfRklFTEQKICAgIHJldHVybiBhZGFwdGVyX2RldmljZTFbJ2RhdGEnXVtPU19GSUVMRF1bJ3R5cGUnXSA9PSBhZGFwdGVyX2RldmljZTJbJ2RhdGEnXVtPU19GSUVMRF1bJ3R5cGUnXQoKCmRlZiBjb21wYXJlX2hvc3RuYW1lKGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKToKICAgIGhvc3RuYW1lMSA9IGFkYXB0ZXJfZGV2aWNlMVsnZGF0YSddLmdldCgnaG9zdG5hbWUnKQogICAgaG9zdG5hbWUyID0gYWRhcHRlcl9kZXZpY2UyWydkYXRhJ10uZ2V0KCdob3N0bmFtZScpCiAgICBpZiBub3QgaG9zdG5hbWUxIG9yIG5vdCBob3N0bmFtZTI6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICByZXR1cm4gaG9zdG5hbWUxLmxvd2VyKCkgPT0gaG9zdG5hbWUyLmxvd2VyKCkKCgpkZWYgY29tcGFyZV9hc3NldF9uYW1lKGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKToKICAgIHJldHVybiBhZGFwdGVyX2RldmljZTFbJ2RhdGEnXVsnbmFtZSddLmxvd2VyKCkgPT0gYWRhcHRlcl9kZXZpY2UyWydkYXRhJ11bJ25hbWUnXS5sb3dlcigpCgoKZGVmIGlzX2RpZmZlcmVudF9wbHVnaW4oYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpOgogICAgcmV0dXJuIGFkYXB0ZXJfZGV2aWNlMS5nZXQoJ3BsdWdpbl9uYW1lJykgIT0gYWRhcHRlcl9kZXZpY2UyLmdldCgncGx1Z2luX25hbWUnKQoKCmRlZiBpc19vbGRfZGV2aWNlKGFkYXB0ZXJfZGV2aWNlLCBudW1iZXJfb2ZfZGF5cz1ERUZBVUxUX05VTUJFUl9PRl9EQVlTX0ZPUl9PTERfREVWSUNFKToKICAgICIiIgogICAgVGhpcyBmdW5jdGlvbiBjaGVja3MgaXMgYSBkZWZhdWx0IHdhcyBsYXN0IHNlZW4gaW4gdGhlIGxhc3QgbnVtYmVyX29mX2RheXMKICAgICIiIgoKICAgIHRyeToKICAgICAgICByZXR1cm4gYWRhcHRlcl9kZXZpY2VbJ2RhdGEnXS5nZXQoJ2xhc3Rfc2VlbicsIGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpKS5yZXBsYWNlKHR6aW5mbz1Ob25lKSArIFwKICAgICAgICAgICAgZGF0ZXRpbWUudGltZWRlbHRhKGRheXM9bnVtYmVyX29mX2RheXMpIDwgXAogICAgICAgICAgICBkYXRldGltZS5kYXRldGltZS5ub3coKS5yZXBsYWNlKHR6aW5mbz1Ob25lKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAjIElmIHdlIGdvdCBleGNlcHRpb24gdGhlIGRlZmF1bHQgd291bGQgYmUgYXNzdW1pbmcgaXQgaXMgYW4gb2xkIGRldmljZQogICAgICAgIHJldHVybiBUcnVlCgoKZGVmIGlzX3Nub3dfYWRhcHRlcihhZGFwdGVyX2RldmljZSk6CiAgICByZXR1cm4gYWRhcHRlcl9kZXZpY2UuZ2V0KCdwbHVnaW5fbmFtZScpID09ICdzZXJ2aWNlX25vd19hZGFwdGVyJwoKCmRlZiBpc19haXJ3dGNoX2FkYXB0ZXIoYWRhcHRlcl9kZXZpY2UpOgogICAgcmV0dXJuIGFkYXB0ZXJfZGV2aWNlLmdldCgncGx1Z2luX25hbWUnKSA9PSAnYWlyd2F0Y2hfYWRhcHRlcicKCgpkZWYgaXNfbGFuc3dlZXJwX2RhcHRlcihhZGFwdGVyX2RldmljZSk6CiAgICByZXR1cm4gYWRhcHRlcl9kZXZpY2UuZ2V0KCdwbHVnaW5fbmFtZScpID09ICdsYW5zd2VlcGVyX2FkYXB0ZXInCgoKZGVmIGlzX2FsZXJ0bG9naWNfYWRhcHRlcihhZGFwdGVyX2RldmljZSk6CiAgICByZXR1cm4gYWRhcHRlcl9kZXZpY2UuZ2V0KCdwbHVnaW5fbmFtZScpID09ICdhbGVydGxvZ2ljX2FkYXB0ZXInCgoKZGVmIGlzX2JsdWVjYXRfYWRhcHRlcihhZGFwdGVyX2RldmljZSk6CiAgICByZXR1cm4gYWRhcHRlcl9kZXZpY2UuZ2V0KCdwbHVnaW5fbmFtZScpID09ICdibHVlY2F0X2FkYXB0ZXInCgoKZGVmIGlzX3F1YWx5c19hZGFwdGVyKGFkYXB0ZXJfZGV2aWNlKToKICAgIHJldHVybiBhZGFwdGVyX2RldmljZS5nZXQoJ3BsdWdpbl9uYW1lJykgPT0gJ3F1YWx5c19zY2Fuc19hZGFwdGVyJwoKCmRlZiBpc190ZW5hYmxlX2lvX2FkYXB0ZXIoYWRhcHRlcl9kZXZpY2UpOgogICAgcmV0dXJuIGFkYXB0ZXJfZGV2aWNlLmdldCgncGx1Z2luX25hbWUnKSA9PSAndGVuYWJsZV9pb19hZGFwdGVyJwoKCmRlZiBpc19jb3VudGVyX2FjdF9hZGFwdGVyKGFkYXB0ZXJfZGV2aWNlKToKICAgIHJldHVybiBhZGFwdGVyX2RldmljZS5nZXQoJ3BsdWdpbl9uYW1lJykgPT0gJ2NvdW50ZXJfYWN0X2FkYXB0ZXInCgoKZGVmIGlzX3NxbF9hZGFwdGVyKGFkYXB0ZXJfZGV2aWNlKToKICAgIHJldHVybiBhZGFwdGVyX2RldmljZS5nZXQoJ3BsdWdpbl9uYW1lJykgPT0gJ21zc3FsX2FkYXB0ZXInCgoKZGVmIGlzX2FxdWFfYWRhcHRlcihhZGFwdGVyX2RldmljZSk6CiAgICByZXR1cm4gYWRhcHRlcl9kZXZpY2UuZ2V0KCdwbHVnaW5fbmFtZScpID09ICdhcXVhX2FkYXB0ZXInCgoKZGVmIGlzX2Rhbmdlcm91c19hc3NldF9uYW1lc19hZGFwdGVyKGFkYXB0ZXJfZGV2aWNlKToKICAgIHJldHVybiBpc19zbm93X2FkYXB0ZXIoYWRhcHRlcl9kZXZpY2UpIG9yIGlzX2xhbnN3ZWVycF9kYXB0ZXIoYWRhcHRlcl9kZXZpY2UpIFwKICAgICAgICBvciBpc19hbGVydGxvZ2ljX2FkYXB0ZXIoYWRhcHRlcl9kZXZpY2UpIFwKICAgICAgICBvciBpc19ibHVlY2F0X2FkYXB0ZXIoYWRhcHRlcl9kZXZpY2UpIG9yIGlzX3F1YWx5c19hZGFwdGVyKGFkYXB0ZXJfZGV2aWNlKSBcCiAgICAgICAgb3IgaXNfY291bnRlcl9hY3RfYWRhcHRlcihhZGFwdGVyX2RldmljZSkgb3IgaXNfc3FsX2FkYXB0ZXIoYWRhcHRlcl9kZXZpY2UpIG9yIGlzX2FxdWFfYWRhcHRlcihhZGFwdGVyX2RldmljZSkKCgpkZWYgaG9zdG5hbWVfbm90X3Byb2JsZW1hdGljKGFkYXB0ZXJfZGV2aWNlKToKICAgIGlmIChub3QgZ2V0X25vcm1hbGl6ZWRfaG9zdG5hbWVfc3RyKGFkYXB0ZXJfZGV2aWNlKSBvcgogICAgICAgICAgICAoJ2xvY2FsaG9zdCcgbm90IGluIGdldF9ub3JtYWxpemVkX2hvc3RuYW1lX3N0cihhZGFwdGVyX2RldmljZSkuc3BsaXQoJy4nKVswXS5zdHJpcCgpLmxvd2VyKCkKICAgICAgICAgICAgIGFuZCAnaXBob25lJyBub3QgaW4gZ2V0X25vcm1hbGl6ZWRfaG9zdG5hbWVfc3RyKGFkYXB0ZXJfZGV2aWNlKS5zcGxpdCgnLicpWzBdLnN0cmlwKCkubG93ZXIoKQogICAgICAgICAgICAgYW5kICdpcGFkJyBub3QgaW4gZ2V0X25vcm1hbGl6ZWRfaG9zdG5hbWVfc3RyKGFkYXB0ZXJfZGV2aWNlKS5zcGxpdCgnLicpWzBdLnN0cmlwKCkubG93ZXIoKQogICAgICAgICAgICAgYW5kICdibGFuaycgIT0gZ2V0X25vcm1hbGl6ZWRfaG9zdG5hbWVfc3RyKGFkYXB0ZXJfZGV2aWNlKS5zcGxpdCgnLicpWzBdLnN0cmlwKCkubG93ZXIoKQogICAgICAgICAgICAgYW5kICdsb2FuZXInICE9IGdldF9ub3JtYWxpemVkX2hvc3RuYW1lX3N0cihhZGFwdGVyX2RldmljZSkuc3BsaXQoJy4nKVswXS5zdHJpcCgpLmxvd2VyKCkKICAgICAgICAgICAgIGFuZCAnbWFjYm9vay1haXInICE9IGdldF9ub3JtYWxpemVkX2hvc3RuYW1lX3N0cihhZGFwdGVyX2RldmljZSkuc3BsaXQoJy4nKVswXS5zdHJpcCgpLmxvd2VyKCkKICAgICAgICAgICAgIGFuZCAnbWFjLW1pbmknICE9IGdldF9ub3JtYWxpemVkX2hvc3RuYW1lX3N0cihhZGFwdGVyX2RldmljZSkuc3BsaXQoJy4nKVswXS5zdHJpcCgpLmxvd2VyKCkKICAgICAgICAgICAgIGFuZCAnYmlsbGluZycgIT0gZ2V0X25vcm1hbGl6ZWRfaG9zdG5hbWVfc3RyKGFkYXB0ZXJfZGV2aWNlKS5zcGxpdCgnLicpWzBdLnN0cmlwKCkubG93ZXIoKQogICAgICAgICAgICAgYW5kICd3b3JrJyAhPSBnZXRfbm9ybWFsaXplZF9ob3N0bmFtZV9zdHIoYWRhcHRlcl9kZXZpY2UpLnNwbGl0KCcuJylbMF0uc3RyaXAoKS5sb3dlcigpCiAgICAgICAgICAgICBhbmQgJ2Z1bGxzZXJ2aWNlJyAhPSBnZXRfbm9ybWFsaXplZF9ob3N0bmFtZV9zdHIoYWRhcHRlcl9kZXZpY2UpLnNwbGl0KCcuJylbMF0uc3RyaXAoKS5sb3dlcigpCiAgICAgICAgICAgICBhbmQgJ2hhcm1vbnknICE9IGdldF9ub3JtYWxpemVkX2hvc3RuYW1lX3N0cihhZGFwdGVyX2RldmljZSkuc3BsaXQoJy4nKVswXS5zdHJpcCgpLmxvd2VyKCkKICAgICAgICAgICAgIGFuZCAnY3MnICE9IGdldF9ub3JtYWxpemVkX2hvc3RuYW1lX3N0cihhZGFwdGVyX2RldmljZSkuc3BsaXQoJy4nKVswXS5zdHJpcCgpLmxvd2VyKCkKICAgICAgICAgICAgIGFuZCAndGltZWNsb2NrJyAhPSBnZXRfbm9ybWFsaXplZF9ob3N0bmFtZV9zdHIoYWRhcHRlcl9kZXZpY2UpLnNwbGl0KCcuJylbMF0uc3RyaXAoKS5sb3dlcigpCiAgICAgICAgICAgICBhbmQgJ29wcycgIT0gZ2V0X25vcm1hbGl6ZWRfaG9zdG5hbWVfc3RyKGFkYXB0ZXJfZGV2aWNlKS5zcGxpdCgnLicpWzBdLnN0cmlwKCkubG93ZXIoKQogICAgICAgICAgICAgYW5kICduL2EnICE9IGdldF9ub3JtYWxpemVkX2hvc3RuYW1lX3N0cihhZGFwdGVyX2RldmljZSkuc3BsaXQoJy4nKVswXS5zdHJpcCgpLmxvd2VyKCkKICAgICAgICAgICAgIGFuZCAnaXRhZG1pbnMtbWFjYm9vay1wcm8nICE9IGdldF9ub3JtYWxpemVkX2hvc3RuYW1lX3N0cihhZGFwdGVyX2RldmljZSkuc3BsaXQoJy4nKVswXS5zdHJpcCgpLmxvd2VyKCkKICAgICAgICAgICAgIGFuZCAnbWFjYm9vayBwcm8nICE9IGdldF9ub3JtYWxpemVkX2hvc3RuYW1lX3N0cihhZGFwdGVyX2RldmljZSkuc3BsaXQoJy4nKVswXS5zdHJpcCgpLmxvd2VyKCkKICAgICAgICAgICAgIGFuZCAnbWFjYm9vay1wcm8nICE9IGdldF9ub3JtYWxpemVkX2hvc3RuYW1lX3N0cihhZGFwdGVyX2RldmljZSkuc3BsaXQoJy4nKVswXS5zdHJpcCgpLmxvd2VyKCkpKToKICAgICAgICByZXR1cm4gVHJ1ZQogICAgcmV0dXJuIEZhbHNlCgoKZGVmIGlzX3NjY21fb3JfYWQoYWRhcHRlcl9kZXZpY2UpOgogICAgcmV0dXJuIGFkYXB0ZXJfZGV2aWNlLmdldCgncGx1Z2luX25hbWUnKSA9PSAnYWN0aXZlX2RpcmVjdG9yeV9hZGFwdGVyJyBvciBcCiAgICAgICAgYWRhcHRlcl9kZXZpY2UuZ2V0KCdwbHVnaW5fbmFtZScpID09ICdzY2NtX2FkYXB0ZXInCgoKZGVmIGlzX3Nub3dfZGV2aWNlKGFkYXB0ZXJfZGV2aWNlKToKICAgIHJldHVybiBhZGFwdGVyX2RldmljZS5nZXQoJ3BsdWdpbl9uYW1lJykgPT0gJ3NlcnZpY2Vfbm93X2FkYXB0ZXInCgoKZGVmIGlzX2Zyb21fdHdpc3Rsb2NrX29yX2F3cyhhZGFwdGVyX2RldmljZSk6CiAgICByZXR1cm4gKGFkYXB0ZXJfZGV2aWNlLmdldCgncGx1Z2luX25hbWUnKSA9PSAnYXdzX2FkYXB0ZXInIGFuZAogICAgICAgICAgICBhZGFwdGVyX2RldmljZVsnZGF0YSddLmdldCgnYXdzX2RldmljZV90eXBlJykgPT0gJ0VDMicpIG9yIFwKICAgICAgICBhZGFwdGVyX2RldmljZS5nZXQoJ3BsdWdpbl9uYW1lJykgPT0gJ3R3aXN0bG9ja19hZGFwdGVyJwoKCmRlZiBpc19mcm9tX2RlZXBzX29yX2F3cyhhZGFwdGVyX2RldmljZSk6CiAgICByZXR1cm4gKGFkYXB0ZXJfZGV2aWNlLmdldCgncGx1Z2luX25hbWUnKSA9PSAnYXdzX2FkYXB0ZXInIGFuZAogICAgICAgICAgICBhZGFwdGVyX2RldmljZVsnZGF0YSddLmdldCgnYXdzX2RldmljZV90eXBlJykgPT0gJ0VDMicpIFwKICAgICAgICBvciBhZGFwdGVyX2RldmljZS5nZXQoJ3BsdWdpbl9uYW1lJykgPT0gJ2RlZXBfc2VjdXJpdHlfYWRhcHRlcicKCgpkZWYgZ2V0X2Nsb3VkX2lkX29yX2hvc3RuYW1lKGFkYXB0ZXJfZGV2aWNlKToKICAgIGNsb3VkX2lkID0gYWRhcHRlcl9kZXZpY2VbJ2RhdGEnXS5nZXQoJ2Nsb3VkX2lkJykKICAgIGlmIGNsb3VkX2lkOgogICAgICAgIHJldHVybiBjbG91ZF9pZC5sb3dlcigpCiAgICBpZiBnZXRfaG9zdG5hbWUoYWRhcHRlcl9kZXZpY2UpOgogICAgICAgIHJldHVybiBnZXRfaG9zdG5hbWUoYWRhcHRlcl9kZXZpY2UpLmxvd2VyKCkKICAgIHJldHVybiBOb25lCgoKZGVmIGdldF9kbnNfbmFtZXMoYWRhcHRlcl9kZXZpY2UpOgogICAgZG5zX25hbWVzID0gYWRhcHRlcl9kZXZpY2VbJ2RhdGEnXS5nZXQoJ2Ruc19uYW1lcycpCiAgICBpZiBkbnNfbmFtZXM6CiAgICAgICAgcmV0dXJuIGRuc19uYW1lcwogICAgcmV0dXJuIE5vbmUKCgpkZWYgY29tcGFyZV9jbG91ZF9pZF9vcl9ob3N0bmFtZShhZGFwdGVyX2RldmljZTEsIGFkYXB0ZXJfZGV2aWNlMik6CiAgICBjbG91ZF9pZF9vcl9ob3N0bmFtZV8xID0gZ2V0X2Nsb3VkX2lkX29yX2hvc3RuYW1lKGFkYXB0ZXJfZGV2aWNlMSkKICAgIGNsb3VkX2lkX29yX2hvc3RuYW1lXzIgPSBnZXRfY2xvdWRfaWRfb3JfaG9zdG5hbWUoYWRhcHRlcl9kZXZpY2UyKQogICAgaWYgY2xvdWRfaWRfb3JfaG9zdG5hbWVfMSBhbmQgY2xvdWRfaWRfb3JfaG9zdG5hbWVfMjoKICAgICAgICByZXR1cm4gY2xvdWRfaWRfb3JfaG9zdG5hbWVfMSA9PSBjbG91ZF9pZF9vcl9ob3N0bmFtZV8yCiAgICByZXR1cm4gVHJ1ZQoKCmRlZiBpc19henVyZWFkX29yX2FkX2FuZF9oYXZlX25hbWUoYWRhcHRlcl9kZXZpY2UpOgogICAgIyBJdHMgZnJvbSBhZCBvciBhenVyZWFkIGFuZCBpdCBhbHNvIGhhcyBvbmUgb2YgdGhlc2UgZmllbGRzIG5vdCBOb25lLgogICAgcmV0dXJuIGFkYXB0ZXJfZGV2aWNlLmdldCgncGx1Z2luX25hbWUnKSBpbiAoJ2FjdGl2ZV9kaXJlY3RvcnlfYWRhcHRlcicsICdhenVyZV9hZF9hZGFwdGVyJykgYW5kIFwKICAgICAgICBnZXRfYWRfbmFtZV9vcl9henVyZV9kaXNwbGF5X25hbWUoYWRhcHRlcl9kZXZpY2UpCgoKZGVmIGlzX2Zyb21fbm9fbWFjX2FkYXB0ZXJzX3dpdGhfZW1wdHlfbWFjKGFkYXB0ZXJfZGV2aWNlKToKICAgIHJldHVybiAoYWRhcHRlcl9kZXZpY2VbJ3BsdWdpbl9uYW1lJ10gaW4gWydlcG9fYWRhcHRlcicsICdvYnNlcnZlaXRfYWRhcHRlcicsICdjeW5ldF9hZGFwdGVyJ10pIGFuZCBcCiAgICAgICAgICAgKG5vdCBhZGFwdGVyX2RldmljZS5nZXQoTk9STUFMSVpFRF9NQUNTKSkKCgpkZWYgaXNfZnJvbV9hZChhZGFwdGVyX2RldmljZSk6CiAgICByZXR1cm4gYWRhcHRlcl9kZXZpY2UuZ2V0KCdwbHVnaW5fbmFtZScpID09ICdhY3RpdmVfZGlyZWN0b3J5X2FkYXB0ZXInCgoKZGVmIGdldF9henVyZV9hZF9pZChhZGFwdGVyX2RldmljZSk6CiAgICByZXR1cm4gYWRhcHRlcl9kZXZpY2UuZ2V0KCdkYXRhJykuZ2V0KCdhenVyZV9hZF9pZCcpIG9yIGFkYXB0ZXJfZGV2aWNlLmdldCgnZGF0YScpLmdldCgnYXp1cmVfZGV2aWNlX2lkJykKCgpkZWYgY29tcGFyZV9henVyZV9hZF9pZChhZGFwdGVyX2RldmljZTEsIGFkYXB0ZXJfZGV2aWNlMik6CiAgICBhenVyZV9hZF9pZF8xID0gZ2V0X2F6dXJlX2FkX2lkKGFkYXB0ZXJfZGV2aWNlMSkKICAgIGF6dXJlX2FkX2lkXzIgPSBnZXRfYXp1cmVfYWRfaWQoYWRhcHRlcl9kZXZpY2UyKQogICAgaWYgYXp1cmVfYWRfaWRfMSBhbmQgYXp1cmVfYWRfaWRfMjoKICAgICAgICByZXR1cm4gYXp1cmVfYWRfaWRfMSA9PSBhenVyZV9hZF9pZF8yCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgaXNfZnJvbV9henVyZV9hZChhZGFwdGVyX2RldmljZSk6CiAgICByZXR1cm4gYWRhcHRlcl9kZXZpY2UuZ2V0KCdwbHVnaW5fbmFtZScpID09ICdhenVyZV9hZF9hZGFwdGVyJwoKCmRlZiBpc19mcm9tX2phbWYoYWRhcHRlcl9kZXZpY2UpOgogICAgcmV0dXJuIGFkYXB0ZXJfZGV2aWNlLmdldCgncGx1Z2luX25hbWUnKSA9PSAnamFtZl9hZGFwdGVyJwoKCmRlZiBpc19mcm9tX2FkX29yX2phbWYoYWRhcHRlcl9kZXZpY2UpOgogICAgcmV0dXJuIGFkYXB0ZXJfZGV2aWNlLmdldCgncGx1Z2luX25hbWUnKSBpbiBbJ2FjdGl2ZV9kaXJlY3RvcnlfYWRhcHRlcicsICdqYW1mX2FkYXB0ZXInXQoKCmRlZiBpc19zcGx1bmtfdnBuKGFkYXB0ZXJfZGV2aWNlKToKICAgIHJldHVybiBhZGFwdGVyX2RldmljZS5nZXQoJ3BsdWdpbl9uYW1lJykgPT0gJ3NwbHVua19hZGFwdGVyJyBhbmQgXAogICAgICAgIChhZGFwdGVyX2RldmljZS5nZXQoJ2RhdGEnKSBvciB7fSkuZ2V0KCdzcGx1bmtfc291cmNlJykgPT0gJ1ZQTicKCgpkZWYgaXNfaWxsdXNpdmVfYWRhcHRlcihhZGFwdGVyX2RldmljZSk6CiAgICByZXR1cm4gYWRhcHRlcl9kZXZpY2UuZ2V0KCdwbHVnaW5fbmFtZScpID09ICdpbGx1c2l2ZV9hZGFwdGVyJwoKCmRlZiBpc19qdW5vc19zcGFjZV9kZXZpY2UoYWRhcHRlcl9kZXZpY2UpOgogICAgcmV0dXJuIGFkYXB0ZXJfZGV2aWNlLmdldCgnZGF0YScsIHt9KS5nZXQoJ2RldmljZV90eXBlJykgPT0gJ0p1bmlwZXIgU3BhY2UgRGV2aWNlJwoKCmRlZiBpc19mcm9tX2p1bmlwZXJfYW5kX2Fzc2V0X25hbWUoYWRhcHRlcl9kZXZpY2UpOgogICAgcmV0dXJuIGFkYXB0ZXJfZGV2aWNlLmdldCgncGx1Z2luX25hbWUnKSBpbiBbJ2p1bmlwZXJfYWRhcHRlcicsICdqdW5vc19hZGFwdGVyJ10gYW5kIFwKICAgICAgICBhZGFwdGVyX2RldmljZS5nZXQoJ2RhdGEnLCB7fSkuZ2V0KCduYW1lJykKCgpkZWYgY29tcGFyZV9pZChhZGFwdGVyX2RldmljZTEsIGFkYXB0ZXJfZGV2aWNlMik6CiAgICByZXR1cm4gZ2V0X2lkKGFkYXB0ZXJfZGV2aWNlMSkgPT0gZ2V0X2lkKGFkYXB0ZXJfZGV2aWNlMikKCgpkZWYgZ2V0X29zX3R5cGUoYWRhcHRlcl9kZXZpY2UpOgogICAgZnJvbSBheG9uaXVzLmRldmljZXMuZGV2aWNlX2FkYXB0ZXIgaW1wb3J0IE9TX0ZJRUxECiAgICByZXR1cm4gKGFkYXB0ZXJfZGV2aWNlWydkYXRhJ10uZ2V0KE9TX0ZJRUxEKSBvciB7fSkuZ2V0KCd0eXBlJykKCgpkZWYgaXNfbGludXgoYWRhcHRlcl9kZXZpY2UpOgogICAgb3NfdHlwZSA9IGdldF9vc190eXBlKGFkYXB0ZXJfZGV2aWNlKQogICAgaWYgbm90IG9zX3R5cGU6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICBpZiBvc190eXBlLmxvd2VyKCkgPT0gJ2xpbnV4JzoKICAgICAgICByZXR1cm4gVHJ1ZQogICAgcmV0dXJuIEZhbHNlCgoKZGVmIGlzX3dpbmRvd3MoYWRhcHRlcl9kZXZpY2UpOgogICAgb3NfdHlwZSA9IGdldF9vc190eXBlKGFkYXB0ZXJfZGV2aWNlKQogICAgaWYgbm90IG9zX3R5cGU6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICBpZiBvc190eXBlLmxvd2VyKCkgPT0gJ3dpbmRvd3MnOgogICAgICAgIHJldHVybiBUcnVlCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgZ2V0X2lkKGFkYXB0ZXJfZGV2aWNlKToKICAgIHJldHVybiBhZGFwdGVyX2RldmljZVsnZGF0YSddLmdldCgnaWQnKQoKCmRlZiBnZXRfaG9zdG5hbWUoYWRhcHRlcl9kZXZpY2UpOgogICAgcmV0dXJuIGFkYXB0ZXJfZGV2aWNlWydkYXRhJ10uZ2V0KCdob3N0bmFtZScpCgoKZGVmIGNhbGN1bGF0ZV9ub3JtYWxpemVkX2hvc3RuYW1lKGFkYXB0ZXJfZGV2aWNlKSAtPiBzdHI6CiAgICBob3N0bmFtZSA9IGdldF9ob3N0bmFtZShhZGFwdGVyX2RldmljZSkKICAgIGlmIGhvc3RuYW1lOgogICAgICAgIHNwbGl0dGVkID0gaG9zdG5hbWUuc3BsaXQoJy4nKQogICAgICAgIGlmIHNwbGl0dGVkOgogICAgICAgICAgICByZXR1cm4gc3BsaXR0ZWRbMF0ubG93ZXIoKQogICAgcmV0dXJuIE5vbmUKCgpkZWYgZ2V0X2hvc3RuYW1lX25vX2xvY2FsaG9zdChhZGFwdGVyX2RldmljZSk6CiAgICBpZiBub3QgZ2V0X2hvc3RuYW1lKGFkYXB0ZXJfZGV2aWNlKToKICAgICAgICByZXR1cm4gTm9uZQogICAgaWYgZ2V0X2hvc3RuYW1lKGFkYXB0ZXJfZGV2aWNlKS5zcGxpdCgnLicpWzBdLmxvd2VyKCkgPT0gJ2xvY2FsaG9zdCc6CiAgICAgICAgcmV0dXJuIE5vbmUKICAgIHJldHVybiBnZXRfaG9zdG5hbWUoYWRhcHRlcl9kZXZpY2UpCgoKZGVmIGdldF9uZXNzdXNfbm9fc2Nhbl9pZChhZGFwdGVyX2RldmljZSk6CiAgICBuZXNzdXNfbm9fc2Nhbl9pZCA9IGFkYXB0ZXJfZGV2aWNlWydkYXRhJ10uZ2V0KCduZXNzdXNfbm9fc2Nhbl9pZCcpCiAgICBpZiBuZXNzdXNfbm9fc2Nhbl9pZDoKICAgICAgICByZXR1cm4gbmVzc3VzX25vX3NjYW5faWQubG93ZXIoKQogICAgcmV0dXJuIE5vbmUKCgpkZWYgY29tcGFyZV9uZXNzdXNfbm9fc2Nhbl9pZChhZGFwdGVyX2RldmljZTEsIGFkYXB0ZXJfZGV2aWNlMik6CiAgICBuZXNzdXNfbm9fc2Nhbl9pZF8xID0gZ2V0X25lc3N1c19ub19zY2FuX2lkKGFkYXB0ZXJfZGV2aWNlMSkKICAgIG5lc3N1c19ub19zY2FuX2lkXzIgPSBnZXRfbmVzc3VzX25vX3NjYW5faWQoYWRhcHRlcl9kZXZpY2UyKQogICAgaWYgbmVzc3VzX25vX3NjYW5faWRfMSBhbmQgbmVzc3VzX25vX3NjYW5faWRfMiBhbmQgbmVzc3VzX25vX3NjYW5faWRfMSA9PSBuZXNzdXNfbm9fc2Nhbl9pZF8yOgogICAgICAgIHJldHVybiBUcnVlCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgZ2V0X2RvbWFpbihhZGFwdGVyX2RldmljZSk6CiAgICBkb21haW4gPSBhZGFwdGVyX2RldmljZVsnZGF0YSddLmdldCgnZG9tYWluJykKICAgIGlmIGRvbWFpbiBhbmQgaXNfZG9tYWluX3ZhbGlkKGRvbWFpbik6CiAgICAgICAgcmV0dXJuIGRvbWFpbi51cHBlcigpCiAgICByZXR1cm4gTm9uZQoKCmRlZiBnZXRfbGFzdF91c2VkX3VzZXJzKGFkYXB0ZXJfZGV2aWNlKToKICAgIGxhc3RfdXNlZF91c2VyID0gYWRhcHRlcl9kZXZpY2VbJ2RhdGEnXS5nZXQoJ2xhc3RfdXNlZF91c2VycycpCiAgICBpZiBsYXN0X3VzZWRfdXNlcjoKICAgICAgICByZXR1cm4gW3VzZXIubG93ZXIoKS5zdHJpcCgpIGZvciB1c2VyIGluIGxhc3RfdXNlZF91c2VyIGlmICh1c2VyIGFuZCB1c2VyLnN0cmlwKCkpXQogICAgcmV0dXJuIE5vbmUKCgpkZWYgbm9ybWFsaXplX3VzZXJuYW1lKHVzZXJuYW1lKToKICAgIGlmIG5vdCB1c2VybmFtZToKICAgICAgICByZXR1cm4gTm9uZQogICAgdXNlcm5hbWUgPSB1c2VybmFtZS5sb3dlcigpCiAgICBpZiAnQCcgaW4gdXNlcm5hbWU6CiAgICAgICAgdXNlcm5hbWUgPSB1c2VybmFtZS5zcGxpdCgnQCcpWzBdCiAgICBpZiAnXFwnIGluIHVzZXJuYW1lOgogICAgICAgIHVzZXJuYW1lID0gdXNlcm5hbWUuc3BsaXQoJ1xcJylbMV0KICAgIHJldHVybiB1c2VybmFtZQoKCmRlZiBjb21wYXJlX2xhc3RfdXNlZF91c2VycyhhZGFwdGVyX2RldmljZTEsIGFkYXB0ZXJfZGV2aWNlMik6CiAgICBkZWYgbm9ybWFsaXplX3VzZXJzX2xpc3QodXNlcnNfbGlzdCk6CiAgICAgICAgcmV0dXJuIFtub3JtYWxpemVfdXNlcm5hbWUodXNlcm5hbWUpIGZvciB1c2VybmFtZSBpbiB1c2Vyc19saXN0CiAgICAgICAgICAgICAgICBpZiAobm9ybWFsaXplX3VzZXJuYW1lKHVzZXJuYW1lKSBhbmQgJ2FkbWluJyBub3QgaW4gdXNlcm5hbWUubG93ZXIoKSBhbmQgJ3VzZXInIG5vdCBpbiB1c2VybmFtZS5sb3dlcigpCiAgICAgICAgICAgICAgICAgICAgYW5kICdndWVzdCcgbm90IGluIHVzZXJuYW1lLmxvd2VyKCkgYW5kICdyb290JyBub3QgaW4gdXNlcm5hbWUubG93ZXIoKQogICAgICAgICAgICAgICAgICAgIGFuZCBub3QgdXNlcm5hbWUubG93ZXIoKS5zdGFydHN3aXRoKCdfJykgYW5kICdub2JvZHknIG5vdCBpbiB1c2VybmFtZS5sb3dlcigpCiAgICAgICAgICAgICAgICAgICAgYW5kICctc3ZjJyBub3QgaW4gdXNlcm5hbWUubG93ZXIoKSldCiAgICB1c2VyczEgPSBnZXRfbGFzdF91c2VkX3VzZXJzKGFkYXB0ZXJfZGV2aWNlMSkKICAgIHVzZXJzMiA9IGdldF9sYXN0X3VzZWRfdXNlcnMoYWRhcHRlcl9kZXZpY2UyKQogICAgaWYgbm90IHVzZXJzMSBvciBub3QgdXNlcnMyOgogICAgICAgIHJldHVybiBGYWxzZQogICAgdXNlcnMxID0gbm9ybWFsaXplX3VzZXJzX2xpc3QodXNlcnMxKQogICAgdXNlcnMyID0gbm9ybWFsaXplX3VzZXJzX2xpc3QodXNlcnMyKQogICAgaWYgbm90IHVzZXJzMSBvciBub3QgdXNlcnMyOgogICAgICAgIHJldHVybiBGYWxzZQogICAgcmV0dXJuIGlzX2l0ZW1zX2luX2xpc3QxX2FyZV9pbl9saXN0Mih1c2VyczEsIHVzZXJzMikgb3IgaXNfaXRlbXNfaW5fbGlzdDFfYXJlX2luX2xpc3QyKHVzZXJzMiwgdXNlcnMxKQoKCmRlZiBnZXRfdXVpZChhZGFwdGVyX2RldmljZSk6CiAgICB1dWlkID0gYWRhcHRlcl9kZXZpY2VbJ2RhdGEnXS5nZXQoJ3V1aWQnKQogICAgaWYgdXVpZCBhbmQgc3RyKHV1aWQpLmxvd2VyKCkgbm90IGluIFsnbm9uZScsICduL2EnLCAnMCcsICd1bmtub3duJywgJ3VuZGVmaW5lZCddOgogICAgICAgIHJldHVybiB1dWlkLmxvd2VyKCkKICAgIHJldHVybiBOb25lCgoKZGVmIGNvbXBhcmVfdXVpZChhZGFwdGVyX2RldmljZTEsIGFkYXB0ZXJfZGV2aWNlMik6CiAgICB1dWlkMSA9IGdldF91dWlkKGFkYXB0ZXJfZGV2aWNlMSkKICAgIHV1aWQyID0gZ2V0X3V1aWQoYWRhcHRlcl9kZXZpY2UyKQogICAgaWYgdXVpZDEgYW5kIHV1aWQyIGFuZCB1dWlkMSA9PSB1dWlkMjoKICAgICAgICByZXR1cm4gVHJ1ZQogICAgcmV0dXJuIEZhbHNlCgoKZGVmIGNvbXBhcmVfZG9tYWluKGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKToKICAgIGRvbWFpbjEgPSBnZXRfZG9tYWluKGFkYXB0ZXJfZGV2aWNlMSkKICAgIGRvbWFpbjIgPSBnZXRfZG9tYWluKGFkYXB0ZXJfZGV2aWNlMikKICAgIGlmIGRvbWFpbjEgYW5kIGRvbWFpbjI6CiAgICAgICAgaWYgZG9tYWluMSBpbiBkb21haW4yIG9yIGRvbWFpbjIgaW4gZG9tYWluMToKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgIHJldHVybiBGYWxzZQoKCmRlZiBnZXRfbm9ybWFsaXplZF9ob3N0bmFtZShhZGFwdGVyX2RldmljZSk6CiAgICByZXR1cm4gYWRhcHRlcl9kZXZpY2UuZ2V0KE5PUk1BTElaRURfSE9TVE5BTUUpCgoKZGVmIGdldF9ub3JtYWxpemVkX2hvc3RuYW1lX3N0cihhZGFwdGVyX2RldmljZSk6CiAgICByZXR1cm4gYWRhcHRlcl9kZXZpY2UuZ2V0KE5PUk1BTElaRURfSE9TVE5BTUVfU1RSSU5HKQoKCmRlZiBnZXRfYWRfbmFtZV9vcl9henVyZV9kaXNwbGF5X25hbWUoYWRhcHRlcl9kZXZpY2UpOgogICAgbmFtZSA9IGFkYXB0ZXJfZGV2aWNlWydkYXRhJ10uZ2V0KCdhZF9uYW1lJykgb3IgYWRhcHRlcl9kZXZpY2VbJ2RhdGEnXS5nZXQoJ2F6dXJlX2Rpc3BsYXlfbmFtZScpCiAgICBpZiBpc2luc3RhbmNlKG5hbWUsIHN0cik6CiAgICAgICAgaWYgbmFtZS5lbmRzd2l0aCgnJCcpOgogICAgICAgICAgICBuYW1lID0gbmFtZVs6LTFdCiAgICAgICAgcmV0dXJuIG5hbWUubG93ZXIoKQoKCmRlZiBjb21wYXJlX2FkX25hbWVfb3JfYXp1cmVfZGlzcGxheV9uYW1lKGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKToKICAgIG5hbWUxID0gZ2V0X2FkX25hbWVfb3JfYXp1cmVfZGlzcGxheV9uYW1lKGFkYXB0ZXJfZGV2aWNlMSkKICAgIG5hbWUyID0gZ2V0X2FkX25hbWVfb3JfYXp1cmVfZGlzcGxheV9uYW1lKGFkYXB0ZXJfZGV2aWNlMikKICAgIGlmIG5hbWUxIGFuZCBuYW1lMjoKICAgICAgICByZXR1cm4gbmFtZTEgPT0gbmFtZTIKICAgIHJldHVybiBGYWxzZQoKCmRlZiBnZXRfYmlvc19zZXJpYWxfb3Jfc2VyaWFsKGFkYXB0ZXJfZGV2aWNlKToKICAgIHNlcmlhbCA9IGFkYXB0ZXJfZGV2aWNlWydkYXRhJ10uZ2V0KCdiaW9zX3NlcmlhbCcpIG9yIGFkYXB0ZXJfZGV2aWNlWydkYXRhJ10uZ2V0KCdkZXZpY2Vfc2VyaWFsJykKICAgIGlmIHNlcmlhbCBpcyBub3QgTm9uZToKICAgICAgICBzZXJpYWwgPSBzdHIoc2VyaWFsKS5zdHJpcCgpLmxvd2VyKCkKICAgICAgICBpZiBzZXJpYWwgPT0gJycgb3IgKCdpbnZhbGlkJyBpbiBzZXJpYWwpIG9yICgnbm9uZScgaW4gc2VyaWFsKToKICAgICAgICAgICAgc2VyaWFsID0gTm9uZQogICAgICAgIGlmIHNlcmlhbCBhbmQgc2VyaWFsLnVwcGVyKCkuc3RyaXAoKS5yZXBsYWNlKCcgJywgJycpIGluIEJBRF9TRVJJQUxTOgogICAgICAgICAgICBzZXJpYWwgPSBOb25lCiAgICByZXR1cm4gc2VyaWFsCgoKZGVmIGNvbXBhcmVfYmlvc19zZXJpYWxfc2VyaWFsKGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKToKICAgIHNlcmlhbDEgPSBnZXRfYmlvc19zZXJpYWxfb3Jfc2VyaWFsKGFkYXB0ZXJfZGV2aWNlMSkKICAgIHNlcmlhbDIgPSBnZXRfYmlvc19zZXJpYWxfb3Jfc2VyaWFsKGFkYXB0ZXJfZGV2aWNlMikKICAgIGlmIHNlcmlhbDEgaXMgbm90IE5vbmUgYW5kIHNlcmlhbDIgaXMgbm90IE5vbmU6CiAgICAgICAgcmV0dXJuIHNlcmlhbDEgPT0gc2VyaWFsMgogICAgcmV0dXJuIEZhbHNlCgoKZGVmIGdldF9iaW9zX3NlcmlhbF9vcl9zZXJpYWxfbm9fcyhhZGFwdGVyX2RldmljZSk6CiAgICBzZXJpYWwgPSBnZXRfYmlvc19zZXJpYWxfb3Jfc2VyaWFsKGFkYXB0ZXJfZGV2aWNlKQogICAgaWYgc2VyaWFsOgogICAgICAgIHNlcmlhbCA9IHNlcmlhbC5zdHJpcCgncycpCiAgICByZXR1cm4gc2VyaWFsCgoKZGVmIGdldF9ob3N0bmFtZV9vcl9zZXJpYWwoYWRhcHRlcl9kZXZpY2UpOgogICAgc2VyaWFsID0gZ2V0X3NlcmlhbChhZGFwdGVyX2RldmljZSkKICAgIGlmIHNlcmlhbDoKICAgICAgICByZXR1cm4gc2VyaWFsLmxvd2VyKCkKICAgIGhvc3RuYW1lID0gZ2V0X2hvc3RuYW1lKGFkYXB0ZXJfZGV2aWNlKQogICAgaWYgaG9zdG5hbWU6CiAgICAgICAgcmV0dXJuIGhvc3RuYW1lLnNwbGl0KCcuJylbMF0ubG93ZXIoKQogICAgcmV0dXJuIE5vbmUKCgpkZWYgY29tcGFyZV9ob3N0bmFtZV9zZXJpYWwoYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpOgogICAgaG9zdF9zZXJpYWxfMSA9IGdldF9ob3N0bmFtZV9vcl9zZXJpYWwoYWRhcHRlcl9kZXZpY2UxKQogICAgaG9zdF9zZXJpYWxfMiA9IGdldF9ob3N0bmFtZV9vcl9zZXJpYWwoYWRhcHRlcl9kZXZpY2UyKQogICAgaWYgaG9zdF9zZXJpYWxfMSBhbmQgaG9zdF9zZXJpYWxfMiBhbmQgaG9zdF9zZXJpYWxfMSA9PSBob3N0X3NlcmlhbF8yOgogICAgICAgIHJldHVybiBUcnVlCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgY29tcGFyZV9iaW9zX3NlcmlhbF9zZXJpYWxfbm9fcyhhZGFwdGVyX2RldmljZTEsIGFkYXB0ZXJfZGV2aWNlMik6CiAgICBzZXJpYWwxID0gZ2V0X2Jpb3Nfc2VyaWFsX29yX3NlcmlhbF9ub19zKGFkYXB0ZXJfZGV2aWNlMSkKICAgIHNlcmlhbDIgPSBnZXRfYmlvc19zZXJpYWxfb3Jfc2VyaWFsX25vX3MoYWRhcHRlcl9kZXZpY2UyKQogICAgaWYgc2VyaWFsMSBpcyBub3QgTm9uZSBhbmQgc2VyaWFsMiBpcyBub3QgTm9uZToKICAgICAgICByZXR1cm4gc2VyaWFsMSA9PSBzZXJpYWwyCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgZ2V0X2Fzc2V0X25hbWUoYWRhcHRlcl9kZXZpY2UpOgogICAgaWYgYWRhcHRlcl9kZXZpY2VbJ2RhdGEnXS5nZXQoJ25hbWUnKSBhbmQgbm90IGlzX3F1YWx5c19hZGFwdGVyKGFkYXB0ZXJfZGV2aWNlKSBcCiAgICAgICAgICAgIGFuZCAobm90IGlzX2JsdWVjYXRfYWRhcHRlcihhZGFwdGVyX2RldmljZSkgb3Igbm90IGFkYXB0ZXJfZGV2aWNlLmdldChOT1JNQUxJWkVEX01BQ1MpKSBcCiAgICAgICAgICAgIGFuZCBub3QgaXNfdGVuYWJsZV9pb19hZGFwdGVyKGFkYXB0ZXJfZGV2aWNlKToKICAgICAgICByZXR1cm4gYWRhcHRlcl9kZXZpY2VbJ2RhdGEnXS5nZXQoJ25hbWUnKS51cHBlcigpCiAgICByZXR1cm4gTm9uZQoKCmRlZiBnZXRfc2VyaWFsKGFkYXB0ZXJfZGV2aWNlKToKICAgIHNlcmlhbCA9IChhZGFwdGVyX2RldmljZVsnZGF0YSddLmdldCgnZGV2aWNlX3NlcmlhbCcpIG9yICcnKS5zdHJpcCgpCiAgICBpZiBzZXJpYWwgXAogICAgICAgICAgICBhbmQgc2VyaWFsLnVwcGVyKCkuc3RyaXAoKS5yZXBsYWNlKCcgJywgJycpIG5vdCBpbiBCQURfU0VSSUFMUyBcCiAgICAgICAgICAgIGFuZCAnVk1XQVJFJyBub3QgaW4gc2VyaWFsLnVwcGVyKCkuc3RyaXAoKToKICAgICAgICByZXR1cm4gc2VyaWFsLnVwcGVyKCkKICAgIHJldHVybiBOb25lCgoKZGVmIGdldF9zZXJpYWxfbm9fcyhhZGFwdGVyX2RldmljZSk6CiAgICBzZXJpYWwgPSBnZXRfc2VyaWFsKGFkYXB0ZXJfZGV2aWNlKQogICAgaWYgbm90IHNlcmlhbDoKICAgICAgICByZXR1cm4gTm9uZQogICAgcmV0dXJuIHNlcmlhbC5zdHJpcCgnUycpCgoKZGVmIGNvbXBhcmVfc2VyaWFsX25vX3MoYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpOgogICAgc2VyaWFsMSA9IGdldF9zZXJpYWxfbm9fcyhhZGFwdGVyX2RldmljZTEpCiAgICBzZXJpYWwyID0gZ2V0X3NlcmlhbF9ub19zKGFkYXB0ZXJfZGV2aWNlMikKICAgIHJldHVybiBzZXJpYWwxIGFuZCBzZXJpYWwyIGFuZCBzZXJpYWwxID09IHNlcmlhbDIKCgpkZWYgZ2V0X2Fzc2V0X3Nub3dfb3JfaG9zdChhZGFwdGVyX2RldmljZSk6CiAgICBpZiBhZGFwdGVyX2RldmljZS5nZXQoJ3BsdWdpbl9uYW1lJykgPT0gJ3NlcnZpY2Vfbm93X2FkYXB0ZXInOgogICAgICAgIGFzc2V0ID0gZ2V0X2Fzc2V0X25hbWUoYWRhcHRlcl9kZXZpY2UpCiAgICBlbHNlOgogICAgICAgIGFzc2V0ID0gZ2V0X2hvc3RuYW1lKGFkYXB0ZXJfZGV2aWNlKQogICAgaWYgYXNzZXQ6CiAgICAgICAgcmV0dXJuIGFzc2V0Lmxvd2VyKCkuc3RyaXAoKQogICAgcmV0dXJuIE5vbmUKCgpkZWYgY29tcGFyZV9zbm93X2Fzc2V0X2hvc3RzKGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKToKICAgIGFzc2V0MSA9IGdldF9hc3NldF9zbm93X29yX2hvc3QoYWRhcHRlcl9kZXZpY2UxKQogICAgYXNzZXQyID0gZ2V0X2Fzc2V0X3Nub3dfb3JfaG9zdChhZGFwdGVyX2RldmljZTIpCiAgICBpZiBhc3NldDEgYW5kIGFzc2V0MiBhbmQgYXNzZXQxID09IGFzc2V0MjoKICAgICAgICByZXR1cm4gVHJ1ZQogICAgcmV0dXJuIEZhbHNlCgoKZGVmIGdldF9hc3NldF9vcl9ob3N0KGFkYXB0ZXJfZGV2aWNlKToKICAgIGFzc2V0ID0gZ2V0X2Fzc2V0X25hbWUoYWRhcHRlcl9kZXZpY2UpIG9yIGdldF9ob3N0bmFtZShhZGFwdGVyX2RldmljZSkKICAgIGlmIGFzc2V0OgogICAgICAgIGlmIGlzX3ZhbGlkX2lwKGFzc2V0KToKICAgICAgICAgICAgcmV0dXJuIGFzc2V0CiAgICAgICAgcmV0dXJuIGFzc2V0LnNwbGl0KCcuJylbMF0ubG93ZXIoKS5zdHJpcCgpCiAgICByZXR1cm4gTm9uZQoKCmRlZiBjb21wYXJlX2Fzc2V0X2hvc3RzKGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKToKICAgIGFzc2V0MSA9IGdldF9hc3NldF9vcl9ob3N0KGFkYXB0ZXJfZGV2aWNlMSkKICAgIGFzc2V0MiA9IGdldF9hc3NldF9vcl9ob3N0KGFkYXB0ZXJfZGV2aWNlMikKICAgIGlmIGFzc2V0MSBhbmQgYXNzZXQyIGFuZCBhc3NldDEgPT0gYXNzZXQyOgogICAgICAgIHJldHVybiBUcnVlCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgZ2V0X2Nsb3VkX2RhdGEoYWRhcHRlcl9kZXZpY2UpOgogICAgYWRhcHRlcl9kZXZpY2VfZGF0YSA9IGFkYXB0ZXJfZGV2aWNlLmdldCgnZGF0YScpIG9yIHt9CgogICAgY2xvdWRfcHJvdmlkZXIgPSBhZGFwdGVyX2RldmljZV9kYXRhLmdldCgnY2xvdWRfcHJvdmlkZXInKQogICAgY2xvdWRfaWQgPSBhZGFwdGVyX2RldmljZV9kYXRhLmdldCgnY2xvdWRfaWQnKQoKICAgIGlmIGlzaW5zdGFuY2UoY2xvdWRfcHJvdmlkZXIsIHN0cikgYW5kIGlzaW5zdGFuY2UoY2xvdWRfaWQsIHN0cikgYW5kIGxlbihjbG91ZF9wcm92aWRlcikgPiAwIGFuZCBsZW4oY2xvdWRfaWQpID4gMDoKICAgICAgICByZXR1cm4gY2xvdWRfcHJvdmlkZXIudXBwZXIoKS5zdHJpcCgpICsgJy0nICsgY2xvdWRfaWQudXBwZXIoKS5zdHJpcCgpCgogICAgcmV0dXJuIE5vbmUKCgpkZWYgY29tcGFyZV9jbG91ZHMoYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpOgogICAgY2xvdWQxID0gZ2V0X2Nsb3VkX2RhdGEoYWRhcHRlcl9kZXZpY2UxKQogICAgY2xvdWQyID0gZ2V0X2Nsb3VkX2RhdGEoYWRhcHRlcl9kZXZpY2UyKQoKICAgIGlmIGNsb3VkMSBpcyBub3QgTm9uZSBhbmQgY2xvdWQyIGlzIG5vdCBOb25lOgogICAgICAgIHJldHVybiBjbG91ZDEgPT0gY2xvdWQyCgogICAgcmV0dXJuIEZhbHNlCgoKZGVmIGhhc19tYWNfb3JfaXAoYWRhcHRlcl9kYXRhKToKICAgICIiIgogICAgY2hlY2tzIGlmIG9uZSBvZiB0aGUgbmV0d29yayBpbnRlcmZhY2VzIGluIGFkYXB0ZXIgZGF0YSBoYXMgYSBNQUMgb3IgaXAKICAgIDpwYXJhbSBhZGFwdGVyX2RhdGE6IHRoZSBkYXRhIG9mIHRoZSBhZGFwdGVyIHRvIHRlc3QKICAgIDpyZXR1cm46IFRydWUgaWYgdGhlcmUncyBhdCBsZWFzdCBvbmUgTUFDIG9yIElQCiAgICAiIiIKICAgIGZyb20gYXhvbml1cy5kZXZpY2VzLmRldmljZV9hZGFwdGVyIGltcG9ydCBORVRXT1JLX0lOVEVSRkFDRVNfRklFTEQsIElQU19GSUVMRCwgTUFDX0ZJRUxECiAgICByZXR1cm4gYW55KHguZ2V0KElQU19GSUVMRCkgb3IgeC5nZXQoTUFDX0ZJRUxEKSBmb3IgeCBpbiAoYWRhcHRlcl9kYXRhLmdldChORVRXT1JLX0lOVEVSRkFDRVNfRklFTEQpIG9yIFtdKSkKCgpkZWYgbm9ybWFsaXplX2hvc3RuYW1lKGFkYXB0ZXJfZGF0YSk6CiAgICBob3N0bmFtZSA9IGFkYXB0ZXJfZGF0YS5nZXQoJ2hvc3RuYW1lJykKICAgIGlmIGhvc3RuYW1lIGlzIG5vdCBOb25lOgogICAgICAgIGZpbmFsX2hvc3RuYW1lID0gaG9zdG5hbWUudXBwZXIoKQogICAgICAgIGFkYXB0ZXJfZGF0YVsnaG9zdG5hbWUnXSA9IGZpbmFsX2hvc3RuYW1lCiAgICAgICAgZmluYWxfaG9zdG5hbWUgPSBmaW5hbF9ob3N0bmFtZS5yZXBsYWNlKCcgJywgJy0nKQogICAgICAgIGZpbmFsX2hvc3RuYW1lID0gZmluYWxfaG9zdG5hbWUucmVwbGFjZSgnXCcnLCAnJykKICAgICAgICBmaW5hbF9ob3N0bmFtZSA9IGZpbmFsX2hvc3RuYW1lLnJlcGxhY2UoJ+KAmScsICcnKQogICAgICAgIGZvciBleHRlbnNpb24gaW4gREVGQVVMVF9ET01BSU5fRVhURU5TSU9OUzoKICAgICAgICAgICAgZmluYWxfaG9zdG5hbWUgPSByZW1vdmVfdHJhaWxpbmcoZmluYWxfaG9zdG5hbWUsIGV4dGVuc2lvbikKICAgICAgICBpZiBpc192YWxpZF9pcChmaW5hbF9ob3N0bmFtZSk6CiAgICAgICAgICAgIHNwbGl0X2hvc3RuYW1lID0gW2ZpbmFsX2hvc3RuYW1lXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNwbGl0X2hvc3RuYW1lID0gZmluYWxfaG9zdG5hbWUuc3BsaXQoJy4nKQoKICAgICAgICByZXR1cm4gc3BsaXRfaG9zdG5hbWUKCgpkZWYgY29tcGFyZV9ub3JtYWxpemVkX2hvc3RuYW1lcyhob3N0MSwgaG9zdDIsIGZpcnN0X2VsZW1lbnRfb25seT1GYWxzZSkgLT4gYm9vbDoKICAgICIiIgogICAgQXMgbWVudGlvbmVkIGFib3ZlIGluIHRoZSBkb2N1bWVudGF0aW9uIG5lYXIgdGhlIGRlZmluaXRpb24gb2YgTk9STUFMSVpFRF9IT1NUTkFNRSB3ZSB3YW50IHRvIGNvbXBhcmUgaG9zdG5hbWVzIG5vdAogICAgYmFzZWQgb24gdGhlIGRvbWFpbiBhcyBzb21lIGFkYXB0ZXJzIGRvbid0IHJldHVybiBvbmUgb3IgcmV0dXJuIGEgZGVmYXVsdCBvbmUgZXZlbiB3aGVuIG9uZSBleGlzdHMuIEFmdGVyIHdlCiAgICBzcGxpdCBlYWNoIGhvc3QgbmFtZSBvbiAiLiIgaWYgb25lIGxpc3Qgc3RhcnRzIHdpdGggdGhlIG90aGVyIC0gb25lIGhvc3RuYW1lIGlzIHRoZSBiZWdpbm5pbmcgb2YgdGhlIG90aGVyIG5vdAogICAgaW5jbHVkaW5nIHRoZSBkb21haW4gLSB3aGljaCBtZWFucyBpbiBvdXIgdmlldyAtIHRoZXkgYXJlIHRoZSBzYW1lIC0gZm9yIGV4YW1wbGU6CiAgICAxLiB1YnVudHVMb2xvbC5sb2NhbCA9PSB1YnVudHVsb2xvbC53b3JrZ3JvdXAgIC0tLSBiZWNhdXNlIGJvdGggaGF2ZSBhIGRlZmF1bHQgZG9tYWluCiAgICAyLiB1YnVudHVMb2xvbC5sb2NhbCA9PSB1YnVudHVsb2xvbC5heG9uaXVzICAtLS0gYmVjYXVzZSBvbmUgaGFzIGEgZGVmYXVsdCBkb21haW4gYW5kIHRoZSBvdGhlciBoYXMgYSBub3JtYWwgb25lCiAgICAgICAgd2hlbiBub3JtYWxpemluZyB0aGlzIHdvdWxkIGJlY29tZSBbJ3VidW50dUxvbG9sJ10sIFsndWJ1bnR1bG9sb2wnLCdheG9uaXVzJ10gYW5kIGxpc3QyIHN0YXJ0cyB3aXRoIGxpc3QxCiAgICAzLiB1YnVudHVMb2xvbC5sb2NhbC5heG9uaXVzICE9IHVidW50dWxvbG9sLjkgYXMgd2hlbiBub3JtYWxpemluZyB0aGV5J2QgYmVjb21lCiAgICAgICAgWyd1YnVudHVMb2xvbCcsICdsb2NhbCcsICdheG9uaXVzJ10sIFsndWJ1bnR1bG9sb2wnLCAnOSddIGFuZCBubyBsaXN0IGlzIHRoZSBiZWdpbm5pbmcgb2YgdGhlIG90aGVyLgogICAgIiIiCiAgICBpZiBmaXJzdF9lbGVtZW50X29ubHk6CiAgICAgICAgaWYgbGVuKGhvc3QxKSA+IDAgYW5kIGxlbihob3N0MikgPiAwIGFuZCBob3N0MVswXSAhPSAnJyBhbmQgaG9zdDJbMF0gIT0gJyc6CiAgICAgICAgICAgIHJldHVybiBob3N0MVswXVs6MTVdID09IGhvc3QyWzBdWzoxNV0KICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIGhvc3QxIGFuZCBob3N0MiBhbmQgaG9zdDFbMF0gPT0gaG9zdDJbMF0KCgpkZWYgaGF2ZV9tYWNfaW50ZXJzZWN0aW9uKGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKSAtPiBib29sOgogICAgIiIiCiAgICBJbiB0aGVzZSBjYXNlIHdlIGFyZSBsb29raW5nIGZvciBtYWMgaW50ZXJzZWN0aW9ucy4gV2UgZG8gdGhhdCBpbiBjYXNlcyB3aGVyZSBob3N0bmFtZSBhcmUgZXF1YWxzLAogICAgYnV0IElQcyBjb250cmFkaWN0LiBUaGlzIGNhbiBoYXBwZW5zIGZvciB2YXJpb3VzIHJlYXNvbnMgYXQgYWdlbnRzLiBJZiB3ZSBoYXZlIHNvbWUgbWFjIHdoaWNoIGlzIGVxdWFscywKICAgIHRoaXMgaXMgZW5vdWdoIGZvciBjb3JyZWxhdGlvbgogICAgOnBhcmFtIGFkYXB0ZXJfZGV2aWNlMToKICAgIDpwYXJhbSBhZGFwdGVyX2RldmljZTI6CiAgICA6cmV0dXJuIFdoZXRoZXIgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIG1hYyBpbiBib3RoIGFkYXB0ZXJfZGV2aWNlczoKICAgICIiIgogICAgZGV2aWNlMV9tYWNzID0gc2V0KGFkYXB0ZXJfZGV2aWNlMS5nZXQoTk9STUFMSVpFRF9NQUNTKSBvciBbXSkudW5pb24oCiAgICAgICAgc2V0KFtub3JtYWxpemVfbWFjKG1hY19yYXcpIGZvciBtYWNfcmF3IGluIChhZGFwdGVyX2RldmljZTFbJ2RhdGEnXS5nZXQoJ21hY3Nfbm9faXAnKSBvciBbXSldKSkKICAgIGRldmljZTJfbWFjcyA9IHNldChhZGFwdGVyX2RldmljZTIuZ2V0KE5PUk1BTElaRURfTUFDUykgb3IgW10pLnVuaW9uKAogICAgICAgIHNldChbbm9ybWFsaXplX21hYyhtYWNfcmF3KWZvciBtYWNfcmF3IGluIChhZGFwdGVyX2RldmljZTJbJ2RhdGEnXS5nZXQoJ21hY3Nfbm9faXAnKSBvciBbXSldKSkKICAgIHJldHVybiBib29sKGRldmljZTFfbWFjcy5pbnRlcnNlY3Rpb24oZGV2aWNlMl9tYWNzKSkKCgpkZWYgaXBzX2RvX25vdF9jb250cmFkaWN0X29yX21hY19pbnRlcnNlY3Rpb24oYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpOgogICAgcmV0dXJuIChpcHNfZG9fbm90X2NvbnRyYWRpY3QoYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpIGFuZCBnZXRfbm9ybWFsaXplZF9pcChhZGFwdGVyX2RldmljZTEpIGFuZCBnZXRfbm9ybWFsaXplZF9pcChhZGFwdGVyX2RldmljZTIpKSBvciBoYXZlX21hY19pbnRlcnNlY3Rpb24oYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpCgoKZGVmIGlwc19kb19ub3RfY29udHJhZGljdChhZGFwdGVyX2RldmljZTEsIGFkYXB0ZXJfZGV2aWNlMik6CiAgICBkZXZpY2UxX2lwcyA9IGFkYXB0ZXJfZGV2aWNlMS5nZXQoTk9STUFMSVpFRF9JUFMpCiAgICBkZXZpY2UyX2lwcyA9IGFkYXB0ZXJfZGV2aWNlMi5nZXQoTk9STUFMSVpFRF9JUFMpCiAgICBkZXZpY2UxX2lwc192NCA9IGFkYXB0ZXJfZGV2aWNlMS5nZXQoTk9STUFMSVpFRF9JUFNfNCkKICAgIGRldmljZTJfaXBzX3Y0ID0gYWRhcHRlcl9kZXZpY2UyLmdldChOT1JNQUxJWkVEX0lQU180KQogICAgcmV0dXJuIG5vdCBkZXZpY2UxX2lwcyBvciBub3QgZGV2aWNlMl9pcHMgb3IgaXNfb25lX3N1YnNldF9vZl90aGVfb3RoZXIoZGV2aWNlMV9pcHMsIGRldmljZTJfaXBzKSBvciAoZGV2aWNlMV9pcHNfdjQgYW5kIGRldmljZTJfaXBzX3Y0IGFuZCBpc19vbmVfc3Vic2V0X29mX3RoZV9vdGhlcihkZXZpY2UxX2lwc192NCwgZGV2aWNlMl9pcHNfdjQpKQoKCmRlZiBtYWNzX2RvX25vdF9jb250cmFkaWN0KGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKToKICAgIGRldmljZTFfbWFjcyA9IGFkYXB0ZXJfZGV2aWNlMS5nZXQoTk9STUFMSVpFRF9NQUNTKQogICAgZGV2aWNlMl9tYWNzID0gYWRhcHRlcl9kZXZpY2UyLmdldChOT1JNQUxJWkVEX01BQ1MpCiAgICByZXR1cm4gbm90IGRldmljZTFfbWFjcyBvciBub3QgZGV2aWNlMl9tYWNzIG9yIGhhdmVfbWFjX2ludGVyc2VjdGlvbihhZGFwdGVyX2RldmljZTEsIGFkYXB0ZXJfZGV2aWNlMikKCgpkZWYgbm90X3Nub3dfYWRhcHRlcnMoYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpOgogICAgcmV0dXJuIG5vdCBpc19zbm93X2FkYXB0ZXIoYWRhcHRlcl9kZXZpY2UxKSBhbmQgbm90IGlzX3Nub3dfYWRhcHRlcihhZGFwdGVyX2RldmljZTIpCgoKZGVmIG5vdF9haXJ3YXRjaF9hZGFwdGVycyhhZGFwdGVyX2RldmljZTEsIGFkYXB0ZXJfZGV2aWNlMik6CiAgICByZXR1cm4gbm90IGlzX2Fpcnd0Y2hfYWRhcHRlcihhZGFwdGVyX2RldmljZTEpIGFuZCBub3QgaXNfYWlyd3RjaF9hZGFwdGVyKGFkYXB0ZXJfZGV2aWNlMikKCgpkZWYgZGFuZ2Vyb3VzX2Fzc2V0X25hbWVzX2RvX25vdF9jb250cmFkaWN0KGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKToKICAgIGlmIGlzX2Rhbmdlcm91c19hc3NldF9uYW1lc19hZGFwdGVyKGFkYXB0ZXJfZGV2aWNlMSkgYW5kIGlzX2Rhbmdlcm91c19hc3NldF9uYW1lc19hZGFwdGVyKGFkYXB0ZXJfZGV2aWNlMik6CiAgICAgICAgYXNzZXQxID0gZ2V0X2Fzc2V0X25hbWUoYWRhcHRlcl9kZXZpY2UxKQogICAgICAgIGFzc2V0MiA9IGdldF9hc3NldF9uYW1lKGFkYXB0ZXJfZGV2aWNlMikKICAgICAgICBpZiBhc3NldDEgYW5kIGFzc2V0MiBhbmQgYXNzZXQxLmxvd2VyKCkgIT0gYXNzZXQyLmxvd2VyKCk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgZWxpZiBub3QgaXNfZGFuZ2Vyb3VzX2Fzc2V0X25hbWVzX2FkYXB0ZXIoYWRhcHRlcl9kZXZpY2UxKVwKICAgICAgICAgICAgYW5kIG5vdCBpc19kYW5nZXJvdXNfYXNzZXRfbmFtZXNfYWRhcHRlcihhZGFwdGVyX2RldmljZTIpOgogICAgICAgIHJldHVybiBUcnVlCiAgICBlbHNlOgogICAgICAgIGlmIGlzX2Rhbmdlcm91c19hc3NldF9uYW1lc19hZGFwdGVyKGFkYXB0ZXJfZGV2aWNlMSk6CiAgICAgICAgICAgIGFzc2V0MSA9IGdldF9hc3NldF9uYW1lKGFkYXB0ZXJfZGV2aWNlMSkKICAgICAgICAgICAgYXNzZXQyID0gZ2V0X2hvc3RuYW1lKGFkYXB0ZXJfZGV2aWNlMikKICAgICAgICAgICAgaWYgYXNzZXQxIGFuZCBhc3NldDIgYW5kIGFzc2V0MS5zcGxpdCgnLicpWzBdLmxvd2VyKCkgIT0gYXNzZXQyLnNwbGl0KCcuJylbMF0ubG93ZXIoKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGlmIGlzX2Rhbmdlcm91c19hc3NldF9uYW1lc19hZGFwdGVyKGFkYXB0ZXJfZGV2aWNlMik6CiAgICAgICAgICAgIGFzc2V0MSA9IGdldF9ob3N0bmFtZShhZGFwdGVyX2RldmljZTEpCiAgICAgICAgICAgIGFzc2V0MiA9IGdldF9hc3NldF9uYW1lKGFkYXB0ZXJfZGV2aWNlMikKICAgICAgICAgICAgaWYgYXNzZXQxIGFuZCBhc3NldDIgYW5kIGFzc2V0MS5zcGxpdCgnLicpWzBdLmxvd2VyKCkgIT0gYXNzZXQyLnNwbGl0KCcuJylbMF0ubG93ZXIoKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgcmV0dXJuIFRydWUKCgpkZWYgYXNzZXRfaG9zdG5hbWVzX2RvX25vdF9jb250cmFkaWN0KGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKToKICAgIHJldHVybiBob3N0bmFtZXNfZG9fbm90X2NvbnRyYWRpY3QoYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpIGFuZCBcCiAgICAgICAgZGFuZ2Vyb3VzX2Fzc2V0X25hbWVzX2RvX25vdF9jb250cmFkaWN0KGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKQoKCmRlZiBzZXJpYWxzX2RvX25vdF9jb250cmFkaWN0KGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKToKICAgIHNlcmlhbDEgPSBnZXRfc2VyaWFsKGFkYXB0ZXJfZGV2aWNlMSkKICAgIHNlcmlhbDIgPSBnZXRfc2VyaWFsKGFkYXB0ZXJfZGV2aWNlMikKICAgIGlmIG5vdCBzZXJpYWwxIG9yIG5vdCBzZXJpYWwyOgogICAgICAgIHJldHVybiBUcnVlCiAgICByZXR1cm4gc2VyaWFsMSA9PSBzZXJpYWwyCgoKZGVmIGhvc3RuYW1lc19kb19ub3RfY29udHJhZGljdChhZGFwdGVyX2RldmljZTEsIGFkYXB0ZXJfZGV2aWNlMik6CiAgICBpZiBub3QgZ2V0X2hvc3RuYW1lKGFkYXB0ZXJfZGV2aWNlMSkgb3Igbm90IGdldF9ob3N0bmFtZShhZGFwdGVyX2RldmljZTIpOgogICAgICAgIHJldHVybiBUcnVlCiAgICByZXR1cm4gY29tcGFyZV9kZXZpY2Vfbm9ybWFsaXplZF9ob3N0bmFtZShhZGFwdGVyX2RldmljZTEsIGFkYXB0ZXJfZGV2aWNlMikKCgpkZWYgb3NfZG9fbm90X2NvbnRyYWRpY3QoYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpOgogICAgaWYgbm90IGdldF9vc190eXBlKGFkYXB0ZXJfZGV2aWNlMSkgb3Igbm90IGdldF9vc190eXBlKGFkYXB0ZXJfZGV2aWNlMik6CiAgICAgICAgcmV0dXJuIFRydWUKICAgIHJldHVybiBnZXRfb3NfdHlwZShhZGFwdGVyX2RldmljZTEpID09IGdldF9vc190eXBlKGFkYXB0ZXJfZGV2aWNlMikKCgpkZWYgbm90X2NvbnRhaW5fZ2VuZXJpY19qYW1mX25hbWVzKGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKToKICAgIHJldHVybiBub3QgY29udGFpbl9qYW1mX2dlbmVyaWNfbmFtZXMoYWRhcHRlcl9kZXZpY2UxKSBvciBub3QgY29udGFpbl9qYW1mX2dlbmVyaWNfbmFtZXMoYWRhcHRlcl9kZXZpY2UyKQoKCmRlZiBjb250YWluX2phbWZfZ2VuZXJpY19uYW1lcyhhZGFwdGVyX2RldmljZSk6CiAgICBob3N0bmFtZSA9IGdldF9ob3N0bmFtZShhZGFwdGVyX2RldmljZSkKICAgIGlmIG5vdCBob3N0bmFtZToKICAgICAgICByZXR1cm4gRmFsc2UKICAgIGlmICdNYWNCb29rJyBpbiBob3N0bmFtZSBvciAnTUJQJyBpbiBob3N0bmFtZSBvciAnbG9jYWxob3N0JyBpbiBob3N0bmFtZSBvclwKICAgICAgICAgICAgJ2lQYWQnIGluIGhvc3RuYW1lIG9yICdpUGhvbmUnIGluIGhvc3RuYW1lIG9yICdpTWFjJyBpbiBob3N0bmFtZSBvciAnbWluaScgaW4gaG9zdG5hbWVcCiAgICAgICAgICAgIG9yICdNYWMtbWluaScgaW4gaG9zdG5hbWUgb3IgJ1Rlc3RzLU1hY0Jvb2stUHJvJyBpbiBob3N0bmFtZSBcCiAgICAgICAgICAgIG9yICdsb2FuZXInIGluIGhvc3RuYW1lIG9yICdibGFuaycgaW4gaG9zdG5hbWUgb3IgJ01hY0Jvb2stQWlyJyBpbiBob3N0bmFtZToKICAgICAgICByZXR1cm4gVHJ1ZQogICAgcmV0dXJuIEZhbHNlCgoKZGVmIGNsb3VkX2lkX2RvX25vdF9jb250cmFkaWN0KGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKToKICAgIGNsb3VkX2lkXzEgPSBnZXRfY2xvdWRfZGF0YShhZGFwdGVyX2RldmljZTEpCiAgICBjbG91ZF9pZF8yID0gZ2V0X2Nsb3VkX2RhdGEoYWRhcHRlcl9kZXZpY2UyKQogICAgaWYgbm90IGNsb3VkX2lkXzEgb3Igbm90IGNsb3VkX2lkXzI6CiAgICAgICAgcmV0dXJuIFRydWUKICAgIHJldHVybiBjbG91ZF9pZF8xID09IGNsb3VkX2lkXzIKCgpkZWYgY29tcGFyZV9pcHMoYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpOgogICAgcmV0dXJuIGlzX29uZV9zdWJzZXRfb2ZfdGhlX290aGVyKGFkYXB0ZXJfZGV2aWNlMS5nZXQoTk9STUFMSVpFRF9JUFMpLCBhZGFwdGVyX2RldmljZTIuZ2V0KE5PUk1BTElaRURfSVBTKSkKCgpkZWYgb3Nfbm90X2NvbnRyYWRpY3QoYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpOgogICAgb3NfdHlwZTEgPSBnZXRfb3NfdHlwZShhZGFwdGVyX2RldmljZTEpCiAgICBvc190eXBlMiA9IGdldF9vc190eXBlKGFkYXB0ZXJfZGV2aWNlMikKICAgIGlmIG9zX3R5cGUxIGFuZCBvc190eXBlMiBhbmQgJ1dpbmRvd3MnIGluIFtvc190eXBlMSwgb3NfdHlwZTJdIGFuZCAnT1MgWCcgaW4gW29zX3R5cGUxLCBvc190eXBlMl06CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICByZXR1cm4gVHJ1ZQoKCmRlZiBjb21wYXJlX21hY3Nfb3Jfb25lX2lzX2phbWYoYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpOgogICAgcmV0dXJuIChjb21wYXJlX21hY3MoYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpIG9yIGlzX2Zyb21famFtZihhZGFwdGVyX2RldmljZTEpIG9yCiAgICAgICAgICAgIGlzX2Zyb21famFtZihhZGFwdGVyX2RldmljZTIpKSBhbmQgb3Nfbm90X2NvbnRyYWRpY3QoYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpCgoKZGVmIGNvbXBhcmVfZnVsbF9tYWMoYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpOgogICAgZmlyc3Rfc2V0ID0gYWRhcHRlcl9kZXZpY2UxLmdldChOT1JNQUxJWkVEX01BQ1MpCiAgICBzZWNvbmRfc2V0ID0gYWRhcHRlcl9kZXZpY2UyLmdldChOT1JNQUxJWkVEX01BQ1MpCiAgICByZXR1cm4gZmlyc3Rfc2V0Lmlzc3Vic2V0KHNlY29uZF9zZXQpIGFuZCBzZWNvbmRfc2V0Lmlzc3Vic2V0KGZpcnN0X3NldCkKCgpkZWYgY29tcGFyZV9tYWNzKGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKToKICAgIHJldHVybiBpc19vbmVfc3Vic2V0X29mX3RoZV9vdGhlcihhZGFwdGVyX2RldmljZTEuZ2V0KE5PUk1BTElaRURfTUFDUyksIGFkYXB0ZXJfZGV2aWNlMi5nZXQoTk9STUFMSVpFRF9NQUNTKSkKCgpkZWYgY29tcGFyZV9kbnNfbmFtZXMoYWRhcHRlcl9kZXZpY2UxLCBhZGFwdGVyX2RldmljZTIpOgogICAgYWQxX2Ruc19uYW1lcyA9IGFkYXB0ZXJfZGV2aWNlMVsnZGF0YSddLmdldCgnZG5zX25hbWVzJykKICAgIGFkMl9kbnNfbmFtZXMgPSBhZGFwdGVyX2RldmljZTJbJ2RhdGEnXS5nZXQoJ2Ruc19uYW1lcycpCiAgICBpZiBub3QgaXNpbnN0YW5jZShhZDFfZG5zX25hbWVzLCBsaXN0KSBvciBub3QgaXNpbnN0YW5jZShhZDJfZG5zX25hbWVzLCBsaXN0KToKICAgICAgICByZXR1cm4gRmFsc2UKICAgIGFkMV9kbnNfbmFtZXMgPSBzZXQoZG5zX25hbWUudXBwZXIoKSBmb3IgZG5zX25hbWUgaW4gYWQxX2Ruc19uYW1lcykKICAgIGFkMl9kbnNfbmFtZXMgPSBzZXQoZG5zX25hbWUudXBwZXIoKSBmb3IgZG5zX25hbWUgaW4gYWQyX2Ruc19uYW1lcykKICAgIHJldHVybiBpc19vbmVfc3Vic2V0X29mX3RoZV9vdGhlcihhZDFfZG5zX25hbWVzLCBhZDJfZG5zX25hbWVzKQoKCmRlZiBjb21wYXJlX2RldmljZV9ub3JtYWxpemVkX2hvc3RuYW1lKGFkYXB0ZXJfZGV2aWNlMSwgYWRhcHRlcl9kZXZpY2UyKSAtPiBib29sOgogICAgIiIiCiAgICBTZWUgY29tcGFyZV9ub3JtYWxpemVkX2hvc3RuYW1lcyBkb2NzCiAgICA6cGFyYW0gYWRhcHRlcl9kZXZpY2UxOiBmaXJzdCBkZXZpY2UKICAgIDpwYXJhbSBhZGFwdGVyX2RldmljZTI6IHNlY29uZCBkZXZpY2UKICAgIDpyZXR1cm46CiAgICAiIiIKICAgIGRlZiBpc19pbl9zaG9ydF9uYW1lc19hZGFwdGVyc19hbmRfbG9uZ19uYW1lKGFkYXB0ZXJfZGV2aWNlKToKICAgICAgICBpZiBhZGFwdGVyX2RldmljZS5nZXQoJ3BsdWdpbl9uYW1lJykgaW4gWydjYXJib25ibGFja19wcm90ZWN0aW9uX2FkYXB0ZXInLCAnYWN0aXZlX2RpcmVjdG9yeV9hZGFwdGVyJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYW5zd2VlcGVyX2FkYXB0ZXInLCAnc2NjbV9hZGFwdGVyJ10gXAogICAgICAgICAgICAgICAgYW5kIGxlbihnZXRfaG9zdG5hbWUoYWRhcHRlcl9kZXZpY2UpLnNwbGl0KCcuJylbMF0pID09IE5FVF9CSU9TX01BWF9MRU5HVEg6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZmlyc3RfZWxlbWVudF9vbmx5ID0gRmFsc2UKICAgIGlmIGlzX2luX3Nob3J0X25hbWVzX2FkYXB0ZXJzX2FuZF9sb25nX25hbWUoYWRhcHRlcl9kZXZpY2UyKToKICAgICAgICBmaXJzdF9lbGVtZW50X29ubHkgPSBUcnVlCiAgICBpZiBpc19pbl9zaG9ydF9uYW1lc19hZGFwdGVyc19hbmRfbG9uZ19uYW1lKGFkYXB0ZXJfZGV2aWNlMSk6CiAgICAgICAgZmlyc3RfZWxlbWVudF9vbmx5ID0gVHJ1ZQogICAgcmV0dXJuIGNvbXBhcmVfbm9ybWFsaXplZF9ob3N0bmFtZXMoYWRhcHRlcl9kZXZpY2UxLmdldChOT1JNQUxJWkVEX0hPU1ROQU1FKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkYXB0ZXJfZGV2aWNlMi5nZXQoTk9STUFMSVpFRF9IT1NUTkFNRSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdF9lbGVtZW50X29ubHkpCgoKZGVmIGdldF9ub3JtYWxpemVkX2lwKGFkYXB0ZXJfZGV2aWNlKToKICAgIHJldHVybiBhZGFwdGVyX2RldmljZS5nZXQoTk9STUFMSVpFRF9JUFMpCgoKZGVmIG5vcm1hbGl6ZV9hZGFwdGVyX2RldmljZXMoZGV2aWNlcyk6CiAgICAiIiIKICAgIGluIG9yZGVyIHRvIHNhdmUgYSBsb3Qgb2YgdGltZSBsYXRlciAtIHdlIG5vcm1hbGl6ZSB0aGUgYWRhcHRlciBkZXZpY2VzLgogICAgICAgIGV2ZXJ5IGFkYXB0ZXJfZGV2aWNlIHdpdGggYW4gaXAgb3IgbWFjIGlzIGdpdmVuIGEgY29ycmVzcG9uZGluZyBzZXQgaW4gdGhlIHJvb3Qgb2YgdGhlIGFkYXB0ZXJfZGV2aWNlLgogICAgICAgIHdlIHVwcGVyIHRoZSBob3N0bmFtZSBvZiBldmVyeSBhZGFwdGVyX2RldmljZSB3aXRoIGEgaG9zdG5hbWUKICAgICAgICB3ZSB1cHBlciB0aGUgb3MgdHlwZSBvZiBldmVyeSBhZGFwdGVyX2RldmljZSB3aXRoIGEgb3MgdHlwZQogICAgOnBhcmFtIGRldmljZXM6IGFsbCBvZiB0aGUgZGV2aWNlcyB0byBiZSBjb3JyZWxhdGVkCiAgICA6cmV0dXJuOiBhIG5vcm1hbGl6ZWQgbGlzdCBvZiB0aGUgYWRhcHRlcl9kZXZpY2VzCiAgICAiIiIKICAgIGZvciBkZXZpY2UgaW4gZGV2aWNlczoKICAgICAgICBmb3IgYWRhcHRlcl9kZXZpY2UgaW4gZGV2aWNlWydhZGFwdGVycyddOgogICAgICAgICAgICB5aWVsZCBub3JtYWxpemVfYWRhcHRlcl9kZXZpY2UoYWRhcHRlcl9kZXZpY2UpCiAgICAgICAgZm9yIHRhZyBpbiBkZXZpY2UuZ2V0KCd0YWdzJywgW10pOgogICAgICAgICAgICBpZiB0YWcuZ2V0KCdlbnRpdHknKSA9PSBFbnRpdHlUeXBlLkRldmljZXMudmFsdWUgYW5kIFwKICAgICAgICAgICAgICAgICAgICB0YWcuZ2V0KCd0eXBlJykgPT0gJ2FkYXB0ZXJkYXRhJyBhbmQgXAogICAgICAgICAgICAgICAgICAgIHRhZy5nZXQoJ2Fzc29jaWF0ZWRfYWRhcHRlcl9wbHVnaW5fbmFtZScpIGFuZCBcCiAgICAgICAgICAgICAgICAgICAgbGVuKHRhZy5nZXQoJ2Fzc29jaWF0ZWRfYWRhcHRlcnMnLCBbXSkpID09IDE6CiAgICAgICAgICAgICAgICB5aWVsZCBub3JtYWxpemVfYWRhcHRlcl9kZXZpY2UodGFnKQoKCmRlZiBub3JtYWxpemVfYWRhcHRlcl9kZXZpY2UoYWRhcHRlcl9kZXZpY2UpOgogICAgIiIiCiAgICBTZWUgbm9ybWFsaXplX2FkYXB0ZXJfZGV2aWNlcwogICAgIiIiCiAgICBmcm9tIGF4b25pdXMuZGV2aWNlcy5kZXZpY2VfYWRhcHRlciBpbXBvcnQgT1NfRklFTEQsIE5FVFdPUktfSU5URVJGQUNFU19GSUVMRAogICAgYWRhcHRlcl9kYXRhID0gYWRhcHRlcl9kZXZpY2VbJ2RhdGEnXQogICAgaWYgaGFzX21hY19vcl9pcChhZGFwdGVyX2RhdGEpOgogICAgICAgIGlwcyA9IHNldChleHRyYWN0X2FsbF9pcHMoYWRhcHRlcl9kYXRhW05FVFdPUktfSU5URVJGQUNFU19GSUVMRF0pKQogICAgICAgIG1hY3MgPSBzZXQoZXh0cmFjdF9hbGxfbWFjcyhhZGFwdGVyX2RhdGFbTkVUV09SS19JTlRFUkZBQ0VTX0ZJRUxEXSkpCiAgICAgICAgYWRhcHRlcl9kZXZpY2VbTk9STUFMSVpFRF9JUFNdID0gaXBzIGlmIGxlbihpcHMpID4gMCBlbHNlIE5vbmUKICAgICAgICBpZiBsZW4oaXBzKSA+IDA6CiAgICAgICAgICAgIGFkYXB0ZXJfZGV2aWNlW05PUk1BTElaRURfSVBTXzRdID0gc2V0KFtpcCBmb3IgaXAgaW4gaXBzIGlmIGlzX3ZhbGlkX2lwdjQoaXApXSkKICAgICAgICAgICAgYWRhcHRlcl9kZXZpY2VbTk9STUFMSVpFRF9JUFNfNl0gPSBzZXQoW2lwIGZvciBpcCBpbiBpcHMgaWYgaXNfdmFsaWRfaXB2NihpcCldKQogICAgICAgIGFkYXB0ZXJfZGV2aWNlW05PUk1BTElaRURfTUFDU10gPSBtYWNzIGlmIGxlbihtYWNzKSA+IDAgZWxzZSBOb25lCiAgICAjIFNhdmUgdGhlIG5vcm1hbGl6ZWQgaG9zdG5hbWUgc28gd2UgY2FuIGxhdGVyIGVhc2lseSBjb21wYXJlLgogICAgIyBTZWUgZnVydGhlciBkb2MgbmVhciBkZWZpbml0aW9uIG9mIE5PUk1BTElaRURfSE9TVE5BTUUuCiAgICBhZGFwdGVyX2RldmljZVtOT1JNQUxJWkVEX0hPU1ROQU1FXSA9IG5vcm1hbGl6ZV9ob3N0bmFtZShhZGFwdGVyX2RhdGEpCiAgICBpZiBhZGFwdGVyX2RldmljZVtOT1JNQUxJWkVEX0hPU1ROQU1FXToKICAgICAgICBhZGFwdGVyX2RldmljZVtOT1JNQUxJWkVEX0hPU1ROQU1FX1NUUklOR10gPSAnLicuam9pbihhZGFwdGVyX2RldmljZVtOT1JNQUxJWkVEX0hPU1ROQU1FXSkgKyAnLicKICAgIGlmIG5vdCBhZGFwdGVyX2RldmljZS5nZXQoTk9STUFMSVpFRF9IT1NUTkFNRV9TVFJJTkcpIGFuZCBcCiAgICAgICAgICAgIGlzX2Zyb21fYXp1cmVfYWQoYWRhcHRlcl9kZXZpY2UpIGFuZCBnZXRfYXNzZXRfbmFtZShhZGFwdGVyX2RldmljZSk6CiAgICAgICAgYWRhcHRlcl9kZXZpY2VbTk9STUFMSVpFRF9IT1NUTkFNRV9TVFJJTkddID0gZ2V0X2Fzc2V0X25hbWUoYWRhcHRlcl9kZXZpY2UpCiAgICAgICAgYWRhcHRlcl9kZXZpY2VbTk9STUFMSVpFRF9IT1NUTkFNRV0gPSBbZ2V0X2Fzc2V0X25hbWUoYWRhcHRlcl9kZXZpY2UpXQogICAgaWYgYWRhcHRlcl9kYXRhLmdldChPU19GSUVMRCkgaXMgbm90IE5vbmUgYW5kIGFkYXB0ZXJfZGF0YS5nZXQoT1NfRklFTEQsIHt9KS5nZXQoJ3R5cGUnKToKICAgICAgICBhZGFwdGVyX2RhdGFbT1NfRklFTERdWyd0eXBlJ10gPSBhZGFwdGVyX2RhdGFbT1NfRklFTERdWyd0eXBlJ10udXBwZXIoKQogICAgcmV0dXJuIGFkYXB0ZXJfZGV2aWNlCgoKZGVmIGludmVyc2VfZnVuY3Rpb24oeDogRnVuY3Rpb25UeXBlKSAtPiBGdW5jdGlvblR5cGU6CiAgICAiIiIKICAgIFJldHVybnMgdGhlIGludmVyc2Ugb2YgYSBib29sZWFuIGZ1bmN0aW9uCiAgICAiIiIKCiAgICBkZWYgdG1wKCphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgcmV0dXJuIG5vdCB4KCphcmdzLCAqKmt3YXJncykKCiAgICByZXR1cm4gdG1wCgoKZGVmIG9yX2Z1bmN0aW9uKCpmdW5jdGlvbnMpIC0+IEZ1bmN0aW9uVHlwZToKICAgICIiIgogICAgUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgcmVwcmVzZW50cyB0aGUgT1Igb2YgdGhlIHByb3ZpZGVkIGZ1bmN0aW9ucwogICAgIiIiCgogICAgZGVmIHRtcCgqYXJncywgKiprd2FyZ3MpOgogICAgICAgIGZvciBmdW5jIGluIGZ1bmN0aW9uczoKICAgICAgICAgICAgaWYgZnVuYygqYXJncywgKiprd2FyZ3MpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICByZXR1cm4gdG1wCgoKZGVmIGFuZF9mdW5jdGlvbigqZnVuY3Rpb25zKSAtPiBGdW5jdGlvblR5cGU6CiAgICAiIiIKICAgIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHJlcHJlc2VudHMgdGhlIEFORCBvZiB0aGUgcHJvdmlkZWQgZnVuY3Rpb25zCiAgICAiIiIKCiAgICBkZWYgdG1wKCphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgZm9yIGZ1bmMgaW4gZnVuY3Rpb25zOgogICAgICAgICAgICBpZiBub3QgZnVuYygqYXJncywgKiprd2FyZ3MpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICByZXR1cm4gdG1wCgoKZGVmIG1ha2VfZGljdF9mcm9tX2Nzdihjc3ZfZGF0YSkgLT4gY3N2LkRpY3RSZWFkZXI6CiAgICByZXR1cm4gY3N2LkRpY3RSZWFkZXIoY3N2X2RhdGEuc3BsaXRsaW5lcygpLCBkaWFsZWN0PWNzdi5TbmlmZmVyKCkuc25pZmYoY3N2X2RhdGEuc3BsaXRsaW5lcygpWzBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGltaXRlcnM9Wyc7JywgJywnLCAnXHQnXSkpCgoKZGVmIHJlbW92ZV9kdXBsaWNhdGVzX2J5X3JlZmVyZW5jZShzZXEpOgogICAgIiIiCiAgICAgb3JkZXIgcHJlc2VydmluZyBkdXBsaWNhdGUgcmVmZXJlbmNlIHJlbW92aW5nCiAgICAgYmVuY2htYXJrOiAxLjkxIG1zIMKxIDI4LjggwrVzIGZvciAyMGsgdmFsdWVzIG9uIGk3IDc3MDBIUQogICAgICIiIgogICAgc2VlbiA9IHt9CiAgICByZXN1bHQgPSBbXQogICAgZm9yIGl0ZW0gaW4gc2VxOgogICAgICAgIG1hcmtlciA9IGlkKGl0ZW0pCiAgICAgICAgaWYgbWFya2VyIGluIHNlZW46CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgc2VlblttYXJrZXJdID0gMQogICAgICAgIHJlc3VsdC5hcHBlbmQoaXRlbSkKICAgIHJldHVybiByZXN1bHQKCgpkZWYgaW50X3RvX21hYyhtYWNpbnQpOgogICAgaWYgdHlwZShtYWNpbnQpICE9IGludDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdpbnZhbGlkIGludGVnZXInKQogICAgcmV0dXJuICc6Jy5qb2luKFsne317fScuZm9ybWF0KGEsIGIpIGZvciBhLCBiIGluIHppcCgqW2l0ZXIoJ3s6MDEyeH0nLmZvcm1hdChtYWNpbnQpKV0gKiAyKV0pCgoKZGVmIHJlbW92ZV9sYXJnZV9pbnRzKGRhdGEsIG5hbWU6IHN0cik6CiAgICAiIiIKICAgIEdvIG92ZXIgYSBkaWN0IGFuZCByZW1vdmUgYW55IG51bWJlciB3aGljaCBpcyBsYXJnZXIgdGhhbiA4IGJ5dGVzLCBzaW5jZSBNb25nb0RCIGNhbid0IGVhdCBpdC4KICAgIDpwYXJhbSBkYXRhOiB0aGUKICAgICIiIgogICAgaWYgaXNpbnN0YW5jZShkYXRhLCBpbnQpIGFuZCBkYXRhID4gQlNPTl9TUEVDX01BWF9JTlQ6CiAgICAgICAgbG9nZ2VyLndhcm5pbmcoZidXYXJuaW5nISByZW1vdmluZyB7bmFtZX0gd2l0aCB2YWx1ZSB7ZGF0YX0gJwogICAgICAgICAgICAgICAgICAgICAgIGYnc2luY2UgaXRzIGxhcmdlciB0aGFuIDggYnl0ZXMhJykKICAgICAgICByZXR1cm4gVE9fUkVNT1ZFX1ZBTFVFCgogICAgaWYgaXNpbnN0YW5jZShkYXRhLCBkaWN0KToKICAgICAgICBuZXdfZGljdCA9IGRpY3QoKQogICAgICAgIGZvciBrZXksIHZhbHVlIGluIGRhdGEuaXRlbXMoKToKICAgICAgICAgICAgbmV3X3ZhbHVlID0gcmVtb3ZlX2xhcmdlX2ludHModmFsdWUsIGYne25hbWV9X3trZXl9JykKICAgICAgICAgICAgaWYgbmV3X3ZhbHVlIGlzIG5vdCBUT19SRU1PVkVfVkFMVUU6CiAgICAgICAgICAgICAgICBuZXdfZGljdFtrZXldID0gbmV3X3ZhbHVlCgogICAgICAgIHJldHVybiBuZXdfZGljdAoKICAgIGlmIGlzaW5zdGFuY2UoZGF0YSwgbGlzdCk6CiAgICAgICAgbmV3X2xpc3QgPSBbXQogICAgICAgIGZvciBpLCB2YWx1ZSBpbiBlbnVtZXJhdGUoZGF0YSk6CiAgICAgICAgICAgIG5ld192YWx1ZSA9IHJlbW92ZV9sYXJnZV9pbnRzKHZhbHVlLCBmJ3tuYW1lfV97aX0nKQogICAgICAgICAgICBpZiBuZXdfdmFsdWUgaXMgbm90IFRPX1JFTU9WRV9WQUxVRToKICAgICAgICAgICAgICAgIG5ld19saXN0LmFwcGVuZChuZXdfdmFsdWUpCgogICAgICAgIHJldHVybiBuZXdfbGlzdAoKICAgIHJldHVybiBkYXRhCgoKZGVmIHJlcGxhY2VfbGFyZ2VfaW50cyhkYXRhKToKICAgICIiIgogICAgR28gb3ZlciBhIGRpY3QgYW5kIHJlcGxhY2UgYW55IG51bWJlciB3aGljaCBpcyBsYXJnZXIgdGhhbiA4IGJ5dGVzIHdpdGggc3RyLCBzaW5jZSBNb25nb0RCIGNhbid0IGVhdCBpdC4KICAgIDpwYXJhbSBkYXRhOiB0aGUKICAgICIiIgogICAgaWYgaXNpbnN0YW5jZShkYXRhLCBpbnQpOgogICAgICAgIGlmIGRhdGEgPiBCU09OX1NQRUNfTUFYX0lOVDoKICAgICAgICAgICAgcmV0dXJuIHN0cihkYXRhKQogICAgICAgIHJldHVybiBkYXRhCgogICAgaWYgaXNpbnN0YW5jZShkYXRhLCBkaWN0KToKICAgICAgICBuZXdfZGljdCA9IGRpY3QoKQogICAgICAgIGZvciBrZXksIHZhbHVlIGluIGRhdGEuaXRlbXMoKToKICAgICAgICAgICAgbmV3X3ZhbHVlID0gcmVwbGFjZV9sYXJnZV9pbnRzKHZhbHVlKQogICAgICAgICAgICBuZXdfZGljdFtrZXldID0gbmV3X3ZhbHVlCgogICAgICAgIHJldHVybiBuZXdfZGljdAoKICAgIGlmIGlzaW5zdGFuY2UoZGF0YSwgbGlzdCk6CiAgICAgICAgbmV3X2xpc3QgPSBbXQogICAgICAgIGZvciBpLCB2YWx1ZSBpbiBlbnVtZXJhdGUoZGF0YSk6CiAgICAgICAgICAgIG5ld192YWx1ZSA9IHJlcGxhY2VfbGFyZ2VfaW50cyh2YWx1ZSkKICAgICAgICAgICAgbmV3X2xpc3QuYXBwZW5kKG5ld192YWx1ZSkKCiAgICAgICAgcmV0dXJuIG5ld19saXN0CgogICAgcmV0dXJuIGRhdGEK'
TANIUM_SERVICE_PY_B64 = b'aW1wb3J0IGRhdGV0aW1lCmltcG9ydCBsb2dnaW5nCgpmcm9tIGF4b25pdXMuYWRhcHRlcl9iYXNlIGltcG9ydCBBZGFwdGVyQmFzZSwgQWRhcHRlclByb3BlcnR5CmZyb20gYXhvbml1cy5hZGFwdGVyX2V4Y2VwdGlvbnMgaW1wb3J0IENsaWVudENvbm5lY3Rpb25FeGNlcHRpb24KZnJvbSBheG9uaXVzLmNsaWVudHMucmVzdC5jb25uZWN0aW9uIGltcG9ydCBSRVNUQ29ubmVjdGlvbiwgUkVTVEV4Y2VwdGlvbgpmcm9tIGF4b25pdXMuY2xpZW50cyBpbXBvcnQgdGFuaXVtCmZyb20gYXhvbml1cy5kZXZpY2VzLmRldmljZV9hZGFwdGVyIGltcG9ydCBEZXZpY2VBZGFwdGVyCmZyb20gYXhvbml1cy5maWVsZHMgaW1wb3J0IEZpZWxkLCBMaXN0RmllbGQsIEpzb25TdHJpbmdGb3JtYXQKZnJvbSBheG9uaXVzLnV0aWxzLnBhcnNpbmcgaW1wb3J0IGZvcm1hdF9pcCwgZmlndXJlX291dF9vcwpmcm9tIGF4b25pdXMudXRpbHMuZmlsZXMgaW1wb3J0IGdldF9sb2NhbF9jb25maWdfZmlsZQpmcm9tIHRhbml1bV9kaXNjb3Zlcl9hZGFwdGVyLmNvbnN0cyBpbXBvcnQgTUVUSE9EUwoKZnJvbSB0YW5pdW1fZGlzY292ZXJfYWRhcHRlci5jb25uZWN0aW9uIGltcG9ydCBUYW5pdW1EaXNjb3ZlckNvbm5lY3Rpb24KCmxvZ2dlciA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKGYnYXhvbml1cy57X19uYW1lX199JykKCgpjbGFzcyBUYW5pdW1EaXNjb3ZlckFkYXB0ZXIoQWRhcHRlckJhc2UpOgogICAgIyBweWxpbnQ6IGRpc2FibGU9dG9vLW1hbnktaW5zdGFuY2UtYXR0cmlidXRlcwogICAgY2xhc3MgTXlEZXZpY2VBZGFwdGVyKERldmljZUFkYXB0ZXIpOgogICAgICAgIHNlcnZlcl9uYW1lID0gRmllbGQoZmllbGRfdHlwZT1zdHIsIHRpdGxlPSdUYW5pdW0gU2VydmVyJykKICAgICAgICBzZXJ2ZXJfdmVyc2lvbiA9IEZpZWxkKGZpZWxkX3R5cGU9c3RyLCB0aXRsZT0nVGFuaXVtIFNlcnZlciBWZXJzaW9uJywganNvbl9mb3JtYXQ9SnNvblN0cmluZ0Zvcm1hdC52ZXJzaW9uKQogICAgICAgIG1vZHVsZV92ZXJzaW9uID0gRmllbGQoZmllbGRfdHlwZT1zdHIsIHRpdGxlPSdNb2R1bGUgVmVyc2lvbicsIGpzb25fZm9ybWF0PUpzb25TdHJpbmdGb3JtYXQudmVyc2lvbikKICAgICAgICB0YWdzX2Nsb3VkID0gTGlzdEZpZWxkKGZpZWxkX3R5cGU9c3RyLCB0aXRsZT0nVGFncyBDbG91ZCcpCiAgICAgICAgZGlzY292ZXJfaG9zdG5hbWUgPSBGaWVsZChmaWVsZF90eXBlPXN0ciwgdGl0bGU9J0Rpc2NvdmVyIEhvc3RuYW1lJykKICAgICAgICB0YWdzX2Rpc2NvdmVyID0gTGlzdEZpZWxkKGZpZWxkX3R5cGU9c3RyLCB0aXRsZT0nVGFncyBEaXNjb3ZlcicpCiAgICAgICAgY29tcHV0ZXJfaWQgPSBGaWVsZChmaWVsZF90eXBlPWludCwgdGl0bGU9J0NvbXB1dGVyIElEJykKICAgICAgICBjcmVhdGVkX2F0ID0gRmllbGQoZmllbGRfdHlwZT1kYXRldGltZS5kYXRldGltZSwgdGl0bGU9J0NyZWF0ZWQgQXQnKQogICAgICAgIG9zX3NjYW5uZWQgPSBGaWVsZChmaWVsZF90eXBlPXN0ciwgdGl0bGU9J09TIFNjYW5uZWQnKQogICAgICAgIG9zX2dlbmVyYXRpb24gPSBGaWVsZChmaWVsZF90eXBlPXN0ciwgdGl0bGU9J09TIEdlbmVyYXRpb24nKQogICAgICAgIGlzX2lnbm9yZWQgPSBGaWVsZChmaWVsZF90eXBlPWJvb2wsIHRpdGxlPSdJcyBJZ25vcmVkJykKICAgICAgICBpbnN0YW5jZV9pZCA9IEZpZWxkKGZpZWxkX3R5cGU9c3RyLCB0aXRsZT0nSW5zdGFuY2UgSUQnKQogICAgICAgIGluc3RhbmNlX3N0YXRlID0gRmllbGQoZmllbGRfdHlwZT1zdHIsIHRpdGxlPSdJbnN0YW5jZSBTdGF0ZScpCiAgICAgICAgaW5zdGFuY2VfdHlwZSA9IEZpZWxkKGZpZWxkX3R5cGU9c3RyLCB0aXRsZT0nSW5zdGFuY2UgVHlwZScpCiAgICAgICAgaXNfbWFuYWdlZCA9IEZpZWxkKGZpZWxkX3R5cGU9Ym9vbCwgdGl0bGU9J0lzIE1hbmFnZWQnKQogICAgICAgIGlzX3VubWFuYWdlYWJsZSA9IEZpZWxkKGZpZWxkX3R5cGU9Ym9vbCwgdGl0bGU9J0lzIFVubWFuYWdlYWJsZScpCiAgICAgICAgbGFzdF9kaXNjb3ZlcmVkX2F0ID0gRmllbGQoZmllbGRfdHlwZT1kYXRldGltZS5kYXRldGltZSwgdGl0bGU9J0xhc3QgRGlzY292ZXJlZCBBdCcpCiAgICAgICAgbGFzdF9tYW5hZ2VkX2F0ID0gRmllbGQoZmllbGRfdHlwZT1kYXRldGltZS5kYXRldGltZSwgdGl0bGU9J0xhc3QgTWFuYWdlZCBBdCcpCiAgICAgICAgbGF1bmNoX3RpbWUgPSBGaWVsZChmaWVsZF90eXBlPWRhdGV0aW1lLmRhdGV0aW1lLCB0aXRsZT0nTGF1bmNoIFRpbWUnKQogICAgICAgIGxvY2F0aW9ucyA9IExpc3RGaWVsZChmaWVsZF90eXBlPXN0ciwgdGl0bGU9J0xvY2F0aW9ucycpCiAgICAgICAgbWFjX29yZ2FuaXphdGlvbiA9IEZpZWxkKGZpZWxkX3R5cGU9c3RyLCB0aXRsZT0nTUFDIE9yZ2FuaXphdGlvbicpCiAgICAgICAgbWV0aG9kc191c2VkID0gTGlzdEZpZWxkKHN0ciwgJ01ldGhvZHMgVXNlZCcsIGVudW09TUVUSE9EUykKICAgICAgICBuYXRfaXBhZGRyZXNzID0gRmllbGQoCiAgICAgICAgICAgIGZpZWxkX3R5cGU9c3RyLCB0aXRsZT0nTkFUIElQIEFkZHJlc3MnLCBjb252ZXJ0ZXI9Zm9ybWF0X2lwLCBqc29uX2Zvcm1hdD1Kc29uU3RyaW5nRm9ybWF0LmlwCiAgICAgICAgKQogICAgICAgIG5ldHdvcmtfaWQgPSBGaWVsZChmaWVsZF90eXBlPXN0ciwgdGl0bGU9J05ldHdvcmsgSUQnKQogICAgICAgIG93bmVyX2lkID0gRmllbGQoZmllbGRfdHlwZT1zdHIsIHRpdGxlPSdPd25lciBJRCcpCiAgICAgICAgcHJvZmlsZSA9IEZpZWxkKGZpZWxkX3R5cGU9c3RyLCB0aXRsZT0nUHJvZmlsZScpCiAgICAgICAgcHJvdmlkZXIgPSBGaWVsZChmaWVsZF90eXBlPXN0ciwgdGl0bGU9J1Byb3ZpZGVyJykKICAgICAgICB1cGRhdGVkX2F0ID0gRmllbGQoZmllbGRfdHlwZT1kYXRldGltZS5kYXRldGltZSwgdGl0bGU9J1VwZGF0ZWQgQXQnKQogICAgICAgIHpvbmUgPSBGaWVsZChmaWVsZF90eXBlPXN0ciwgdGl0bGU9J1pvbmUnKQoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oY29uZmlnX2ZpbGVfcGF0aD1nZXRfbG9jYWxfY29uZmlnX2ZpbGUoX19maWxlX18pLCAqYXJncywgKiprd2FyZ3MpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9nZXRfY2xpZW50X2lkKGNsaWVudF9jb25maWcpOgogICAgICAgICMgYWRkIGFsbCBvZiB0aGUgZWxlbWVudHMgb2YgdGhlIGNueCB0byB0aGUgY2xpZW50IGlkIHRvIGVuc3VyZSB1bmlxdWVuZXNzCiAgICAgICAgcmV0dXJuIGNsaWVudF9jb25maWdbJ2RvbWFpbiddICsgJ18nICsgY2xpZW50X2NvbmZpZ1sndXNlcm5hbWUnXQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfdGVzdF9yZWFjaGFiaWxpdHkoY2xpZW50X2NvbmZpZyk6CiAgICAgICAgcmV0dXJuIFJFU1RDb25uZWN0aW9uLnRlc3RfcmVhY2hhYmlsaXR5KAogICAgICAgICAgICBjbGllbnRfY29uZmlnLmdldCgnZG9tYWluJyksIGh0dHBzX3Byb3h5PWNsaWVudF9jb25maWcuZ2V0KCdodHRwc19wcm94eScpCiAgICAgICAgKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRfY29ubmVjdGlvbihjbGllbnRfY29uZmlnKToKICAgICAgICBjb25uZWN0aW9uID0gVGFuaXVtRGlzY292ZXJDb25uZWN0aW9uKAogICAgICAgICAgICBkb21haW49Y2xpZW50X2NvbmZpZ1snZG9tYWluJ10sCiAgICAgICAgICAgIHZlcmlmeV9zc2w9Y2xpZW50X2NvbmZpZ1sndmVyaWZ5X3NzbCddLAogICAgICAgICAgICB1c2VybmFtZT1jbGllbnRfY29uZmlnWyd1c2VybmFtZSddLAogICAgICAgICAgICBwYXNzd29yZD1jbGllbnRfY29uZmlnWydwYXNzd29yZCddLAogICAgICAgICAgICBodHRwc19wcm94eT1jbGllbnRfY29uZmlnLmdldCgnaHR0cHNfcHJveHknKSwKICAgICAgICApCiAgICAgICAgd2l0aCBjb25uZWN0aW9uOgogICAgICAgICAgICBjb25uZWN0aW9uLmFkdmFuY2VkX2Nvbm5lY3QoY2xpZW50X2NvbmZpZz1jbGllbnRfY29uZmlnKQogICAgICAgIHJldHVybiBjb25uZWN0aW9uCgogICAgZGVmIF9jb25uZWN0X2NsaWVudChzZWxmLCBjbGllbnRfY29uZmlnKToKICAgICAgICBkb21haW4gPSBjbGllbnRfY29uZmlnLmdldCgnZG9tYWluJykKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJldHVybiBzZWxmLmdldF9jb25uZWN0aW9uKGNsaWVudF9jb25maWcpLCBjbGllbnRfY29uZmlnCiAgICAgICAgZXhjZXB0IFJFU1RFeGNlcHRpb24gYXMgZXhjOgogICAgICAgICAgICBtc2cgPSBmJ0Vycm9yIGNvbm5lY3RpbmcgdG8gY2xpZW50IGF0IHtkb21haW4hcn0sIHJlYXNvbjoge2V4Y30nCiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24obXNnKQogICAgICAgICAgICByYWlzZSBDbGllbnRDb25uZWN0aW9uRXhjZXB0aW9uKG1zZykKCiAgICBkZWYgX3F1ZXJ5X2RldmljZXNfYnlfY2xpZW50KHNlbGYsIGNsaWVudF9uYW1lLCBjbGllbnRfZGF0YSk6CiAgICAgICAgY29ubmVjdGlvbiwgY2xpZW50X2NvbmZpZyA9IGNsaWVudF9kYXRhCiAgICAgICAgd2l0aCBjb25uZWN0aW9uOgogICAgICAgICAgICB5aWVsZCBmcm9tIGNvbm5lY3Rpb24uZ2V0X2RldmljZV9saXN0KGNsaWVudF9uYW1lPWNsaWVudF9uYW1lLCBjbGllbnRfY29uZmlnPWNsaWVudF9jb25maWcpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9hZGRfbmljKGRldmljZSwgZGV2aWNlX3Jhdywga2V5LCBhdHRyKToKICAgICAgICBpcHMgPSBkZXZpY2VfcmF3LmdldCgnaXBhZGRyZXNzJykKICAgICAgICBtYWMgPSBkZXZpY2VfcmF3LmdldCgnbWFjYWRkcmVzcycpCiAgICAgICAgcGlwcyA9IHRhbml1bS50b29scy5saXN0aWZ5KHRhbml1bS50b29scy5wYXJzZV9pcChpcHMpLCBjbGVhbj1UcnVlKQogICAgICAgIHBtYWMgPSB0YW5pdW0udG9vbHMucGFyc2VfbWFjKG1hYykKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBwaXBzOgogICAgICAgICAgICAgICAgZGV2aWNlLmFkZF9uaWMobWFjPXBtYWMsIGlwcz1waXBzKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZidQcm9ibGVtIGluIGFkZF9uaWMgaXBzIHtpcHMhcn0gbWFjIHttYWMhcn0gaW4ge2RldmljZV9yYXchcn0nKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfYWRkX2FkYXB0ZXJfdGFncyhkZXZpY2UsIGRldmljZV9yYXcsIGtleSwgYXR0cik6CiAgICAgICAgdmFsdWVzID0gZGV2aWNlX3Jhdy5nZXQoa2V5KQogICAgICAgIHB2YWx1ZXMgPSB0YW5pdW0udG9vbHMucGFyc2VfY3N2KHZhbHVlcykKCiAgICAgICAgZm9yIHZhbHVlIGluIHB2YWx1ZXM6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGRldmljZS5hZGRfa2V5X3ZhbHVlX3RhZyhrZXk9dmFsdWUsIHZhbHVlPU5vbmUpCgogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ1Byb2JsZW0gYWRkaW5nIGFkYXB0ZXIgdGFnIHt2YWx1ZSFyfSBpbiB7ZGV2aWNlX3JhdyFyfScpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9hZGRfb3Blbl9wb3J0cyhkZXZpY2UsIGRldmljZV9yYXcsIGtleSwgYXR0cik6CiAgICAgICAgdmFsdWVzID0gZGV2aWNlX3Jhdy5nZXQoa2V5KQogICAgICAgIHB2YWx1ZXMgPSB0YW5pdW0udG9vbHMucGFyc2VfY3N2KHZhbHVlcykKCiAgICAgICAgZm9yIHZhbHVlIGluIHB2YWx1ZXM6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGRldmljZS5hZGRfb3Blbl9wb3J0KHBvcnRfaWQ9dmFsdWUpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGYnUHJvYmxlbSBhZGRpbmcgb3BlbiBwb3J0IHt2YWx1ZSFyfSBpbiB7ZGV2aWNlX3JhdyFyfScpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9maWd1cmVfb3MoZGV2aWNlLCBkZXZpY2VfcmF3LCBrZXksIGF0dHIpOgogICAgICAgIHZhbHVlID0gZGV2aWNlX3Jhdy5nZXQoa2V5KQogICAgICAgIG9zX3R5cGUgPSBmaWd1cmVfb3V0X29zKHZhbHVlKS5nZXQoJ3R5cGUnKSAgIyBMaW51eAogICAgICAgIHRhZ3MgPSB0YW5pdW0udG9vbHMucGFyc2VfY3N2KGRldmljZV9yYXcuZ2V0KCd0YWdzJykpCiAgICAgICAgb3NfdGFncyA9IHRhbml1bS50b29scy5wYXJzZV9lbXB0eShbZmlndXJlX291dF9vcyh4KS5nZXQoJ3R5cGUnKSBmb3IgeCBpbiB0YWdzXSkgICMgV2luZG93cywgTGludXgKCiAgICAgICAgb3NfY2hhbmdlcyA9IFtvc190eXBlXQoKICAgICAgICBmb3Igb3NfdGFnIGluIG9zX3RhZ3M6CiAgICAgICAgICAgIGlmIG9zX3RhZyBub3QgaW4gb3NfY2hhbmdlczoKICAgICAgICAgICAgICAgIG9zX3R5cGUgPSBvc190YWcKICAgICAgICAgICAgICAgIG9zX2NoYW5nZXMuYXBwZW5kKG9zX3RhZykKCiAgICAgICAgaWYgb3NfdHlwZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGV2aWNlLmZpZ3VyZV9vcyhvc190eXBlKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ1Byb2JsZW0gaW4gb3NfdHlwZSB7b3NfdHlwZSFyfSB2YWx1ZSB7dmFsdWUhcn0gaW4ge2RldmljZV9yYXchcn0nKQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGV2aWNlLm9zLmlzX3dpbmRvd3Nfc2VydmVyID0gTm9uZQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ1Byb2JsZW0gd2lwaW5nIG91dCBpc193aW5kb3dzX3NlcnZlciBpbiB7ZGV2aWNlX3JhdyFyfScpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9zZXRfbWV0aG9kcyhkZXZpY2UsIGRldmljZV9yYXcsIGtleSwgYXR0cik6CiAgICAgICAgdmFsdWUgPSBkZXZpY2VfcmF3LmdldChrZXkpCiAgICAgICAgbWV0aG9kcyA9IHRhbml1bS50b29scy5wYXJzZV9jc3YodmFsdWUpCgogICAgICAgIHRyeToKICAgICAgICAgICAgbWV0aG9kc191c2VkID0gZGljdCh6aXAoTUVUSE9EUywgbWV0aG9kcykpCiAgICAgICAgICAgIGZvciBtZXRob2QsIGVuYWJsZWQgaW4gbWV0aG9kc191c2VkLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBpZiBzdHIoZW5hYmxlZCkuc3RyaXAoKSA9PSAnMSc6CiAgICAgICAgICAgICAgICAgICAgZGV2aWNlLm1ldGhvZHNfdXNlZC5hcHBlbmQobWV0aG9kKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZidQcm9ibGVtIGluIF9zZXRfbWV0aG9kcyB7dmFsdWUhcn0gaW4ge2RldmljZV9yYXchcn0nKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIF9hdHRyX21hcChzZWxmKToKICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAjIGRldmljZV9yYXcga2V5LCBkZXZpY2UgYXR0ciwgLCBzZXQgbWV0aG9kCiAgICAgICAgICAgICgnY2xvdWRUYWdzJywgJ3RhZ3NfY2xvdWQnLCB0YW5pdW0udG9vbHMuc2V0X2NzdiksCiAgICAgICAgICAgICgnY2xvdWRUYWdzJywgTm9uZSwgc2VsZi5fYWRkX2FkYXB0ZXJfdGFncyksCiAgICAgICAgICAgICgnY29tcHV0ZXJpZCcsICdjb21wdXRlcl9pZCcsIHRhbml1bS50b29scy5zZXRfc3RyKSwKICAgICAgICAgICAgKCdjb21wdXRlcmlkJywgJ3V1aWQnLCB0YW5pdW0udG9vbHMuc2V0X3N0ciksCiAgICAgICAgICAgICgnY3JlYXRlZEF0JywgJ2NyZWF0ZWRfYXQnLCB0YW5pdW0udG9vbHMuc2V0X2R0KSwKICAgICAgICAgICAgKCdjcmVhdGVkQXQnLCAnZmlyc3Rfc2VlbicsIHRhbml1bS50b29scy5zZXRfZHQpLAogICAgICAgICAgICAoJ2hvc3RuYW1lJywgJ2Rpc2NvdmVyX2hvc3RuYW1lJywgdGFuaXVtLnRvb2xzLnNldF9zdHIpLAogICAgICAgICAgICAoJ2lnbm9yZWQnLCAnaXNfaWdub3JlZCcsIHRhbml1bS50b29scy5zZXRfYm9vbCksCiAgICAgICAgICAgICgnaW5zdGFuY2VJZCcsICdpbnN0YW5jZV9pZCcsIHRhbml1bS50b29scy5zZXRfc3RyKSwKICAgICAgICAgICAgKCdpbnN0YW5jZVN0YXRlJywgJ2luc3RhbmNlX3N0YXRlJywgdGFuaXVtLnRvb2xzLnNldF9zdHIpLAogICAgICAgICAgICAoJ2luc3RhbmNlVHlwZScsICdpbnN0YW5jZV90eXBlJywgdGFuaXVtLnRvb2xzLnNldF9zdHIpLAogICAgICAgICAgICAoJ2lwYWRkcmVzcycsIE5vbmUsIHNlbGYuX2FkZF9uaWMpLAogICAgICAgICAgICAoJ2lzbWFuYWdlZCcsICdpc19tYW5hZ2VkJywgdGFuaXVtLnRvb2xzLnNldF9ib29sKSwKICAgICAgICAgICAgKCdsYXN0RGlzY292ZXJlZEF0JywgJ2xhc3RfZGlzY292ZXJlZF9hdCcsIHRhbml1bS50b29scy5zZXRfZHQpLAogICAgICAgICAgICAoJ2xhc3REaXNjb3ZlcmVkQXQnLCAnbGFzdF9zZWVuJywgdGFuaXVtLnRvb2xzLnNldF9kdCksCiAgICAgICAgICAgICgnbGFzdE1hbmFnZWRBdCcsICdsYXN0X21hbmFnZWRfYXQnLCB0YW5pdW0udG9vbHMuc2V0X2R0KSwKICAgICAgICAgICAgKCdsYXVuY2hUaW1lJywgJ2xhdW5jaF90aW1lJywgdGFuaXVtLnRvb2xzLnNldF9kdCksCiAgICAgICAgICAgICgnbG9jYXRpb25zJywgJ2xvY2F0aW9ucycsIHRhbml1bS50b29scy5zZXRfY3N2KSwKICAgICAgICAgICAgKCdtZXRob2QnLCBOb25lLCBzZWxmLl9zZXRfbWV0aG9kcyksCiAgICAgICAgICAgICgnbWFjb3JnYW5pemF0aW9uJywgJ21hY19vcmdhbml6YXRpb24nLCB0YW5pdW0udG9vbHMuc2V0X3N0ciksCiAgICAgICAgICAgICgnbmF0aXBhZGRyZXNzJywgJ25hdF9pcGFkZHJlc3MnLCB0YW5pdW0udG9vbHMuc2V0X2lwKSwKICAgICAgICAgICAgKCduZXR3b3JrSWQnLCAnbmV0d29ya19pZCcsIHRhbml1bS50b29scy5zZXRfc3RyKSwKICAgICAgICAgICAgKCdvcycsICdvc19zY2FubmVkJywgdGFuaXVtLnRvb2xzLnNldF9zdHIpLAogICAgICAgICAgICAoJ29zJywgTm9uZSwgc2VsZi5fZmlndXJlX29zKSwKICAgICAgICAgICAgKCdvc2dlbmVyYXRpb24nLCAnb3NfZ2VuZXJhdGlvbicsIHRhbml1bS50b29scy5zZXRfc3RyKSwKICAgICAgICAgICAgKCdvd25lcklkJywgJ293bmVyX2lkJywgdGFuaXVtLnRvb2xzLnNldF9zdHIpLAogICAgICAgICAgICAoJ3BvcnRzJywgTm9uZSwgc2VsZi5fYWRkX29wZW5fcG9ydHMpLAogICAgICAgICAgICAoJ3Byb2ZpbGUnLCAncHJvZmlsZScsIHRhbml1bS50b29scy5zZXRfY3N2KSwKICAgICAgICAgICAgKCdwcm92aWRlcicsICdwcm92aWRlcicsIHRhbml1bS50b29scy5zZXRfc3RyKSwKICAgICAgICAgICAgKCd0YWdzJywgJ3RhZ3NfZGlzY292ZXInLCB0YW5pdW0udG9vbHMuc2V0X2NzdiksCiAgICAgICAgICAgICgndGFncycsIE5vbmUsIHNlbGYuX2FkZF9hZGFwdGVyX3RhZ3MpLAogICAgICAgICAgICAoJ3VubWFuYWdlYWJsZScsICdpc191bm1hbmFnZWFibGUnLCB0YW5pdW0udG9vbHMuc2V0X2Jvb2wpLAogICAgICAgICAgICAoJ3VwZGF0ZWRBdCcsICd1cGRhdGVkX2F0JywgdGFuaXVtLnRvb2xzLnNldF9kdCksCiAgICAgICAgICAgICgnem9uZScsICd6b25lJywgdGFuaXVtLnRvb2xzLnNldF9zdHIpLAogICAgICAgIF0KCiAgICBkZWYgX2NyZWF0ZV9kZXZpY2Uoc2VsZiwgZGV2aWNlX3JhdywgbWV0YWRhdGEpOgogICAgICAgIGRldmljZSA9IHNlbGYuX25ld19kZXZpY2VfYWRhcHRlcigpCgogICAgICAgIG1hYyA9IGRldmljZV9yYXcuZ2V0KCdtYWNhZGRyZXNzJykKICAgICAgICBjaWQgPSBzdHIoZGV2aWNlX3Jhdy5nZXQoJ2NvbXB1dGVyaWQnKSkKCiAgICAgICAgaWYgbm90IGFueShbbWFjLCBjaWRdKToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYnQmFkIGRldmljZSB3aXRoIGVtcHR5IG1hYyB7bWFjIXJ9IG9yIGNpZCB7Y2lkIXJ9IGluIHtkZXZpY2VfcmF3fScpCiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIGR2Y19pZCA9ICdfJy5qb2luKFttYWMsIGNpZF0pCgogICAgICAgIGRldmljZS5pZCA9IGR2Y19pZAoKICAgICAgICB0YW5pdW0udG9vbHMuc2V0X21vZHVsZV92ZXIoZGV2aWNlPWRldmljZSwgbWV0YWRhdGE9bWV0YWRhdGEsIG1vZHVsZT0nZGlzY292ZXInKQogICAgICAgIHRhbml1bS50b29scy5zZXRfbWV0YWRhdGEoZGV2aWNlPWRldmljZSwgbWV0YWRhdGE9bWV0YWRhdGEpCgogICAgICAgIGZvciBrZXksIGF0dHIsIG1ldGhvZCBpbiBzZWxmLl9hdHRyX21hcDoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbWV0aG9kKGRldmljZT1kZXZpY2UsIGRldmljZV9yYXc9ZGV2aWNlX3Jhdywga2V5PWtleSwgYXR0cj1hdHRyKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ1Byb2JsZW0gaW4ga2V5IHtrZXkhcn0gYXR0ciB7YXR0ciFyfSBtZXRob2Qge21ldGhvZCFyfSBpbiB7ZGV2aWNlX3JhdyFyfScpCgogICAgICAgIGRldmljZS5zZXRfcmF3KGRldmljZV9yYXcpCiAgICAgICAgcmV0dXJuIGRldmljZQoKICAgIGRlZiBfcGFyc2VfcmF3X2RhdGEoc2VsZiwgZGV2aWNlc19yYXdfZGF0YSk6CiAgICAgICAgZm9yIGRldmljZV9yYXcsIG1ldGFkYXRhIGluIGRldmljZXNfcmF3X2RhdGE6CiAgICAgICAgICAgIGRldmljZSA9IE5vbmUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGV2aWNlID0gc2VsZi5fY3JlYXRlX2RldmljZShkZXZpY2VfcmF3PWRldmljZV9yYXcsIG1ldGFkYXRhPW1ldGFkYXRhKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihmJ1Byb2JsZW0gd2l0aCBwYXJzaW5nIGRldmljZSB7ZGV2aWNlX3Jhd30nKQogICAgICAgICAgICBpZiBkZXZpY2U6CiAgICAgICAgICAgICAgICB5aWVsZCBkZXZpY2UKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX2NsaWVudHNfc2NoZW1hKCk6CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ2l0ZW1zJzogWwogICAgICAgICAgICAgICAgeyduYW1lJzogJ2RvbWFpbicsICd0aXRsZSc6ICdIb3N0bmFtZSBvciBJUCBBZGRyZXNzJywgJ3R5cGUnOiAnc3RyaW5nJ30sCiAgICAgICAgICAgICAgICB7J25hbWUnOiAndXNlcm5hbWUnLCAndGl0bGUnOiAnVXNlciBOYW1lJywgJ3R5cGUnOiAnc3RyaW5nJ30sCiAgICAgICAgICAgICAgICB7J25hbWUnOiAncGFzc3dvcmQnLCAndGl0bGUnOiAnUGFzc3dvcmQnLCAndHlwZSc6ICdzdHJpbmcnLCAnZm9ybWF0JzogJ3Bhc3N3b3JkJ30sCiAgICAgICAgICAgICAgICB7J25hbWUnOiAndmVyaWZ5X3NzbCcsICd0aXRsZSc6ICdWZXJpZnkgU1NMJywgJ3R5cGUnOiAnYm9vbCd9LAogICAgICAgICAgICAgICAgeyduYW1lJzogJ2h0dHBzX3Byb3h5JywgJ3RpdGxlJzogJ0hUVFBTIFByb3h5JywgJ3R5cGUnOiAnc3RyaW5nJ30sCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgICdyZXF1aXJlZCc6IFsnZG9tYWluJywgJ3VzZXJuYW1lJywgJ3Bhc3N3b3JkJywgJ3ZlcmlmeV9zc2wnXSwKICAgICAgICAgICAgJ3R5cGUnOiAnYXJyYXknLAogICAgICAgIH0KCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiBhZGFwdGVyX3Byb3BlcnRpZXMoY2xzKToKICAgICAgICByZXR1cm4gW0FkYXB0ZXJQcm9wZXJ0eS5OZXR3b3JrXQo='

TANIUM_SERVICE_PY_PATH = '/home/ubuntu/cortex/adapters/tanium_discover_adapter/service.py'
PARSING_PY_PATH = '/home/ubuntu/cortex/axonius-libs/src/libs/axonius-py/axonius/utils/parsing.py'


def main():
    print(f'Running Tanium Discover enhancement')

    # 1. Backup original
    try:
        if os.path.exists(TANIUM_SERVICE_PY_PATH + '.bak'):
            os.unlink(TANIUM_SERVICE_PY_PATH + '.bak')
        if os.path.exists(PARSING_PY_PATH + '.bak'):
            os.unlink(PARSING_PY_PATH + '.bak')
        os.rename(TANIUM_SERVICE_PY_PATH, TANIUM_SERVICE_PY_PATH + '.bak')
        os.rename(PARSING_PY_PATH, PARSING_PY_PATH + '.bak')
    except Exception:
        pass

    # 2. write new files
    with open(TANIUM_SERVICE_PY_PATH, 'wb') as f:
        f.write(base64.b64decode(TANIUM_SERVICE_PY_B64))

    with open(PARSING_PY_PATH, 'wb') as f:
        f.write(base64.b64decode(PARSING_PY_B64))

    # 3. Restart adapter + static correlator
    subprocess.check_call('./axonius.sh adapter tanium_discover up --restart --prod',
                          shell=True, cwd='/home/ubuntu/cortex')
    subprocess.check_call('./axonius.sh service static_correlator up --restart --prod',
                          shell=True, cwd='/home/ubuntu/cortex')

    # 4. Check if we have configured tanium discover connections
    try:
        tds = TaniumDiscoverService()
        if not tds.clients():
            print('Done!')
            return 0
    except Exception:
        # Adapter is not up, so no clients in there
        print(f'Done!')
        return

    # 5. Unset tanium discover adapter hostname
    aggregator = AggregatorService()
    # We do have connections. delete the hostname var
    # pylint: disable=protected-access
    devices_db = aggregator._entity_db_map[EntityType.Devices]

    match = {
        'adapters': {
            '$elemMatch': {
                'plugin_name': 'tanium_discover_adapter',
                f'data.hostname': {'$exists': True}
            }
        }
    }

    print(f'Running migration.....')
    i = 0
    # We have to run this loop a couple of times because $unset only unsets the first in an array, and if we have
    # duplicates we need to remove them too
    while devices_db.count(match) > 0:
        i += 1
        devices_db.update_many(
            match,
            {
                '$unset': {f'adapters.$.data.hostname': 1}
            }
        )

        if i == 500:
            # infinite loop protection
            raise ValueError(f'i=500')

    # Call de wet
    print(f'Running DE..')
    sc = StaticCorrelatorService()
    sc.trigger('detect_errors', blocking=False, post_json={
        'should_fix_errors': True
    })

    print(f'Done!')
    return 0


if __name__ == '__main__':
    sys.exit(main())
