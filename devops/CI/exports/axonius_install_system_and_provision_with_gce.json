{
  "variables": {
    "build_name": "test",
    "password": "bringorder",
    "host_password": "Password2",
    "branch": "develop",
    "fork": "axonius",
    "image": "Axonius-operational-export-103"
  },
  "builders": [
    {
      "vm_name": "axonius",
      "type": "vmware-iso",
      "boot_wait": "20s",
      "disk_size": 500000,
      "headless": true,
      "iso_url": "/home/ubuntu/ubuntu-16.04.5-server-amd64.iso",
      "iso_checksum": "ee32c555567dd5407c58a1cfc7e668ab37a99d99",
      "iso_checksum_type": "sha1",
      "ssh_username": "ubuntu",
      "ssh_password": "{{user `password`}}",
      "ssh_timeout": "4h",
      "output_directory": "output-axonius-{{user `build_name` }}-build",
      "guest_os_type": "ubuntu-64",
      "http_directory": "http",
      "tools_upload_flavor": "linux",
      "memory": "32768",
      "cpus": 8,
      "shutdown_command": "echo {{user `password`}} | sudo -S -E shutdown -P now",
      "boot_command": [
        "<enter><f6><esc>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs>",
        "<bs><bs><bs>",
        "auto ",
        "preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg ",
        "debian-installer=en_CA ",
        "locale=en_CA ",
        "hostname=axonius ",
        "fb=false ",
        "debconf/frontend=noninteractive ",
        "keyboard-configuration/modelcode=SKIP ",
        "keyboard-configuration/layout=USA ",
        "keyboard-configuration/variant=USA ",
        "vga=788 ",
        "initrd=/install/initrd.gz ",
        "quiet --- ",
        "<enter>"
      ],
      "vmx_data_post": {
        "ethernet0.connectiontype": "bridged"
      }
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "export HISTFILE=/dev/null"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "mkdir -p /home/ubuntu/cortex/devops/scripts/host_installation"
      ]
    },
    {
      "type": "file",
      "source": "ip_wizard",
      "destination": "/home/ubuntu/cortex/devops/scripts/host_installation/ip_wizard"
    },
    {
      "type": "file",
      "source": "weave-2.6.0",
      "destination": "/home/ubuntu/cortex/devops/scripts/host_installation/weave-2.6.0"
    },
    {
      "type": "shell",
      "script": "init_host.sh",
      "remote_folder": "/home/ubuntu/cortex/devops/scripts/host_installation",
      "execute_command": "echo {{user `password`}} | sudo -S sh -c '{{ .Vars }} {{ .Path }}'"
    },
    {
      "type": "shell",
      "expect_disconnect": true,
      "inline": [
        "reboot"
      ],
      "execute_command": "echo {{user `password`}} | sudo -S sh -c '{{ .Vars }} {{ .Path }}'"
    },
    {
      "type": "file",
      "pause_before": "10s",
      "source": "./axonius_{{user `build_name`}}.py",
      "destination": "/home/ubuntu/axonius_{{user `build_name`}}.py"
    },
    {
      "type": "shell",
      "inline": [
        "python3 ./axonius_{{user `build_name`}}.py --first-time",
        "chown -R ubuntu:ubuntu ./cortex"
      ],
      "execute_command": "echo {{user `password`}} | sudo -S sh -c '{{ .Vars }} {{ .Path }}'"
    },
    {
      "type": "shell",
      "script": "./install_chef_client.sh",
      "execute_command": "echo {{user `password`}} | sudo -S sh -c '{{ .Vars }} {{ .Path }}'"
    },
    {
      "type": "shell",
      "script": "./fetch_chef_secret_and_mark.sh"
    },
    {
      "type": "shell",
      "inline": [
        "rm -f /home/ubuntu/axonius_{{user `build_name`}}.py"
      ]
    },
    {
      "type": "file",
      "source": "setup_crons.py",
      "destination": "/home/ubuntu/cortex/setup_crons.py"
    },
    {
      "type": "file",
      "source": "setup_network.sh",
      "destination": "/home/ubuntu/cortex/setup_network.sh"
    },
    {
      "type": "file",
      "source": "create_swap.py",
      "destination": "/home/ubuntu/cortex/create_swap.py"
    },
    {
      "type": "shell",
      "remote_folder": "/home/ubuntu/cortex",
      "inline": [
        "/home/ubuntu/cortex/venv/bin/python /home/ubuntu/cortex/setup_crons.py",
        "rm -f setup_network.sh setup_crons.py create_swap.py",
        "cat /dev/null > /home/ubuntu/.bash_history"
      ],
      "execute_command": "echo {{user `password`}} | sudo -S sh -c '{{ .Vars }} {{ .Path }}'"
    }
  ],
  "post-processors": [
    [
      {
        "type": "shell-local",
        "inline": [
          "mkdir -p ./output-axonius-{{user `build_name` }}-build/{{user `build_name`}}/updater",
          "mv ./axonius_{{user `build_name`}}.py ./output-axonius-{{user `build_name` }}-build/{{user `build_name`}}/updater/",
          "ovftool ./output-axonius-{{user `build_name` }}-build/*.vmx ./output-axonius-{{user `build_name` }}-build/{{user `build_name`}}/{{user `build_name`}}_export.ova",
          "echo '{{user `host_password`}}' | sudo -S cp -R ./output-axonius-{{user `build_name` }}-build/{{user `build_name`}} /mnt/smb_share/nopassshare/Releases/",
          "echo '{{user `host_password`}}' | sudo -S chmod -R 0777 /mnt/smb_share/nopassshare/Releases/{{user `build_name`}}",
          "/home/ubuntu/.local/bin/aws s3 sync ./output-axonius-{{user `build_name` }}-build/{{user `build_name`}}/updater s3://axonius-releases/{{user `build_name`}}/ --acl public-read"
        ]
      },
      {
        "type": "artifice",
        "files": [
          "./output-axonius-{{user `build_name` }}-build/{{user `build_name`}}/{{user `build_name`}}_export.ova"
        ]
      },
      {
        "type": "amazon-import",
        "access_key": "AKIAJQ6MMS3DA7M5FW3Q",
        "secret_key": "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",
        "region": "us-east-2",
        "s3_bucket_name": "axonius-releases",
        "s3_key_name": "{{user `build_name`}}/{{user `build_name`}}/{{user `build_name`}}_export.ova",
        "license_type": "BYOL",
        "skip_clean": true,
        "ami_name": "Axonius {{user `build_name`}}",
        "tags": {
          "Description": "Axonius Export {{user `build_name`}}."
        }
      },
      {
        "type": "shell-local",
        "inline": ["qemu-img convert -O raw ./output-axonius-{{user `build_name` }}-build/disk.vmdk ./output-axonius-{{user `build_name` }}-build/disk.raw"]
      },
      {
        "type": "artifice",
        "files": [
          "./output-axonius-{{user `build_name` }}-build/disk.raw"
        ]
      },
      {
        "type": "compress",
        "output": "output-axonius-{{user `build_name` }}-build/disk.raw.tar.gz"
      },
      {
        "type": "googlecompute-import",
        "project_id": "axonius-office",
        "account_file": "/home/ubuntu/account.json",
        "bucket": "axonius-releases",
        "image_name": "axonius-{{user `build_name` | sed \"s/_/-/g\" | lower}}",
        "image_description": "axonius-{{user `build_name`}}",
        "image_family": "ubuntu-1604-lts"
      },
      {
        "type": "shell-local",
        "inline": [
          "rm -rf ./output-axonius-{{user `build_name` }}-build"
        ]
      }
    ]
  ]
}
