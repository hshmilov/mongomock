{
  "variables": {
    "host_installation": "../../scripts/host_installation/",
    "build_name": "test",
    "output_file": "axonius_{{user `build_name`}}_installer.py",
    "git_hash_file": "axonius_{{user `build_name`}}_git_hash.txt",
    "password": "bringorder",
    "branch": "develop",
    "fork": "axonius"
  },
  "builders": [
    {
      "type": "googlecompute",
      "source_image_project_id": "ubuntu-os-cloud",
      "source_image_family": "ubuntu-1604-lts",
      "image_name": "installer-generator-{{timestamp}}",
      "zone": "us-east1-b",
      "omit_external_ip": true,
      "disk_size": "500",
      "use_internal_ip": true,
      "project_id": "axonius-office",
      "machine_type": "n1-standard-8",
      "ssh_username": "ubuntu",
      "network": "axonius-office-vpc",
      "subnetwork": "private-subnet",
      "ssh_timeout": "4h"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "export HISTFILE=/dev/null"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "mkdir -p /home/ubuntu/cortex/devops/scripts/host_installation"
      ]
    },
    {
      "type": "file",
      "source": "{{user `host_installation`}}ip_wizard",
      "destination": "/home/ubuntu/cortex/devops/scripts/host_installation/ip_wizard"
    },
    {
      "type": "file",
      "source": "{{user `host_installation`}}weave-2.6.0",
      "destination": "/home/ubuntu/cortex/devops/scripts/host_installation/weave-2.6.0"
    },
    {
      "type": "shell",
      "script": "{{user `host_installation`}}init_host.sh",
      "remote_folder": "/home/ubuntu/cortex/devops/scripts/host_installation",
      "execute_command": "sudo -S sh -c '{{ .Vars }} {{ .Path }}'"
    },
    {
      "type": "shell",
      "expect_disconnect": true,
      "inline": [
        "reboot"
      ],
      "execute_command": "sudo -S sh -c '{{ .Vars }} {{ .Path }}'"
    },
    {
      "type": "shell",
      "pause_before": "10s",
      "script": "./set_axonius_dns_until_boot.sh",
      "execute_command": "sudo -S sh -c '{{ .Vars }} {{ .Path }}'"
    },
    {
      "type": "shell",
      "script": "./axonius_deploy.sh",
      "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} {{ .Path }} {{user `branch`}} {{user `fork`}} {{user `password`}} {{user `build_name`}}"
    },
    {
      "type": "shell",
      "inline": [
        "cd /home/ubuntu/cortex",
        "git log --oneline -1 --format=%H > /home/ubuntu/git_hash.txt"
      ]
    },
    {
      "type": "file",
      "source": "/home/ubuntu/git_hash.txt",
      "direction": "download",
      "destination": "{{user `git_hash_file`}}"
    },
    {
      "type": "file",
      "source": "/home/ubuntu/cortex/axonius_{{user `build_name`}}.py",
      "direction": "download",
      "destination": "{{user `output_file`}}"
    }
  ],
  "post-processors": [
    {
      "type": "artifice",
      "files": [
        "{{user `output_file`}}"
      ],
      "keep_input_artifact": false
    }
  ]
}
